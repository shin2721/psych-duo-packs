#!/usr/bin/env node
/**
 * Generate index.ts for lesson unit directories from filesystem
 *
 * Scans data/lessons/*_units/ for locale JSON files (ja/en/es/fr...),
 * then generates index.ts with correct imports and locale-aware exports.
 *
 * Supports all units: mental, health, money, social, study, work
 *
 * Usage: node scripts/gen-lesson-locale-index.js
 *
 * Output: Overwrites each unit's index.ts
 */

const fs = require('fs');
const path = require('path');

const LESSONS_DIR = path.join(__dirname, '..', 'data', 'lessons');

// Unit config: unitDir -> { prefix, exportName }
const UNITS = {
  mental_units:  { prefix: 'mental_l',  exportName: 'mentalData',  funcName: 'getMentalDataForLocale' },
  health_units:  { prefix: 'health_l',  exportName: 'healthData',  funcName: 'getHealthDataForLocale' },
  money_units:   { prefix: 'money_l',   exportName: 'moneyData',   funcName: 'getMoneyDataForLocale' },
  social_units:  { prefix: 'social_l',  exportName: 'socialData',  funcName: 'getSocialDataForLocale' },
  study_units:   { prefix: 'study_l',   exportName: 'studyData',   funcName: 'getStudyDataForLocale' },
  work_units:    { prefix: 'work_l',    exportName: 'workData',    funcName: 'getWorkDataForLocale' },
};

function generateUnit(unitDir, config) {
  const unitPath = path.join(LESSONS_DIR, unitDir);
  if (!fs.existsSync(unitPath)) return null;

  const files = fs.readdirSync(unitPath).sort();
  const pattern = new RegExp(`^(${config.prefix}\\d+)\\.([a-z]{2})\\.json$`);
  const lessons = new Map();
  const allLocales = new Set();

  for (const file of files) {
    const match = file.match(pattern);
    if (match) {
      const [, lessonName, locale] = match;
      if (!lessons.has(lessonName)) {
        lessons.set(lessonName, new Set());
      }
      lessons.get(lessonName).add(locale);
      allLocales.add(locale);
    }
  }

  const sortedLessons = Array.from(lessons.keys()).sort();
  if (sortedLessons.length === 0) return null;

  // Build imports
  const jaImports = [];
  const localeImports = new Map();
  const sortedLocales = Array.from(allLocales).filter((l) => l !== 'ja').sort((a, b) => {
    const priority = ['en', 'es', 'fr'];
    const ai = priority.indexOf(a);
    const bi = priority.indexOf(b);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return a.localeCompare(b);
  });
  const hasAnyEn = sortedLocales.includes('en');

  for (const locale of sortedLocales) {
    localeImports.set(locale, []);
  }

  for (const lesson of sortedLessons) {
    const locales = lessons.get(lesson);
    const varName = lesson.replace(/\./g, '_');

    if (locales.has('ja')) {
      jaImports.push(`import ${varName}_ja from "./${lesson}.ja.json";`);
    }
    for (const locale of sortedLocales) {
      if (locales.has(locale)) {
        localeImports.get(locale).push(`import ${varName}_${locale} from "./${lesson}.${locale}.json";`);
      }
    }
  }

  // Build export arrays
  const jaSpreadEntries = sortedLessons
    .filter(l => lessons.get(l).has('ja'))
    .map(l => `  ...${l.replace(/\./g, '_')}_ja,`);

  const localeSpreadEntries = new Map();
  for (const locale of sortedLocales) {
    const spreadEntries = sortedLessons
      .filter(l => lessons.get(l).has('ja'))
      .map(l => {
        const varName = l.replace(/\./g, '_');
        const locales = lessons.get(l);
        if (locales.has(locale)) {
          return `  ...${varName}_${locale},`;
        }
        if (locale !== 'en' && locales.has('en')) {
          return `  ...${varName}_en, // fallback to en`;
        }
        return `  ...${varName}_ja, // fallback to ja`;
      });
    localeSpreadEntries.set(locale, spreadEntries);
  }

  // Generate output
  let output = `// AUTO-GENERATED by scripts/gen-lesson-locale-index.js â€” do not edit manually
${jaImports.join('\n')}
`;

  if (sortedLocales.length > 0) {
    output += `
// Locale translations (fallback handled per locale export)
${sortedLocales.flatMap((locale) => localeImports.get(locale)).join('\n')}
`;
  }

  output += `
// Japanese (base) - always available
export const ${config.exportName}_ja = [
${jaSpreadEntries.join('\n')}
];
`;

  for (const locale of sortedLocales) {
    output += `
// ${locale} - uses ${locale} where available, falls back to ${locale === 'en' ? 'ja' : 'en -> ja'}
export const ${config.exportName}_${locale} = [
${localeSpreadEntries.get(locale).join('\n')}
];
`;
  }

  output += `
// Default export (ja for backward compatibility)
export const ${config.exportName} = ${config.exportName}_ja;
`;

  output += `
/**
 * Get ${unitDir.replace('_units', '')} data for specified locale with fallback
 * Fallback order: requested -> en -> ja
 */
export function ${config.funcName}(locale: string): any[] {
  const lang = locale.split('-')[0].toLowerCase();

  if (lang === 'ja') {
    return ${config.exportName}_ja;
  }
`;

  for (const locale of sortedLocales) {
    output += `
  if (lang === '${locale}') {
    return ${config.exportName}_${locale};
  }`;
  }

  if (hasAnyEn) {
    output += `

  return ${config.exportName}_en;
}`;
  } else {
    output += `

  return ${config.exportName}_ja;
}`;
  }
  output += '\n';

  const outputPath = path.join(unitPath, 'index.ts');
  fs.writeFileSync(outputPath, output, 'utf-8');

  return {
    lessons: sortedLessons.length,
    ja: jaImports.length,
    locales: sortedLocales,
    outputPath,
  };
}

function main() {
  console.log('=== gen-lesson-locale-index (all units) ===\n');

  let totalGenerated = 0;

  for (const [unitDir, config] of Object.entries(UNITS)) {
    const result = generateUnit(unitDir, config);
    if (result) {
      console.log(`${unitDir}: ${result.lessons} lessons (ja=${result.ja}, locales=${result.locales.join(',') || '-'})`);
      totalGenerated++;
    } else {
      console.log(`${unitDir}: skipped (no lesson files found)`);
    }
  }

  console.log(`\nGenerated: ${totalGenerated} unit index files`);
  console.log('Done.');
}

main();
