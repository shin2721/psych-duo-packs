#!/usr/bin/env node
/**
 * Generate mental_units/index.ts from filesystem
 *
 * Scans data/lessons/mental_units/ for *.ja.json and *.en.json files,
 * then generates index.ts with correct imports and locale-aware exports.
 *
 * Usage: node scripts/gen-lesson-locale-index.js
 *
 * Output: Overwrites data/lessons/mental_units/index.ts
 */

const fs = require('fs');
const path = require('path');

const MENTAL_UNITS_DIR = path.join(__dirname, '..', 'data', 'lessons', 'mental_units');
const OUTPUT_PATH = path.join(MENTAL_UNITS_DIR, 'index.ts');

function generate() {
  const files = fs.readdirSync(MENTAL_UNITS_DIR).sort();

  // Collect lesson files by lesson name and locale
  // Pattern: mental_lNN.LOCALE.json
  const pattern = /^(mental_l\d+)\.([a-z]{2})\.json$/;
  const lessons = new Map(); // lessonName -> Set of locales

  for (const file of files) {
    const match = file.match(pattern);
    if (match) {
      const [, lessonName, locale] = match;
      if (!lessons.has(lessonName)) {
        lessons.set(lessonName, new Set());
      }
      lessons.get(lessonName).add(locale);
    }
  }

  // Sort lesson names for stable output
  const sortedLessons = Array.from(lessons.keys()).sort();

  // Build imports
  const jaImports = [];
  const enImports = [];

  for (const lesson of sortedLessons) {
    const locales = lessons.get(lesson);
    const varName = lesson.replace(/\./g, '_');

    // ja is always required
    if (locales.has('ja')) {
      jaImports.push(`import ${varName}_ja from "./${lesson}.ja.json";`);
    }

    // en is optional
    if (locales.has('en')) {
      enImports.push(`import ${varName}_en from "./${lesson}.en.json";`);
    }
  }

  // Build export arrays
  const jaSpreadEntries = sortedLessons
    .filter(l => lessons.get(l).has('ja'))
    .map(l => `  ...${l.replace(/\./g, '_')}_ja,`);

  // For English: use en if available, fallback to ja
  const enSpreadEntries = sortedLessons
    .filter(l => lessons.get(l).has('ja'))
    .map(l => {
      const varName = l.replace(/\./g, '_');
      if (lessons.get(l).has('en')) {
        return `  ...${varName}_en,`;
      }
      return `  ...${varName}_ja, // fallback to ja`;
    });

  // Generate output
  const output = `// AUTO-GENERATED by scripts/gen-lesson-locale-index.js â€” do not edit manually
${jaImports.join('\n')}

// English translations (fallback to ja if not available)
${enImports.length > 0 ? enImports.join('\n') : '// (none yet)'}

// Japanese (base) - always available
export const mentalData_ja = [
${jaSpreadEntries.join('\n')}
];

// English - uses en where available, falls back to ja
export const mentalData_en = [
${enSpreadEntries.join('\n')}
];

// Default export (ja for backward compatibility)
export const mentalData = mentalData_ja;

/**
 * Get mental data for specified locale with fallback
 * Fallback order: requested -> en -> ja
 */
export function getMentalDataForLocale(locale: string): any[] {
  const lang = locale.split('-')[0].toLowerCase();

  if (lang === 'en') {
    return mentalData_en;
  }

  // All other languages fall back to ja for now
  return mentalData_ja;
}
`;

  fs.writeFileSync(OUTPUT_PATH, output, 'utf-8');

  // Summary
  console.log('=== gen-lesson-locale-index ===');
  console.log(`Scanned: ${MENTAL_UNITS_DIR}`);
  console.log(`Lessons found: ${sortedLessons.length} (${sortedLessons.join(', ')})`);
  console.log(`Locales: ja=${jaImports.length}, en=${enImports.length}`);
  console.log(`Output: ${OUTPUT_PATH}`);
  console.log('Done.');
}

generate();
