#!/usr/bin/env node
/**
 * Generate index.ts for lesson unit directories from filesystem
 *
 * Scans data/lessons/*_units/ for *.ja.json and *.en.json files,
 * then generates index.ts with correct imports and locale-aware exports.
 *
 * Supports all units: mental, health, money, social, study, work
 *
 * Usage: node scripts/gen-lesson-locale-index.js
 *
 * Output: Overwrites each unit's index.ts
 */

const fs = require('fs');
const path = require('path');

const LESSONS_DIR = path.join(__dirname, '..', 'data', 'lessons');

// Unit config: unitDir -> { prefix, exportName }
const UNITS = {
  mental_units:  { prefix: 'mental_l',  exportName: 'mentalData',  funcName: 'getMentalDataForLocale' },
  health_units:  { prefix: 'health_l',  exportName: 'healthData',  funcName: 'getHealthDataForLocale' },
  money_units:   { prefix: 'money_l',   exportName: 'moneyData',   funcName: 'getMoneyDataForLocale' },
  social_units:  { prefix: 'social_l',  exportName: 'socialData',  funcName: 'getSocialDataForLocale' },
  study_units:   { prefix: 'study_l',   exportName: 'studyData',   funcName: 'getStudyDataForLocale' },
  work_units:    { prefix: 'work_l',    exportName: 'workData',    funcName: 'getWorkDataForLocale' },
};

function generateUnit(unitDir, config) {
  const unitPath = path.join(LESSONS_DIR, unitDir);
  if (!fs.existsSync(unitPath)) return null;

  const files = fs.readdirSync(unitPath).sort();
  const pattern = new RegExp(`^(${config.prefix}\\d+)\\.([a-z]{2})\\.json$`);
  const lessons = new Map();

  for (const file of files) {
    const match = file.match(pattern);
    if (match) {
      const [, lessonName, locale] = match;
      if (!lessons.has(lessonName)) {
        lessons.set(lessonName, new Set());
      }
      lessons.get(lessonName).add(locale);
    }
  }

  const sortedLessons = Array.from(lessons.keys()).sort();
  if (sortedLessons.length === 0) return null;

  // Check if any en files exist
  const hasAnyEn = sortedLessons.some(l => lessons.get(l).has('en'));

  // Build imports
  const jaImports = [];
  const enImports = [];

  for (const lesson of sortedLessons) {
    const locales = lessons.get(lesson);
    const varName = lesson.replace(/\./g, '_');

    if (locales.has('ja')) {
      jaImports.push(`import ${varName}_ja from "./${lesson}.ja.json";`);
    }
    if (locales.has('en')) {
      enImports.push(`import ${varName}_en from "./${lesson}.en.json";`);
    }
  }

  // Build export arrays
  const jaSpreadEntries = sortedLessons
    .filter(l => lessons.get(l).has('ja'))
    .map(l => `  ...${l.replace(/\./g, '_')}_ja,`);

  const enSpreadEntries = sortedLessons
    .filter(l => lessons.get(l).has('ja'))
    .map(l => {
      const varName = l.replace(/\./g, '_');
      if (lessons.get(l).has('en')) {
        return `  ...${varName}_en,`;
      }
      return `  ...${varName}_ja, // fallback to ja`;
    });

  // Generate output
  let output = `// AUTO-GENERATED by scripts/gen-lesson-locale-index.js â€” do not edit manually
${jaImports.join('\n')}
`;

  if (hasAnyEn) {
    output += `
// English translations (fallback to ja if not available)
${enImports.join('\n')}
`;
  }

  output += `
// Japanese (base) - always available
export const ${config.exportName}_ja = [
${jaSpreadEntries.join('\n')}
];
`;

  if (hasAnyEn) {
    output += `
// English - uses en where available, falls back to ja
export const ${config.exportName}_en = [
${enSpreadEntries.join('\n')}
];
`;
  }

  output += `
// Default export (ja for backward compatibility)
export const ${config.exportName} = ${config.exportName}_ja;
`;

  if (hasAnyEn) {
    output += `
/**
 * Get ${unitDir.replace('_units', '')} data for specified locale with fallback
 * Fallback order: requested -> en -> ja
 */
export function ${config.funcName}(locale: string): any[] {
  const lang = locale.split('-')[0].toLowerCase();

  if (lang === 'en') {
    return ${config.exportName}_en;
  }

  // All other languages fall back to ja for now
  return ${config.exportName}_ja;
}
`;
  }

  const outputPath = path.join(unitPath, 'index.ts');
  fs.writeFileSync(outputPath, output, 'utf-8');

  return {
    lessons: sortedLessons.length,
    ja: jaImports.length,
    en: enImports.length,
    outputPath,
  };
}

function main() {
  console.log('=== gen-lesson-locale-index (all units) ===\n');

  let totalGenerated = 0;

  for (const [unitDir, config] of Object.entries(UNITS)) {
    const result = generateUnit(unitDir, config);
    if (result) {
      console.log(`${unitDir}: ${result.lessons} lessons (ja=${result.ja}, en=${result.en})`);
      totalGenerated++;
    } else {
      console.log(`${unitDir}: skipped (no lesson files found)`);
    }
  }

  console.log(`\nGenerated: ${totalGenerated} unit index files`);
  console.log('Done.');
}

main();
