#!/usr/bin/env node

/**
 * Psycle問題自動生成システム - Duolingo風の楽しい心理学問題を大量生成
 * 完全無料（Claude APIなし）- 論文のtitle/abstractのみ使用
 */

import fs from 'fs';
import path from 'path';

// ================== 心理学用語データベース ==================

const PSYCH_TERMS = {
  therapies: [
    { ja: '認知行動療法', en: 'CBT', desc: '考え方と行動を変える' },
    { ja: 'マインドフルネス', en: 'Mindfulness', desc: '今に集中する練習' },
    { ja: '弁証法的行動療法', en: 'DBT', desc: '感情調整スキルを学ぶ' },
    { ja: '対人関係療法', en: 'IPT', desc: '人間関係の改善に焦点' },
    { ja: '曝露療法', en: 'Exposure Therapy', desc: '恐怖に少しずつ慣れる' },
    { ja: 'ACT（アクセプタンス&コミットメント療法）', en: 'ACT (Acceptance and Commitment Therapy)', desc: '価値に沿って行動する' },
    { ja: '精神分析療法', en: 'Psychoanalysis', desc: '無意識を探る' },
    { ja: 'EMDR（眼球運動による脱感作と再処理）', en: 'EMDR (Eye Movement Desensitization and Reprocessing)', desc: 'トラウマ記憶を処理' },
    { ja: '動機づけ面接', en: 'MI', desc: '変化への動機を高める' },
    { ja: '認知再評価', en: 'Cognitive Reappraisal', desc: '見方を変えて考え直す' },
    { ja: '表出抑制', en: 'Expressive Suppression', desc: '感情をガマンして隠す' },
    { ja: '行動活性化', en: 'Behavioral Activation', desc: '楽しい活動を増やす' },
    { ja: 'ソリューション・フォーカスト', en: 'SFBT', desc: '解決に焦点を当てる' },
    { ja: '家族療法', en: 'Family Therapy', desc: '家族システム全体を治療' },
    { ja: '認知処理療法', en: 'CPT', desc: 'PTSD（心的外傷後ストレス障害）の認知パターンを変える' },
  ],
  disorders: [
    { ja: 'うつ病', en: 'Depression', symptom: '気分の落ち込み' },
    { ja: '不安症', en: 'Anxiety', symptom: '過度な心配' },
    { ja: 'PTSD（心的外傷後ストレス障害）', en: 'PTSD (Post-Traumatic Stress Disorder)', symptom: 'トラウマの再体験' },
    { ja: '強迫性障害', en: 'OCD', symptom: '強迫観念と強迫行為' },
    { ja: 'パニック障害', en: 'Panic Disorder', symptom: '突然の恐怖発作' },
    { ja: '社交不安症', en: 'Social Anxiety', symptom: '人前での強い緊張' },
    { ja: '摂食障害', en: 'Eating Disorder', symptom: '食行動の異常' },
    { ja: 'バーンアウト', en: 'Burnout', symptom: '燃え尽き症候群' },
    { ja: '双極性障害', en: 'Bipolar', symptom: '気分の極端な変動' },
    { ja: '境界性パーソナリティ障害', en: 'BPD', symptom: '感情の不安定さ' },
    { ja: '統合失調症', en: 'Schizophrenia', symptom: '現実認識の障害' },
    { ja: 'ADHD', en: 'ADHD', symptom: '注意散漫・多動性' },
    { ja: '睡眠障害', en: 'Sleep Disorder', symptom: '睡眠の質・量の問題' },
    { ja: '物質使用障害', en: 'Substance Use', symptom: '依存・乱用' },
  ],
  concepts: [
    { ja: '感情調整', en: 'Emotion Regulation', effect: '気持ちをうまく扱う' },
    { ja: 'レジリエンス', en: 'Resilience', effect: '困難から立ち直る力' },
    { ja: 'セルフコンパッション', en: 'Self-Compassion', effect: '自分への優しさ' },
    { ja: 'メタ認知', en: 'Metacognition', effect: '考えについて考える' },
    { ja: 'ストレスコーピング', en: 'Coping', effect: 'ストレス対処法' },
    { ja: 'ソーシャルサポート', en: 'Social Support', effect: '周囲からの支え' },
    { ja: 'ワーキングメモリ', en: 'Working Memory', effect: '短期的な記憶保持' },
    { ja: '実行機能', en: 'Executive Function', effect: '計画・制御能力' },
    { ja: 'アタッチメント', en: 'Attachment', effect: '愛着関係' },
    { ja: 'ニューロフィードバック', en: 'Neurofeedback', effect: '脳活動の可視化訓練' },
    { ja: 'エクスポージャー', en: 'Exposure', effect: '恐怖対象への段階的接触' },
    { ja: 'リラクゼーション', en: 'Relaxation', effect: '心身の緊張緩和' },
    { ja: '認知の歪み', en: 'Cognitive Distortion', effect: '偏った考え方のパターン' },
    { ja: 'エモーショナルインテリジェンス', en: 'EQ', effect: '感情理解能力' },
    { ja: 'フロー状態', en: 'Flow', effect: '没頭して集中する状態' },
    { ja: 'バイアス', en: 'Bias', effect: '無意識の偏見' },
    { ja: 'プラシーボ効果', en: 'Placebo', effect: '思い込みによる変化' },
    { ja: '神経可塑性', en: 'Neuroplasticity', effect: '脳の変化する力' },
  ]
};

// ================== リアルな人生の状況データベース ==================

const REAL_LIFE_SITUATIONS = {
  mental: [
    {
      id: 'presentation_anxiety',
      setup: '明日、大事なプレゼンがある。\n50人の前で話すなんて初めて。\n「失敗したらどうしよう...」\n不安で眠れない。',
      emotion: '不安・緊張',
      time_constraint: 'immediate',
      correct_method: '4-7-8呼吸法',
      wrong_methods: ['その場を離れてトイレで休憩', '「大丈夫」と自分に言い聞かせる'],
      concrete_actions: {
        '4-7-8呼吸法': '4-7-8呼吸法をやる\n（4秒吸う → 7秒止める → 8秒吐く × 3回）',
        'その場を離れてトイレで休憩': 'トイレに行って10秒深呼吸',
        '「大丈夫」と自分に言い聞かせる': '「大丈夫、落ち着け」と心の中で繰り返す'
      }
    },
    {
      id: 'boss_criticism',
      setup: '上司に理不尽に怒られた。\n「なんでこんなこともできないんだ！」\n頭に血が上って、言い返しそう...\nでも、我慢するしかない。',
      emotion: '怒り・屈辱',
      time_constraint: 'immediate',
      correct_method: 'タイムアウト（その場を離れる）',
      wrong_methods: ['深呼吸して我慢する', 'すぐに謝る'],
      concrete_actions: {
        'タイムアウト（その場を離れる）': '「トイレに行きます」と言ってその場を離れる\n（10秒深呼吸してクールダウン）',
        '深呼吸して我慢する': 'その場で深呼吸して感情を抑える',
        'すぐに謝る': '「すみませんでした」とすぐ謝る'
      }
    },
    {
      id: 'morning_depression',
      setup: '朝起きるのがつらい。\nアラームが鳴っても、体が重い。\n「また1日が始まる...」\n何もやる気が起きない。',
      emotion: '無気力・憂鬱',
      time_constraint: 'daily',
      correct_method: '行動活性化（小さな目標）',
      wrong_methods: ['もう少し寝る', '気分が良くなるまで待つ'],
      concrete_actions: {
        '行動活性化（小さな目標）': '「5分だけ」と決めて起きる\n（ベッドから出て顔を洗うだけでOK）',
        'もう少し寝る': 'アラームを止めてもう30分寝る',
        '気分が良くなるまで待つ': 'ベッドで横になって気分転換を待つ'
      }
    },
    {
      id: 'panic_attack',
      setup: '電車の中で突然、動悸が激しくなった。\n冷や汗が止まらない。\n「このまま倒れるかも...」\nパニックになりそう。',
      emotion: 'パニック・恐怖',
      time_constraint: 'emergency',
      correct_method: 'グラウンディング（5-4-3-2-1法）',
      wrong_methods: ['すぐに電車を降りる', '目を閉じて気を紛らわす'],
      concrete_actions: {
        'グラウンディング（5-4-3-2-1法）': '目に見えるもの5つ、触れるもの4つ、聞こえる音3つ、匂い2つ、味1つを探す',
        'すぐに電車を降りる': '次の駅で降りて外の空気を吸う',
        '目を閉じて気を紛らわす': '目を閉じて「大丈夫」と唱える'
      }
    },
    {
      id: 'overthinking_night',
      setup: '夜、布団に入ると考えが止まらない。\n「あの時、ああすればよかった...」\n「明日、うまくいくかな...」\n眠れない。',
      emotion: '反芻思考・不安',
      time_constraint: 'daily',
      correct_method: '思考記録（紙に書き出す）',
      wrong_methods: ['スマホを見て気を紛らわす', '無理に寝ようとする'],
      concrete_actions: {
        '思考記録（紙に書き出す）': '紙とペンで考えを3つ書き出す\n（書いたら「明日考える」と決める）',
        'スマホを見て気を紛らわす': 'スマホでSNSやYouTubeを見る',
        '無理に寝ようとする': '「早く寝なきゃ」と焦って目を閉じる'
      }
    },
    {
      id: 'social_rejection',
      setup: '友達にLINEを送ったけど既読無視された。\n「嫌われたのかな...」\n「何か悪いこと言ったかな...」\n不安で何も手につかない。',
      emotion: '拒絶不安',
      time_constraint: 'immediate',
      correct_method: '認知再構成（他の可能性を考える）',
      wrong_methods: ['もう一度メッセージを送る', 'SNSで友達の様子を確認する'],
      concrete_actions: {
        '認知再構成（他の可能性を考える）': '「忙しいだけかも」「忘れてるだけかも」と3つ理由を考える',
        'もう一度メッセージを送る': '「見た？」「大丈夫？」と追加メッセージ',
        'SNSで友達の様子を確認する': 'Instagram/Twitterで友達の投稿をチェック'
      }
    },
    {
      id: 'perfectionism_block',
      setup: '資料を作り始めたけど、完璧にしたくて進まない。\n「もっといい案があるはず...」\n締め切りは明日。\n焦るけど手が動かない。',
      emotion: '完璧主義・不安',
      time_constraint: 'immediate',
      correct_method: '2分ルール（まず2分だけやる）',
      wrong_methods: ['もっとリサーチする', '休憩してインスピレーションを待つ'],
      concrete_actions: {
        '2分ルール（まず2分だけやる）': '「2分だけ」と決めて、今あるアイデアを1つ書く\n（完璧じゃなくてOK）',
        'もっとリサーチする': '「完璧な答え」を探してネットで調べ続ける',
        '休憩してインスピレーションを待つ': 'コーヒーを飲んでアイデアが降りてくるのを待つ'
      }
    },
    {
      id: 'rumination_mistake',
      setup: '今日、会議で間違ったことを言ってしまった。\n「みんな私をどう思ってるんだろう...」\n考えれば考えるほど落ち込む。\n自分が情けない。',
      emotion: '自己批判・後悔',
      time_constraint: 'immediate',
      correct_method: 'セルフコンパッション（自分への優しさ）',
      wrong_methods: ['誰かに謝る', '「次は頑張る」と決意する'],
      concrete_actions: {
        'セルフコンパッション（自分への優しさ）': '「誰でもミスする。私だけじゃない」と手を胸に当てて言う',
        '誰かに謝る': 'すぐに上司や同僚に「さっきは失礼しました」とメッセージ',
        '「次は頑張る」と決意する': '「次は絶対ミスしない！」と強く誓う'
      }
    },
    {
      id: 'burnout_exhaustion',
      setup: '最近、何をやっても楽しくない。\n仕事も、趣味も、何もかも面倒。\n「私、壊れたのかな...」\nただ疲れた。',
      emotion: '燃え尽き・無感動',
      time_constraint: 'chronic',
      correct_method: 'マイクロブレイク（5分休憩）',
      wrong_methods: ['長期休暇を取る', 'もっと頑張る'],
      concrete_actions: {
        'マイクロブレイク（5分休憩）': '今すぐ5分だけ休む\n（外の空気を吸う、水を飲む、伸びをする）',
        '長期休暇を取る': '「来月1週間休もう」と計画を立てる',
        'もっと頑張る': '「気合いで乗り切る」と自分を鼓舞する'
      }
    },
    {
      id: 'comparison_anxiety',
      setup: 'SNSで友達の幸せそうな投稿を見た。\n「私だけ取り残されてる...」\n「なんで私はこうなんだろう...」\n惨めな気持ちになる。',
      emotion: '比較不安・劣等感',
      time_constraint: 'immediate',
      correct_method: 'デジタルデトックス（アプリを閉じる）',
      wrong_methods: ['自分の投稿をする', 'もっと他の人の投稿を見る'],
      concrete_actions: {
        'デジタルデトックス（アプリを閉じる）': 'SNSアプリを今すぐ閉じて、スマホを別の部屋に置く',
        '自分の投稿をする': '自分も楽しそうな写真を投稿する',
        'もっと他の人の投稿を見る': '他の人も幸せそうか確認するためスクロール'
      }
    }
  ],

  work: [
    {
      id: 'deadline_pressure',
      setup: '締め切りまであと3時間。\nまだ半分しか終わってない。\n焦りで手が震える。\n「間に合わない...」',
      emotion: 'プレッシャー・焦燥',
      time_constraint: 'immediate',
      correct_method: 'タスク分解（最優先事項だけ）',
      wrong_methods: ['全部やろうとする', 'パニックになって助けを求める'],
      concrete_actions: {
        'タスク分解（最優先事項だけ）': '「絶対必要なもの」だけリストアップ\n（3つ以内に絞って集中）',
        '全部やろうとする': '完璧を目指して全部やろうとする',
        'パニックになって助けを求める': '上司に「できません」と報告する'
      }
    },
    {
      id: 'meeting_conflict',
      setup: '会議で意見が対立した。\n相手は強気に主張してくる。\n「負けたくない...」\nでも、感情的になりそう。',
      emotion: '対立・防衛的',
      time_constraint: 'immediate',
      correct_method: 'アクティブリスニング（まず聞く）',
      wrong_methods: ['自分の意見を強く主張する', '黙って引き下がる'],
      concrete_actions: {
        'アクティブリスニング（まず聞く）': '「あなたの意見を教えてください」と聞いて、メモを取る',
        '自分の意見を強く主張する': '「いや、それは違います」と反論する',
        '黙って引き下がる': '「わかりました」と言って黙る'
      }
    },
    {
      id: 'email_anxiety',
      setup: '上司からの厳しいメールが来た。\n「こんな仕事じゃダメだ」\n胸が苦しい。\nすぐに返信しなきゃ...',
      emotion: '不安・プレッシャー',
      time_constraint: 'immediate',
      correct_method: 'タイムディレイ（30分待つ）',
      wrong_methods: ['すぐに謝罪メールを送る', '上司に電話する'],
      concrete_actions: {
        'タイムディレイ（30分待つ）': 'タイマーを30分セット\n（その間は返信せず、冷静になってから考える）',
        'すぐに謝罪メールを送る': '「申し訳ございません」と即座に返信',
        '上司に電話する': 'すぐに電話して直接謝る'
      }
    },
    {
      id: 'multitasking_overload',
      setup: 'メール、会議、電話、資料作成...\n全部同時に来る。\nどれから手をつければいいか分からない。\n頭がパンクしそう。',
      emotion: '圧倒・混乱',
      time_constraint: 'immediate',
      correct_method: 'シングルタスク（1つずつ）',
      wrong_methods: ['全部同時にやろうとする', '全部後回しにする'],
      concrete_actions: {
        'シングルタスク（1つずつ）': '「今から10分はメールだけ」と決めて、他は見ない',
        '全部同時にやろうとする': 'メール見ながら電話しながら資料作成',
        '全部後回しにする': '「後でまとめてやる」と全部放置'
      }
    },
    {
      id: 'imposter_syndrome',
      setup: '新しいプロジェクトのリーダーに選ばれた。\n「私にできるわけない...」\n「すぐにバレる...」\n自信がない。',
      emotion: 'インポスター症候群',
      time_constraint: 'daily',
      correct_method: '成功日記（小さな成果を記録）',
      wrong_methods: ['断る', '「頑張ります」と言って我慢'],
      concrete_actions: {
        '成功日記（小さな成果を記録）': '今日できたこと1つをノートに書く\n（「会議で発言できた」でもOK）',
        '断る': '「私には無理です」と辞退する',
        '「頑張ります」と言って我慢': '不安を隠して「頑張ります！」と答える'
      }
    },
    {
      id: 'monday_blues',
      setup: '日曜の夜。\n明日からまた仕事。\n「行きたくない...」\n憂鬱で眠れない。',
      emotion: 'サザエさん症候群',
      time_constraint: 'daily',
      correct_method: '楽しみ作り（月曜の小さなご褒美）',
      wrong_methods: ['寝る直前まで遊ぶ', '月曜を考えないようにする'],
      concrete_actions: {
        '楽しみ作り（月曜の小さなご褒美）': '月曜の朝に「好きなコーヒーを買う」と決める\n（小さな楽しみを作る）',
        '寝る直前まで遊ぶ': 'YouTubeやゲームで気を紛らわす',
        '月曜を考えないようにする': '「考えない！」と無理に意識から追い出す'
      }
    },
    {
      id: 'micromanagement_stress',
      setup: '上司が細かすぎる。\n「これはこうして」「あれはああして」\n自分で考える余地がない。\nストレスが溜まる。',
      emotion: 'コントロール欠如・フラストレーション',
      time_constraint: 'chronic',
      correct_method: 'アサーティブコミュニケーション',
      wrong_methods: ['我慢する', '反抗する'],
      concrete_actions: {
        'アサーティブコミュニケーション': '「私の意見も聞いていただけますか？」と穏やかに伝える',
        '我慢する': '何も言わずに指示通りにやる',
        '反抗する': '「いちいち指示しないでください」と怒る'
      }
    },
    {
      id: 'presentation_failure',
      setup: 'プレゼンで失敗した。\n質問に答えられなかった。\n「みんなに見られた...」\n恥ずかしくて死にたい。',
      emotion: '恥・自己嫌悪',
      time_constraint: 'immediate',
      correct_method: 'ポストモーテム（学びを抽出）',
      wrong_methods: ['なかったことにする', '何度も思い出して後悔する'],
      concrete_actions: {
        'ポストモーテム（学びを抽出）': '紙に「次はこうする」を3つ書く\n（失敗を学びに変える）',
        'なかったことにする': '「もう考えない！」と無理に忘れる',
        '何度も思い出して後悔する': '何度も思い出して「なんで...」と後悔'
      }
    },
    {
      id: 'workload_unfair',
      setup: '自分だけ仕事が多い気がする。\n他の人は定時で帰ってる。\n「不公平だ...」\n怒りと疲労が溜まる。',
      emotion: '不公平感・怒り',
      time_constraint: 'chronic',
      correct_method: 'データ収集（仕事量を記録）',
      wrong_methods: ['愚痴を言う', '黙って耐える'],
      concrete_actions: {
        'データ収集（仕事量を記録）': '1週間、自分の仕事時間とタスクを記録\n（客観的データで上司に相談）',
        '愚痴を言う': '同僚に「あの人ずるい」と愚痴る',
        '黙って耐える': '「これが私の運命...」と諦める'
      }
    },
    {
      id: 'zoom_fatigue',
      setup: 'オンライン会議が1日5本。\n画面を見続けて目が痛い。\n「もう無理...」\n疲れて集中できない。',
      emotion: 'Zoom疲れ・消耗',
      time_constraint: 'immediate',
      correct_method: '20-20-20ルール',
      wrong_methods: ['会議中にカメラを切る', 'コーヒーを飲んで無理やり集中'],
      concrete_actions: {
        '20-20-20ルール': '20分ごとに20秒、20フィート（6m）先を見る\n（目の疲れをリセット）',
        '会議中にカメラを切る': 'カメラをオフにして横になる',
        'コーヒーを飲んで無理やり集中': 'カフェインで無理やり目を覚ます'
      }
    }
  ],

  study: [
    {
      id: 'exam_anxiety',
      setup: '明日、大事な試験。\n勉強したけど、不安で頭に入らない。\n「もし落ちたら...」\n焦って何も手につかない。',
      emotion: '不安・プレッシャー',
      time_constraint: 'immediate',
      correct_method: 'ポジティブセルフトーク',
      wrong_methods: ['徹夜で詰め込む', '諦めてもう寝る'],
      concrete_actions: {
        'ポジティブセルフトーク': '「今できることはやった。ベストを尽くそう」\nと声に出して言う',
        '徹夜で詰め込む': '朝まで勉強を続ける',
        '諦めてもう寝る': '「どうせダメだ」と諦めて寝る'
      }
    },
    {
      id: 'procrastination_homework',
      setup: 'レポートの締め切りは明後日。\nまだ何も書いてない。\n「明日やろう...」\nでも、不安だけ大きくなる。',
      emotion: '先延ばし・罪悪感',
      time_constraint: 'immediate',
      correct_method: 'ポモドーロテクニック（25分集中）',
      wrong_methods: ['とりあえずSNSを見る', '完璧な計画を立てる'],
      concrete_actions: {
        'ポモドーロテクニック（25分集中）': 'タイマーを25分セット\n（終わったら5分休憩。まず1回だけやる）',
        'とりあえずSNSを見る': '「息抜きに...」とスマホを見る',
        '完璧な計画を立てる': '「どう書くか」を1時間考え続ける'
      }
    },
    {
      id: 'lecture_distraction',
      setup: '授業中、教授の話が頭に入らない。\n気づいたらボーッとしてる。\n「ヤバい、テスト範囲なのに...」\n焦るけど集中できない。',
      emotion: '注意散漫・焦燥',
      time_constraint: 'immediate',
      correct_method: 'アクティブリスニング（メモを取る）',
      wrong_methods: ['録音して後で聞く', '隣の人のノートを後で見せてもらう'],
      concrete_actions: {
        'アクティブリスニング（メモを取る）': '先生の言葉を1文だけ書き写す\n（完璧なノートじゃなくてOK）',
        '録音して後で聞く': 'スマホで録音して「後で聞けばいい」',
        '隣の人のノートを後で見せてもらう': '「後で教えて」と隣に頼む'
      }
    },
    {
      id: 'test_result_disappointment',
      setup: 'テストの結果が返ってきた。\n思ったより悪い。\n「あんなに頑張ったのに...」\nやる気を失った。',
      emotion: '失望・無力感',
      time_constraint: 'immediate',
      correct_method: '成長マインドセット（何を学んだか）',
      wrong_methods: ['自分を責める', '「どうせ無理」と諦める'],
      concrete_actions: {
        '成長マインドセット（何を学んだか）': '「どこが間違ってた？」を3つ書く\n（次に活かす）',
        '自分を責める': '「私はバカだ...」と自分を責め続ける',
        '「どうせ無理」と諦める': '「もう勉強しても無駄」と諦める'
      }
    },
    {
      id: 'group_project_frustration',
      setup: 'グループ課題で誰も動かない。\n私だけやってる気がする。\n「なんで私だけ...」\nイライラする。',
      emotion: 'フラストレーション・孤独',
      time_constraint: 'daily',
      correct_method: '役割分担の明確化',
      wrong_methods: ['全部自分でやる', 'LINEで文句を言う'],
      concrete_actions: {
        '役割分担の明確化': 'グループチャットで「誰が何をいつまでに？」と提案',
        '全部自分でやる': '「もういい、私がやる」と全部引き受ける',
        'LINEで文句を言う': '「誰も手伝ってくれない」とメッセージ'
      }
    },
    {
      id: 'reading_comprehension',
      setup: '教科書を読んでるけど、全然頭に入らない。\n同じページを3回読んでる。\n「時間の無駄...」\n焦る。',
      emotion: 'フラストレーション・焦燥',
      time_constraint: 'immediate',
      correct_method: 'SQ3R法（質問を作ってから読む）',
      wrong_methods: ['もっと速く読もうとする', '諦めて動画を見る'],
      concrete_actions: {
        'SQ3R法（質問を作ってから読む）': '見出しを見て「これは何について？」と1つ質問を作る\n（その答えを探しながら読む）',
        'もっと速く読もうとする': '「早く終わらせなきゃ」と急いで読む',
        '諦めて動画を見る': '「YouTube解説の方が楽」と動画を見る'
      }
    },
    {
      id: 'perfectionism_study',
      setup: 'ノートを完璧にまとめようとしてる。\nでも、時間がかかりすぎる。\n「もっときれいに...」\n勉強が進まない。',
      emotion: '完璧主義・不安',
      time_constraint: 'daily',
      correct_method: 'アウトプット優先（テスト練習）',
      wrong_methods: ['もっときれいにまとめる', '参考書を読み直す'],
      concrete_actions: {
        'アウトプット優先（テスト練習）': 'ノートは今のまま。練習問題を1問解く\n（きれいなノート < 実践）',
        'もっときれいにまとめる': '色ペンで装飾してインスタ映えノート作り',
        '参考書を読み直す': '「もっと理解を深めよう」と最初から読む'
      }
    },
    {
      id: 'memorization_struggle',
      setup: '暗記が苦手。\n何度読んでも覚えられない。\n「私の頭が悪いんだ...」\n落ち込む。',
      emotion: '無力感・自己批判',
      time_constraint: 'daily',
      correct_method: '分散学習（間隔を空けて復習）',
      wrong_methods: ['一気に覚えようとする', '書いて覚える（ただ書くだけ）'],
      concrete_actions: {
        '分散学習（間隔を空けて復習）': '今日覚えたことを明日、3日後、1週間後に見直す\n（アラームをセット）',
        '一気に覚えようとする': '今日中に全部覚えようと繰り返す',
        '書いて覚える（ただ書くだけ）': '何度も書き写すだけ（考えずに）'
      }
    },
    {
      id: 'comparison_grades',
      setup: '友達の成績を聞いた。\n私より全然いい。\n「なんで私だけ...」\n劣等感で勉強する気が失せた。',
      emotion: '劣等感・嫉妬',
      time_constraint: 'immediate',
      correct_method: 'マスタリーゴール（自分との比較）',
      wrong_methods: ['もっと友達の成績を聞く', '「どうせ無理」と諦める'],
      concrete_actions: {
        'マスタリーゴール（自分との比較）': '「先週の自分より1点上げる」と目標設定\n（他人じゃなく、過去の自分と比べる）',
        'もっと友達の成績を聞く': '「他の人は？」とクラス全員の成績を確認',
        '「どうせ無理」と諦める': '「私には才能がない」と勉強をやめる'
      }
    },
    {
      id: 'online_learning_fatigue',
      setup: 'オンライン授業がつらい。\n家だと集中できない。\n「サボってる気分...」\n罪悪感がある。',
      emotion: '罪悪感・無気力',
      time_constraint: 'daily',
      correct_method: '環境設定（学習専用スペース）',
      wrong_methods: ['ベッドで授業を受ける', '「気合いで頑張る」'],
      concrete_actions: {
        '環境設定（学習専用スペース）': '机の上を片付けて「ここは勉強する場所」と決める\n（カフェでもOK）',
        'ベッドで授業を受ける': 'ベッドに寝転がってパソコンを見る',
        '「気合いで頑張る」': '「集中しろ！」と自分に言い聞かせる'
      }
    }
  ],

  health: [
    {
      id: 'exercise_motivation',
      setup: '運動した方がいいのは分かってる。\nでも、やる気が出ない。\n「明日からやろう」を1ヶ月繰り返してる。\n罪悪感だけが残る。',
      emotion: '罪悪感・無気力',
      time_constraint: 'chronic',
      correct_method: '2分ルール',
      wrong_methods: ['完璧な計画を立てる', '気分が乗るまで待つ'],
      concrete_actions: {
        '2分ルール': '「2分だけ」と決めて運動着に着替える\n（それだけでOK。続けたくなったら続ける）',
        '完璧な計画を立てる': '週3回・30分のジムプランを立てる',
        '気分が乗るまで待つ': 'やる気が出る日を待つ'
      }
    },
    {
      id: 'junk_food_craving',
      setup: '夜中にお腹が空いた。\nカップラーメンが食べたい。\n「でも、体に悪いよな...」\n我慢するか、食べるか迷ってる。',
      emotion: '衝動・葛藤',
      time_constraint: 'immediate',
      correct_method: 'サーフィン・ザ・ウェーブ（衝動を観察）',
      wrong_methods: ['我慢してストレス溜める', '食べて後悔する'],
      concrete_actions: {
        'サーフィン・ザ・ウェーブ（衝動を観察）': '「食べたい」気持ちを10秒観察\n（波のように来て去るのを見守る）',
        '我慢してストレス溜める': '「絶対食べない！」と強く我慢',
        '食べて後悔する': '「もういいや」と食べて罪悪感'
      }
    },
    {
      id: 'sleep_procrastination',
      setup: 'もう夜中の2時。\n明日は早起きしなきゃいけない。\nでも、YouTubeが止められない。\n「あと1本だけ...」',
      emotion: '夜更かし癖・自制心の欠如',
      time_constraint: 'immediate',
      correct_method: 'デバイスパワーオフ',
      wrong_methods: ['「あと10分」と決める', '「明日早く寝る」と決意'],
      concrete_actions: {
        'デバイスパワーオフ': '今すぐスマホの電源を切る\n（充電器は別の部屋に）',
        '「あと10分」と決める': '「あと10分だけ」とタイマーをセット',
        '「明日早く寝る」と決意': '「明日こそは！」と決意して今日は諦める'
      }
    },
    {
      id: 'chronic_pain_frustration',
      setup: '肩が痛い。\nずっと痛い。\n整体に行っても治らない。\n「もう治らないのかな...」\n絶望的。',
      emotion: '慢性痛・絶望',
      time_constraint: 'chronic',
      correct_method: 'ペインリフレーミング（痛みとの付き合い方）',
      wrong_methods: ['痛みを無視する', '痛み止めに頼る'],
      concrete_actions: {
        'ペインリフレーミング（痛みとの付き合い方）': '「痛みはあるけど、今日できること1つやる」\n（痛み=敵じゃなく、共存）',
        '痛みを無視する': '「気にしない！」と無理に動く',
        '痛み止めに頼る': '毎日痛み止めを飲む'
      }
    },
    {
      id: 'weight_plateau',
      setup: 'ダイエット始めて1ヶ月。\n最初は減ったけど、もう減らない。\n「努力しても無駄...」\nやめたくなる。',
      emotion: 'フラストレーション・無力感',
      time_constraint: 'chronic',
      correct_method: 'ノンスケールビクトリー（体重以外の成果）',
      wrong_methods: ['もっと食事を減らす', 'もっと運動する'],
      concrete_actions: {
        'ノンスケールビクトリー（体重以外の成果）': '「階段が楽になった」「服が緩くなった」を3つ書く\n（体重以外の変化に目を向ける）',
        'もっと食事を減らす': '1日1食にする',
        'もっと運動する': '毎日1時間走る'
      }
    },
    {
      id: 'smoking_temptation',
      setup: '禁煙して3日目。\nイライラが止まらない。\nコンビニでタバコが目に入った。\n「1本だけなら...」',
      emotion: '渇望・葛藤',
      time_constraint: 'immediate',
      correct_method: '4Dテクニック（遅らせる、深呼吸、飲む、気をそらす）',
      wrong_methods: ['1本だけ吸う', '我慢し続ける'],
      concrete_actions: {
        '4Dテクニック（遅らせる、深呼吸、飲む、気をそらす）': '「10分後に考える」+深呼吸3回+水を飲む+友達に電話',
        '1本だけ吸う': '「1本だけなら大丈夫」と買う',
        '我慢し続ける': '「絶対吸わない！」と必死に我慢'
      }
    },
    {
      id: 'posture_pain',
      setup: '1日中パソコン作業。\n首と腰が痛い。\n「でも、仕事があるし...」\n我慢して続けてる。',
      emotion: '痛み・無視',
      time_constraint: 'immediate',
      correct_method: 'マイクロムーブメント（2分ストレッチ）',
      wrong_methods: ['痛み止めを飲む', '週末にマッサージに行く'],
      concrete_actions: {
        'マイクロムーブメント（2分ストレッチ）': '今すぐ立って首を3回回す+肩を上げ下げ3回\n（2分だけ）',
        '痛み止めを飲む': '「とりあえず」と痛み止めを飲んで続ける',
        '週末にマッサージに行く': '「週末に治そう」と今は我慢'
      }
    },
    {
      id: 'alcohol_dependence',
      setup: '今日も飲んでしまった。\n「ストレス解消に...」が口癖。\nでも、毎日飲むのはヤバい気がする。\n罪悪感がある。',
      emotion: '罪悪感・依存',
      time_constraint: 'chronic',
      correct_method: 'ドライデイ（休肝日を作る）',
      wrong_methods: ['量を減らす', '「まだ大丈夫」と思う'],
      concrete_actions: {
        'ドライデイ（休肝日を作る）': '「月・水・金は飲まない」とカレンダーに印\n（まず週3日）',
        '量を減らす': '「今日は缶ビール1本だけ」と決める',
        '「まだ大丈夫」と思う': '「毎日じゃないし」「仕事してるし」と正当化'
      }
    },
    {
      id: 'hydration_neglect',
      setup: '1日中、水を飲んでない気がする。\n喉が渇いた。\n頭もボーッとする。\n「忙しくて...」',
      emotion: '疲労・脱水',
      time_constraint: 'immediate',
      correct_method: 'ウォーターリマインダー',
      wrong_methods: ['コーヒーで代用', '「後で飲む」'],
      concrete_actions: {
        'ウォーターリマインダー': '今すぐコップ1杯飲む+1時間ごとのアラームをセット',
        'コーヒーで代用': '「喉が渇いたからコーヒー飲もう」',
        '「後で飲む」': '「今忙しいから後で」と放置'
      }
    },
    {
      id: 'stress_eating',
      setup: 'ストレスが溜まると、つい食べてしまう。\n今日も帰りにコンビニで大量買い。\n「明日から控えよう...」\n罪悪感。',
      emotion: 'ストレス・罪悪感',
      time_constraint: 'immediate',
      correct_method: 'HALT法（空腹・怒り・孤独・疲労チェック）',
      wrong_methods: ['食べ物を全部捨てる', '食べた後に運動する'],
      concrete_actions: {
        'HALT法（空腹・怒り・孤独・疲労チェック）': '「本当にお腹空いてる？」「イライラしてる？」「寂しい？」「疲れてる？」を確認\n（本当の原因を見つける）',
        '食べ物を全部捨てる': '「もう買わない！」と全部ゴミ箱へ',
        '食べた後に運動する': '「食べた分、走ろう」と運動で帳消し'
      }
    }
  ],

  social: [
    {
      id: 'party_anxiety',
      setup: '友達に誘われてパーティーに来た。\nでも、知らない人ばかり。\n「何話せばいいんだろう...」\n帰りたい。',
      emotion: '社交不安',
      time_constraint: 'immediate',
      correct_method: '5秒ルール',
      wrong_methods: ['スマホを見て時間を潰す', 'トイレに隠れる'],
      concrete_actions: {
        '5秒ルール': '5秒以内に誰かに話しかける\n（「この料理美味しいですね」でOK）',
        'スマホを見て時間を潰す': 'スマホをいじって誰とも話さない',
        'トイレに隠れる': 'トイレに長時間こもる'
      }
    },
    {
      id: 'conflict_avoidance',
      setup: '友達が約束を破った。\n3回目。\n「言った方がいいかな...」\nでも、嫌われたくない。',
      emotion: '怒り・不安',
      time_constraint: 'daily',
      correct_method: 'アサーティブコミュニケーション（I-メッセージ）',
      wrong_methods: ['我慢する', '怒りをぶつける'],
      concrete_actions: {
        'アサーティブコミュニケーション（I-メッセージ）': '「私は悲しかった」と感情を伝える\n（「あなたが悪い」じゃなく）',
        '我慢する': '「まあいいか」と飲み込む',
        '怒りをぶつける': '「もう信じられない！」とキレる'
      }
    },
    {
      id: 'loneliness',
      setup: '週末、誰からも連絡が来ない。\nSNSで友達は楽しそう。\n「私だけ一人ぼっち...」\n孤独で泣きそう。',
      emotion: '孤独・悲しみ',
      time_constraint: 'immediate',
      correct_method: 'セルフケア+リーチアウト',
      wrong_methods: ['SNSをずっと見る', '部屋に引きこもる'],
      concrete_actions: {
        'セルフケア+リーチアウト': '好きなことを1つやる（映画、本など）\n+誰か1人に「元気？」とメッセージ',
        'SNSをずっと見る': 'インスタやTwitterをひたすらスクロール',
        '部屋に引きこもる': '誰にも会わず、何もせず寝る'
      }
    },
    {
      id: 'gossip_guilt',
      setup: '友達が他の人の悪口を言ってる。\n「そうだね」と同意してしまった。\n後で罪悪感。\n「私、最低だ...」',
      emotion: '罪悪感',
      time_constraint: 'immediate',
      correct_method: '価値確認（自分の価値観を再確認）',
      wrong_methods: ['なかったことにする', 'もっと悪口を言う'],
      concrete_actions: {
        '価値確認（自分の価値観を再確認）': '「次は同意しない」と心に決める\n（「私は陰口を言わない」と価値観を確認）',
        'なかったことにする': '「もう忘れよう」と流す',
        'もっと悪口を言う': '「そういえば...」と話を続ける'
      }
    },
    {
      id: 'boundary_violation',
      setup: '友達がしつこく予定を聞いてくる。\n「今度いつ空いてる？」\n「忙しい」って言ったのに。\n断りづらい。',
      emotion: 'フラストレーション・圧迫感',
      time_constraint: 'immediate',
      correct_method: 'ブロークンレコード（壊れたレコード法）',
      wrong_methods: ['嘘をつく', '仕方なく約束する'],
      concrete_actions: {
        'ブロークンレコード（壊れたレコード法）': '「今は忙しいんだ」を3回繰り返す\n（理由を説明せず、同じ言葉を繰り返す）',
        '嘘をつく': '「家族の用事が...」と嘘の理由を作る',
        '仕方なく約束する': '「じゃあ来週...」と嫌々承諾'
      }
    },
    {
      id: 'jealousy_friendship',
      setup: '親友が他の友達と仲良くしてる。\n私を置いてけぼりにしてる気がする。\n「嫉妬してる自分が嫌...」\nでも、モヤモヤする。',
      emotion: '嫉妬・不安',
      time_constraint: 'immediate',
      correct_method: 'セルフコンパッション+オープンダイアローグ',
      wrong_methods: ['嫉妬を隠す', '親友を責める'],
      concrete_actions: {
        'セルフコンパッション+オープンダイアローグ': '「嫉妬するのは自然」と自分を許す\n+「最近寂しかった」と素直に伝える',
        '嫉妬を隠す': '「全然平気！」と明るく振る舞う',
        '親友を責める': '「私のこと忘れたの？」と責める'
      }
    },
    {
      id: 'people_pleasing',
      setup: 'いつも「いいよ」って言ってしまう。\n本当は嫌なのに。\n「でも、断ったら嫌われる...」\n疲れた。',
      emotion: '疲労・自己嫌悪',
      time_constraint: 'chronic',
      correct_method: 'スモールノー練習',
      wrong_methods: ['全部引き受ける', '急に全部断る'],
      concrete_actions: {
        'スモールノー練習': '小さなことから断る練習\n（「今日は無理だけど、明日なら」）',
        '全部引き受ける': '「私がやる」と全部承諾し続ける',
        '急に全部断る': '「もう無理！」と全部断る'
      }
    },
    {
      id: 'apology_difficulty',
      setup: '友達を傷つけてしまった。\n謝りたいけど、なんて言えばいいか分からない。\n「気まずい...」\n時間だけが過ぎる。',
      emotion: '罪悪感・不安',
      time_constraint: 'immediate',
      correct_method: 'シンプルアポロジー',
      wrong_methods: ['言い訳する', '時間が解決するのを待つ'],
      concrete_actions: {
        'シンプルアポロジー': '「ごめん。傷つけたよね」とシンプルに謝る\n（言い訳なし、説明なし）',
        '言い訳する': '「でも、あの時は...」と言い訳を並べる',
        '時間が解決するのを待つ': '「そのうち忘れるだろう」と放置'
      }
    },
    {
      id: 'social_media_comparison',
      setup: 'SNSで友達のキラキラした投稿を見た。\n「私と違って楽しそう...」\n自分が惨めに感じる。\n見るのをやめられない。',
      emotion: '劣等感・嫉妬',
      time_constraint: 'immediate',
      correct_method: 'デジタルデトックス+グラティチュード',
      wrong_methods: ['もっとスクロールする', '自分も投稿する'],
      concrete_actions: {
        'デジタルデトックス+グラティチュード': 'SNSアプリを閉じて、自分の良かったこと3つを書く',
        'もっとスクロールする': '「他の人はどうかな」とさらに見る',
        '自分も投稿する': '「私も楽しんでる」アピールの投稿'
      }
    },
    {
      id: 'small_talk_struggle',
      setup: 'エレベーターで上司と二人きり。\n沈黙が気まずい。\n「何か話さなきゃ...」\n頭が真っ白。',
      emotion: '社交不安・緊張',
      time_constraint: 'immediate',
      correct_method: 'FORD法（Family, Occupation, Recreation, Dreams）',
      wrong_methods: ['沈黙を耐える', '天気の話'],
      concrete_actions: {
        'FORD法（Family, Occupation, Recreation, Dreams）': '「最近、お忙しいですか？」（Occupation）\nシンプルな質問でOK',
        '沈黙を耐える': 'スマホを見て沈黙を耐える',
        '天気の話': '「今日は暑いですね」（ありきたり）'
      }
    }
  ],

  money: [
    {
      id: 'impulse_buying',
      setup: 'セールで欲しいものを見つけた。\n「今買わないと損する！」\nでも、本当に必要かな...\nポチる寸前。',
      emotion: '衝動・焦燥',
      time_constraint: 'immediate',
      correct_method: '24時間ルール',
      wrong_methods: ['勢いで買う', '誰かに相談する'],
      concrete_actions: {
        '24時間ルール': 'カートに入れて24時間待つ\n（明日も欲しかったら買う）',
        '勢いで買う': '「安いから」と今すぐ買う',
        '誰かに相談する': '友達に「買うべき？」と聞く'
      }
    },
    {
      id: 'debt_anxiety',
      setup: 'クレジットカードの請求額を見た。\n「こんなに使ってた...」\n払えるけど、不安。\n「来月はどうしよう...」',
      emotion: '不安・罪悪感',
      time_constraint: 'immediate',
      correct_method: '支出トラッキング',
      wrong_methods: ['請求書を見ない', '節約を決意する'],
      concrete_actions: {
        '支出トラッキング': '今月の支出を3つのカテゴリーに分ける\n（必需品・嗜好品・衝動買い）',
        '請求書を見ない': '「見たくない」と封筒を放置',
        '節約を決意する': '「来月は絶対使わない！」と決意'
      }
    },
    {
      id: 'savings_procrastination',
      setup: '「貯金しなきゃ」と思ってる。\nでも、毎月使い切ってしまう。\n「来月こそ...」\n1年経った。',
      emotion: '罪悪感・無力感',
      time_constraint: 'chronic',
      correct_method: 'オートセーブ（自動積立）',
      wrong_methods: ['余ったら貯金', '完璧な貯金額を決める'],
      concrete_actions: {
        'オートセーブ（自動積立）': '給料日に自動で5000円だけ別口座へ\n（考えずに貯まる仕組み）',
        '余ったら貯金': '「月末に余ったら貯金しよう」',
        '完璧な貯金額を決める': '「毎月3万円貯金！」と高すぎる目標'
      }
    },
    {
      id: 'subscription_overload',
      setup: 'サブスクが増えすぎた。\nNetflix, Spotify, ジム, アプリ...\n「全部使ってないかも...」\n見直すのが面倒。',
      emotion: '無関心・もったいない',
      time_constraint: 'chronic',
      correct_method: 'サブスク監査',
      wrong_methods: ['放置する', '全部解約する'],
      concrete_actions: {
        'サブスク監査': '今日、紙に全サブスクをリストアップ\n（「3ヶ月使ってない」ものを1つ解約）',
        '放置する': '「まあいいか」と見て見ぬふり',
        '全部解約する': '「もったいない！」と全部解約'
      }
    },
    {
      id: 'peer_pressure_spending',
      setup: '友達が高級レストランに誘ってきた。\n予算オーバー。\nでも、断ったら「ケチ」って思われる？\n迷ってる。',
      emotion: 'プレッシャー・不安',
      time_constraint: 'immediate',
      correct_method: 'アサーティブディクライン',
      wrong_methods: ['無理して行く', '嘘をつく'],
      concrete_actions: {
        'アサーティブディクライン': '「今月は予算厳しいから、別の店どう？」と提案',
        '無理して行く': '「まあいいか」とカードで支払う',
        '嘘をつく': '「予定があって...」と嘘を言う'
      }
    },
    {
      id: 'investment_fomo',
      setup: 'SNSで「この株で儲かった！」投稿を見た。\n「乗り遅れる...」\n投資経験ゼロだけど、やりたい。\n焦ってる。',
      emotion: 'FOMO（取り残される不安）',
      time_constraint: 'immediate',
      correct_method: 'インベストメント教育',
      wrong_methods: ['すぐに買う', '諦める'],
      concrete_actions: {
        'インベストメント教育': '今日は買わない。\nまず1冊投資本を読む\n（知識 → 行動の順）',
        'すぐに買う': '「今しかない！」と全財産投入',
        '諦める': '「私には無理」と何もしない'
      }
    },
    {
      id: 'emotional_spending',
      setup: '仕事でストレスが溜まった。\n「ご褒美に...」とネットショッピング。\n気づいたらカートが満杯。\n「また買ってしまった...」',
      emotion: 'ストレス・罪悪感',
      time_constraint: 'immediate',
      correct_method: 'エモーショナルスペンディング日記',
      wrong_methods: ['買って後悔', '我慢してストレス'],
      concrete_actions: {
        'エモーショナルスペンディング日記': '買う前に「今、何を感じてる？」を紙に書く\n（ストレス？孤独？疲労？）',
        '買って後悔': '「もういいや」とポチって罪悪感',
        '我慢してストレス': '「買わない！」と我慢してイライラ'
      }
    },
    {
      id: 'budget_failure',
      setup: '今月も予算オーバー。\n「ちゃんと計画したのに...」\n予算を守れない自分が情けない。\n「私はダメだ...」',
      emotion: '自己嫌悪・無力感',
      time_constraint: 'immediate',
      correct_method: 'フレキシブルバジェット（柔軟な予算）',
      wrong_methods: ['もっと厳しい予算', '予算をやめる'],
      concrete_actions: {
        'フレキシブルバジェット（柔軟な予算）': '予算の10%を「自由枠」として確保\n（完璧主義をやめる）',
        'もっと厳しい予算': '「来月は絶対守る！」と予算を減らす',
        '予算をやめる': '「もう無理」と予算管理を放棄'
      }
    },
    {
      id: 'income_comparison',
      setup: '同期の給料を聞いた。\n私より多い。\n「なんで私だけ...」\n仕事のモチベーションが下がった。',
      emotion: '劣等感・嫉妬',
      time_constraint: 'immediate',
      correct_method: 'バリューフォーカス（価値に焦点）',
      wrong_methods: ['もっと稼ごうと副業', '諦める'],
      concrete_actions: {
        'バリューフォーカス（価値に焦点）': '「お金以外で今の仕事の良いところ」を3つ書く\n（時間、スキル、人間関係など）',
        'もっと稼ごうと副業': '「追いつかなきゃ」と副業を始める',
        '諦める': '「どうせ私は...」と諦める'
      }
    },
    {
      id: 'financial_guilt',
      setup: '親に仕送りを頼まれた。\n自分の生活も苦しい。\nでも、断れない。\n「親不孝だ...」',
      emotion: '罪悪感・葛藤',
      time_constraint: 'immediate',
      correct_method: 'ファイナンシャルバウンダリー',
      wrong_methods: ['無理して送る', '断って罪悪感'],
      concrete_actions: {
        'ファイナンシャルバウンダリー': '「今月は○円だけなら送れる」と明確に伝える\n（自分を守る境界線）',
        '無理して送る': '「親だから...」と自分の生活を削る',
        '断って罪悪感': '「無理」と断って罪悪感を抱え続ける'
      }
    }
  ]
};

// ================== メソッドの詳細説明データベース ==================

const METHOD_DATABASE = {
  '4-7-8呼吸法': {
    what: "【この方法は】\n4-7-8呼吸法は、不安を1分で和らげる科学的に証明された方法だよ。",
    why: "【なぜ効くの？】\n\n不安を感じると、交感神経が「戦うか逃げるか」モードになる。\n→ 心拍数↑、血圧↑、呼吸が浅くなる\n\nでも、ゆっくり深呼吸すると、副交感神経が「大丈夫」って信号を送る。\n→ 体が「リラックスモード」に切り替わる\n\nこれ、自律神経の仕組みなんだ。\n\n科学的根拠: 副交感神経の活性化により、心拍変動（HRV）が改善される。",
    how: "【やり方】\n\n1. 4秒かけて鼻から息を吸う\n   （お腹を膨らませるイメージ）\n\n2. 7秒息を止める\n   （リラックスして）\n\n3. 8秒かけて口から息を吐く\n   （「ふーっ」と音を立てて）\n\nこれを3回繰り返す。\nたった1分。即効果を実感できるよ。\n\nいつ使う？\n• プレゼン前の緊張\n• 喧嘩しそうな時\n• 眠れない夜\n• パニックになりそうな時",
    real_example: "【みんなの体験談】\n\n「プレゼン前、めちゃくちゃ緊張してたけど、この呼吸法やったら本当に落ち着いた。不思議だけど、効いた！」\n— Yuji（28歳・営業）\n\n「最初は半信半疑だったけど、毎朝やってたら、1日が落ち着いて始められるようになった。習慣にしてよかった。」\n— Mika（24歳・デザイナー）\n\n「子どもがパニックになった時、一緒にやったら落ち着いてくれた。親子で使えるのがいい！」\n— Takeshi（35歳・父親）",
    action: "【今すぐ試そう！】\n\nこの画面を閉じる前に、一緒にやってみよう！\n準備はいい？\n\nじゃあ、始めるよ...\n\n[4秒] 鼻から息を吸って... すーーーっ\n[7秒] 息を止めて... 1、2、3...\n[8秒] 口から息を吐いて... ふーーーーっ\n\nもう1回！\n\n[4秒] 吸って...\n[7秒] 止めて...\n[8秒] 吐いて...\n\nどう？少し落ち着いた？\n\nこれを習慣にすると、人生変わるよ。\n明日の朝、起きたらまずこれをやってみて。"
  },

  'タイムアウト（その場を離れる）': {
    what: "【この方法は】\nタイムアウトは、怒りが爆発する前に「戦場」から離れるテクニック。",
    why: "【なぜ効くの？】\n\n怒りは「扁桃体ハイジャック」って呼ばれる現象。\n扁桃体（脳の感情センター）が暴走すると、理性が効かなくなる。\n\nでも、物理的に離れると：\n→ 扁桃体が冷静になる時間ができる\n→ 前頭前野（理性の脳）が復活する\n\n科学的根拠: 怒りのピークは6秒。その場を離れて10秒待つだけで、理性が戻ってくる。",
    how: "【やり方】\n\n1. 怒りを感じたら「トイレに行きます」と言う\n   （理由を説明しない）\n\n2. その場を離れる（トイレ、外、別の部屋）\n\n3. 10秒深呼吸する\n   （4-7-8呼吸法を使ってもOK）\n\n4. 「今、何に怒ってる？」と自問\n   （感情を言語化する）\n\n5. 落ち着いてから戻る\n\nいつ使う？\n• 上司に怒られた時\n• パートナーと喧嘩しそうな時\n• 理不尽なことを言われた時",
    real_example: "【みんなの体験談】\n\n「上司に怒られて、すぐに言い返しそうだった。でも『トイレ行きます』って逃げた。戻った時には冷静に話せた。クビにならずに済んだ（笑）」\n— Kenji（32歳・エンジニア）\n\n「パートナーと喧嘩の時、いつも感情的になってた。今は『ちょっと待って』って離れる。戻ったら建設的な話ができる。関係が劇的に改善した。」\n— Aiko（29歳・看護師）",
    action: "【今日から試そう】\n\nステップ1: 今日、怒りを感じたら実践\n• 「トイレ行きます」のフレーズを覚える\n\nステップ2: 離れる場所を決める\n• トイレ、外、別の部屋\n\nステップ3: 10秒深呼吸を習慣に\n• タイマーをセットしてもOK\n\n次に怒りを感じたら、試してみて。\n人生が変わるよ。"
  },

  '行動活性化（小さな目標）': {
    what: "【この方法は】\n行動活性化は、「やる気がなくても、まず動く」テクニック。",
    why: "【なぜ効くの？】\n\nうつ状態では「やる気→行動」の順番が逆転してる。\n普通: やる気 → 行動\nうつ: 行動 → やる気\n\nだから「やる気が出るまで待つ」は永遠に来ない。\n\nでも、小さく動くと：\n→ 脳が「あれ、動けるじゃん」って気づく\n→ ドーパミン（やる気物質）が出る\n→ 次の行動が楽になる\n\n科学的根拠: 行動活性化療法は、うつ病の認知行動療法の核心的要素。",
    how: "【やり方】\n\n1. 「5分だけ」と決める\n   （完璧を目指さない）\n\n2. 超簡単な目標を設定\n   • 「ベッドから出る」\n   • 「顔を洗う」\n   • 「コーヒーを淹れる」\n\n3. タイマーを5分セット\n\n4. やったら自分を褒める\n   （「よくやった！」と声に出す）\n\n5. やる気が出たら続ける\n   （出なくてもOK）\n\nいつ使う？\n• 朝起きるのがつらい時\n• やる気が全く出ない時\n• 何もしたくない時",
    real_example: "【みんなの体験談】\n\n「うつで3週間引きこもってた。『5分だけ』って決めて、顔だけ洗った。それがきっかけで、少しずつ動けるようになった。今は仕事復帰できてる。」\n— Naoki（26歳・IT）\n\n「『やる気が出るまで待つ』を1年やってた。全然来なかった（笑）。『行動→やる気』に切り替えたら、人生変わった。」\n— Rina（31歳・主婦）",
    action: "【明日の朝、試そう】\n\n明日の朝、これをやってみて：\n\n1. アラームが鳴ったら「5分だけ」って言う\n\n2. ベッドから出る（それだけ）\n\n3. 顔を洗う（それだけ）\n\n4. 「よくやった！」って自分を褒める\n\nそれだけ。\n完璧じゃなくていい。\n5分だけでいい。\n\n21日続けたら、習慣になるよ。"
  },

  'グラウンディング（5-4-3-2-1法）': {
    what: "【この方法は】\nグラウンディングは、パニックの時に「今ここ」に戻るテクニック。",
    why: "【なぜ効くの？】\n\nパニック状態では、脳が「過去のトラウマ」や「未来の恐怖」にハイジャックされる。\n→ 現実が見えなくなる\n→ 「今ここ」が消える\n\nでも、五感を使って「今ここ」に集中すると：\n→ 脳が「あ、今は安全だ」って気づく\n→ パニックが収まる\n\n科学的根拠: グラウンディングは、PTSD治療で広く使われる技法。",
    how: "【やり方】\n\n1. 目に見えるもの5つを探す\n   （「青い看板」「赤い服」など）\n\n2. 触れるもの4つを触る\n   （「スマホ」「壁」「髪」など）\n\n3. 聞こえる音3つを聞く\n   （「電車の音」「人の声」など）\n\n4. 匂い2つを嗅ぐ\n   （「コーヒー」「香水」など）\n\n5. 味1つを味わう\n   （「口の中の唾液」でもOK）\n\nゆっくりやる。急がない。\n\nいつ使う？\n• パニック発作の時\n• 過呼吸になりそうな時\n• フラッシュバックの時",
    real_example: "【みんなの体験談】\n\n「電車でパニック発作。このテクニックを思い出して実践した。5つ探してる間に、落ち着いた。今では電車に乗れるようになった。」\n— Shiori（27歳・事務）\n\n「PTSDでフラッシュバックが頻繁にあった。グラウンディングを習慣にしたら、回数が激減した。人生取り戻せた感じ。」\n— Daiki（34歳・自営業）",
    action: "【今すぐ練習しよう】\n\nパニックになる前に、練習しておくのが大事。\n今、一緒にやってみよう：\n\n1. 目に見えるもの5つ\n   （スマホ、壁、天井...）\n\n2. 触れるもの4つ\n   （スマホ、服、椅子...）\n\n3. 聞こえる音3つ\n   （エアコン、車、呼吸...）\n\n4. 匂い2つ\n   （空気、自分の匂い...）\n\n5. 味1つ\n   （口の中の味）\n\nどう？少し「今ここ」に戻れた？\n\n次にパニックになったら、これを思い出して。"
  },

  '思考記録（紙に書き出す）': {
    what: "【この方法は】\n思考記録は、頭の中のグルグルを紙に「外付けハードディスク化」するテクニック。",
    why: "【なぜ効くの？】\n\n反芻思考（同じことをグルグル考える）は、脳のワーキングメモリを占領する。\n→ 他のことができなくなる\n→ 解決策が見つからない\n\nでも、紙に書き出すと：\n→ 脳が「もう覚えなくていい」ってリラックス\n→ ワーキングメモリが解放される\n→ 客観的に見られるようになる\n\n科学的根拠: エクスプレッシブライティング（感情的筆記）は、メンタルヘルス改善に効果あり。",
    how: "【やり方】\n\n1. 紙とペンを用意\n   （スマホじゃなく、紙が大事）\n\n2. 今考えてること3つを書く\n   • きれいに書かなくていい\n   • 誰にも見せない\n\n3. 書いたら「明日考える」と決める\n   （今日は考えない）\n\n4. 紙を引き出しにしまう\n   （視界から消す）\n\n5. 深呼吸3回\n\nいつ使う？\n• 夜、眠れない時\n• 同じことをグルグル考える時\n• 不安が止まらない時",
    real_example: "【みんなの体験談】\n\n「夜、いつも2時間考え込んでた。紙に書き出すようにしたら、5分で眠れるようになった。魔法みたい。」\n— Yuki（25歳・学生）\n\n「不安で仕事が手につかなかった。書き出したら、『あれ、そんなに大したことない？』って気づいた。客観視できるのがいい。」\n— Hiroshi（30歳・会計士）",
    action: "【今夜、試そう】\n\n今夜、眠る前にやってみて：\n\n1. 紙とペンを枕元に置く\n\n2. 布団に入って考え始めたら、紙に書く\n\n3. 3つ書いたら「明日考える」と決める\n\n4. 紙を引き出しにしまう\n\n5. 深呼吸3回\n\nそれだけ。\n\n21日続けたら、睡眠の質が変わるよ。"
  },

  '認知再構成（他の可能性を考える）': {
    what: "【この方法は】\n認知再構成は、「最悪のシナリオ」を「他の可能性」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n不安な時、脳は「ネガティブバイアス」に支配される。\n→ 「嫌われた」「失敗した」と決めつける\n→ 他の可能性が見えなくなる\n\nでも、意識的に「他の理由」を考えると：\n→ 脳が「あ、他にもあるんだ」って気づく\n→ 不安が和らぐ\n\n科学的根拠: 認知再構成は、認知行動療法（CBT）の核心技法。",
    how: "【やり方】\n\n1. 今の不安を言語化\n   （「友達に嫌われた」）\n\n2. 「本当にそう？」と自問\n\n3. 他の可能性を3つ書く\n   • 「忙しいだけかも」\n   • 「忘れてるだけかも」\n   • 「スマホ見てないだけかも」\n\n4. どれが一番ありそうか考える\n\n5. 「分からないことは分からない」と受け入れる\n\nいつ使う？\n• LINEを既読無視された時\n• 「嫌われた」と思った時\n• 最悪のシナリオが頭を支配してる時",
    real_example: "【みんなの体験談】\n\n「既読無視されるたびに『嫌われた』って思ってた。他の可能性を考えるようにしたら、気が楽になった。実際、ほとんどは忙しいだけだった。」\n— Saki（23歳・大学生）\n\n「上司のメールが冷たくて『クビかも』って不安だった。『忙しい』『急いでる』って可能性を考えたら、落ち着けた。実際、忙しかっただけ。」\n— Takuya（28歳・営業）",
    action: "【今すぐ練習しよう】\n\n今、不安なこと1つ思い浮かべて：\n\n1. 紙に書く\n   （例：「友達に嫌われた」）\n\n2. 「本当にそう？」と自問\n\n3. 他の可能性を3つ書く\n\n4. どれが一番ありそうか○をつける\n\nどう？少し気が楽になった？\n\n次に不安になったら、このステップを思い出して。"
  },

  '2分ルール（まず2分だけやる）': {
    what: "【この方法は】\n2分ルールは、「完璧主義」を打ち破る最強のテクニック。",
    why: "【なぜ効くの？】\n\n完璧主義者は「完璧にできないなら、やらない」って思考に陥る。\n→ 行動が止まる\n→ 何も進まない\n\nでも、「2分だけ」と決めると：\n→ ハードルが下がる\n→ 始めやすくなる\n→ 始めたら続けられることが多い\n\n科学的根拠: 行動の80%は「始めること」。始まったら、続けるのは簡単。",
    how: "【やり方】\n\n1. 「2分だけ」と決める\n   （完璧を目指さない）\n\n2. タイマーを2分セット\n\n3. 始める\n   （質は問わない）\n\n4. 2分経ったら止める\n   （続けたければ続ける）\n\n5. 「よくやった！」と自分を褒める\n\nいつ使う？\n• 完璧主義で動けない時\n• 締め切りが迫ってる時\n• やる気が出ない時",
    real_example: "【みんなの体験談】\n\n「レポートが書けなくて3日放置してた。『2分だけ』って始めたら、2時間書き続けてた（笑）。完璧主義から解放された。」\n— Mai（22歳・大学生）\n\n「運動が続かなかった。『2分だけ運動着に着替える』って決めたら、毎日続くようになった。完璧主義って本当に邪魔だったんだなって。」\n— Ken（35歳・会社員）",
    action: "【今すぐ試そう】\n\n今、やるべきだけど進んでないこと1つ思い浮かべて：\n\n1. 「2分だけ」と決める\n\n2. タイマーを2分セット\n\n3. 今すぐ始める\n\nどう？意外と続けられそう？\n\n「完璧じゃなくてもいい」\nこれを覚えておいて。"
  },

  'セルフコンパッション（自分への優しさ）': {
    what: "【この方法は】\nセルフコンパッションは、「自分を責める」を「自分を励ます」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n自己批判は、脳の「脅威システム」を活性化させる。\n→ ストレスホルモン↑\n→ 自己嫌悪のループ\n→ 行動が止まる\n\nでも、自分に優しくすると：\n→ 「安心システム」が活性化\n→ オキシトシン（愛情ホルモン）が出る\n→ 立ち直りが早くなる\n\n科学的根拠: セルフコンパッションは、レジリエンス（回復力）を高める。",
    how: "【やり方】\n\n1. 手を胸に当てる\n   （物理的な温もりが大事）\n\n2. 「誰でもミスする」と言う\n   （自分だけじゃない）\n\n3. 「私も人間だ」と認める\n\n4. 「次はどうする？」と前を向く\n\n5. 深呼吸3回\n\nいつ使う？\n• ミスした時\n• 自分を責めてる時\n• 「私はダメだ」と思った時",
    real_example: "【みんなの体験談】\n\n「会議で失敗して、3日自分を責め続けてた。『誰でもミスする』って言ったら、急に楽になった。今では毎日使ってる。」\n— Ryo（29歳・マーケター）\n\n「完璧主義で、ミスのたびに自己嫌悪だった。セルフコンパッションを習慣にしたら、立ち直りが早くなった。人生が楽になった。」\n— Ai（26歳・デザイナー）",
    action: "【今すぐ試そう】\n\n今、自分を責めてること1つ思い浮かべて：\n\n1. 手を胸に当てる\n\n2. 「誰でもミスする」と声に出す\n\n3. 「私も人間だ」と言う\n\n4. 深呼吸3回\n\nどう？少し楽になった？\n\n「自分に優しく」\nこれを忘れないで。"
  },

  'マイクロブレイク（5分休憩）': {
    what: "【この方法は】\nマイクロブレイクは、燃え尽きを防ぐ「予防的休憩」テクニック。",
    why: "【なぜ効くの？】\n\nバーンアウトは「長期休暇で治る」と思われがちだけど、実は違う。\n→ 毎日の小さな休憩の積み重ねが大事\n\nマイクロブレイク（5分休憩）を取ると：\n→ ストレスホルモンがリセット\n→ 集中力が回復\n→ 燃え尽きを予防\n\n科学的根拠: 90分に1回の休憩が、生産性とメンタルヘルスを最大化する。",
    how: "【やり方】\n\n1. タイマーを90分セット\n\n2. 鳴ったら5分休憩\n\n3. 休憩中にやること：\n   • 外の空気を吸う\n   • 水を飲む\n   • 伸びをする\n   • スマホは見ない\n\n4. 5分経ったら戻る\n\n5. これを繰り返す\n\nいつ使う？\n• 燃え尽きそうな時\n• 集中力が切れた時\n• 1日中働き続けてる時",
    real_example: "【みんなの体験談】\n\n「バーンアウトで休職した。復帰後、90分に1回休むようにしたら、もう燃え尽きない。予防が大事だったんだ。」\n— Kazuki（31歳・エンジニア）\n\n「休憩は『弱い証拠』だと思ってた。マイクロブレイクを始めたら、生産性が2倍になった。休憩って投資なんだね。」\n— Nana（27歳・コンサル）",
    action: "【今日から始めよう】\n\n今日から、これをやってみて：\n\n1. 90分タイマーをセット\n\n2. 鳴ったら5分休憩\n\n3. 外の空気を吸う（これだけ）\n\n21日続けたら、燃え尽きなくなるよ。"
  },

  'デジタルデトックス（アプリを閉じる）': {
    what: "【この方法は】\nデジタルデトックスは、SNSの「比較地獄」から脱出するテクニック。",
    why: "【なぜ効くの？】\n\nSNSは「ハイライトリール」。\n→ みんなの人生のベストシーンだけ\n→ 現実じゃない\n\nでも、脳はそれを「現実」だと錯覚する。\n→ 「私だけ取り残されてる」\n→ 劣等感・不安\n\nデジタルデトックスすると：\n→ 比較が止まる\n→ 自分の人生に集中できる\n\n科学的根拠: SNS使用時間と幸福度は逆相関。",
    how: "【やり方】\n\n1. 今すぐアプリを閉じる\n   （投稿を見ない）\n\n2. スマホを別の部屋に置く\n   （物理的に離す）\n\n3. 1時間は触らない\n\n4. その間に自分のために何かする\n   • 本を読む\n   • 散歩する\n   • 友達に会う\n\n5. 1時間後、気分をチェック\n\nいつ使う？\n• SNSで劣等感を感じた時\n• 比較不安になった時\n• 幸せそうな投稿を見て落ち込んだ時",
    real_example: "【みんなの体験談】\n\n「インスタを見るたびに落ち込んでた。1週間デジタルデトックスしたら、人生が明るくなった。今は1日1回だけ見る。」\n— Miho（24歳・OL）\n\n「SNSやめたら、友達との会話が深くなった。『いいね』じゃなく、リアルな繋がりが増えた。」\n— Shun（30歳・教師）",
    action: "【今すぐやろう】\n\n今すぐ、これをやってみて：\n\n1. SNSアプリを閉じる\n\n2. スマホを別の部屋に置く\n\n3. 1時間触らない\n\n4. この時間で本を1章読む\n\nどう？少し気が楽になった？\n\n「比較は幸せの敵」\nこれを忘れないで。"
  },

  'タスク分解（最優先事項だけ）': {
    what: "【この方法は】\nタスク分解は、「全部やろう」を「これだけやろう」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n締め切り直前のパニックでは、脳が「全部やらなきゃ」って思考に陥る。\n→ 優先順位がつけられない\n→ 全部中途半端\n→ 何も終わらない\n\nでも、「絶対必要なもの」だけに絞ると：\n→ 集中できる\n→ 確実に終わる\n→ 最低限は達成\n\n科学的根拠: エッセンシャリズム（最小限主義）は、生産性を最大化する。",
    how: "【やり方】\n\n1. 全タスクをリストアップ\n\n2. 「これがないと絶対ダメ」を3つ選ぶ\n   （完璧を目指さない）\n\n3. 他は「やらない」と決める\n   （捨てる勇気）\n\n4. 3つに集中\n\n5. 終わったら自分を褒める\n\nいつ使う？\n• 締め切り直前\n• タスクが多すぎる時\n• パニックになってる時",
    real_example: "【みんなの体験談】\n\n「プレゼン資料が間に合わなかった。『絶対必要な3枚だけ』に絞ったら、間に合った。完璧主義を捨てたら、逆に評価された。」\n— Taro（28歳・営業）\n\n「タスクが20個あって何も終わらなかった。『今日は3つだけ』って決めたら、全部終わった。シンプルって強い。」\n— Yuka（26歳・PM）",
    action: "【今すぐやろう】\n\n今、やるべきタスクをリストアップして：\n\n1. 全部書き出す\n\n2. 「これがないと絶対ダメ」を3つ選ぶ\n\n3. 他は斜線で消す\n\n4. 3つに集中\n\nシンプルにしよう。"
  },

  'ポジティブセルフトーク': {
    what: "【この方法は】\nポジティブセルフトークは、「もしダメだったら...」を「ベストを尽くそう」に変えるテクニック。",
    why: "【なぜ効くの？】\n\nネガティブセルフトーク（「もし失敗したら...」）は、脳の脅威システムを活性化させる。\n→ パフォーマンス低下\n→ 不安増加\n\nでも、ポジティブセルフトークは：\n→ 自信を高める\n→ 集中力が上がる\n→ パフォーマンス向上\n\n科学的根拠: ポジティブセルフトークは、スポーツ心理学で広く使われる技法。",
    how: "【やり方】\n\n1. ネガティブな言葉をキャッチ\n   （「もし失敗したら...」）\n\n2. 「待って、それって本当？」と自問\n\n3. ポジティブに言い換える\n   • 「今できることはやった」\n   • 「ベストを尽くそう」\n   • 「何が起きても大丈夫」\n\n4. 声に出して言う\n   （心の中じゃなく、声に出す）\n\n5. 深呼吸3回\n\nいつ使う？\n• 試験前\n• プレゼン前\n• 不安で頭がいっぱいな時",
    real_example: "【みんなの体験談】\n\n「試験前、いつも『もし落ちたら...』って考えてた。『ベストを尽くそう』に変えたら、成績が上がった。言葉って本当に大事。」\n— Kaito（20歳・大学生）\n\n「プレゼン前のパニックが消えた。『できる、できる、できる』って声に出したら、本当にできた（笑）」\n— Eri（32歳・講師）",
    action: "【今すぐ練習しよう】\n\n今、不安なこと1つ思い浮かべて：\n\n1. ネガティブな言葉を言ってみる\n   （「もし失敗したら...」）\n\n2. 「ベストを尽くそう」と声に出す\n\n3. もう1回言う\n\nどう？少し気持ちが変わった？\n\n言葉は魔法。\n使い方を変えるだけで、人生が変わるよ。"
  },

  'ポモドーロテクニック（25分集中）': {
    what: "【この方法は】\nポモドーロテクニックは、「ダラダラ」を「集中」に変える時間管理術。",
    why: "【なぜ効くの？】\n\n人間の集中力は25分が限界。\n→ それ以上やると効率が落ちる\n\nでも、25分に区切ると：\n→ 集中力が最大化\n→ 休憩でリフレッシュ\n→ 生産性が2倍\n\n科学的根拠: タイムボクシング（時間の区切り）は、生産性を高める。",
    how: "【やり方】\n\n1. タイマーを25分セット\n\n2. その間は1つのことだけやる\n   （スマホ見ない、メール見ない）\n\n3. 25分経ったら5分休憩\n   （必ず休む）\n\n4. これを4回繰り返す\n\n5. 4回目の後は15分休憩\n\nいつ使う？\n• 集中できない時\n• 先延ばししてる時\n• ダラダラしてる時",
    real_example: "【みんなの体験談】\n\n「レポートが全然進まなかった。ポモドーロやったら、4時間で終わった。今では毎日使ってる。」\n— Sho（21歳・大学生）\n\n「在宅勤務でダラダラしてた。25分集中を始めたら、生産性が3倍になった。時間の使い方が変わった。」\n— Mei（29歳・ライター）",
    action: "【今すぐ試そう】\n\n今すぐ、これをやってみて：\n\n1. タイマーを25分セット\n\n2. 今やるべきこと1つに集中\n\n3. 25分経ったら5分休憩\n\nたったこれだけ。\n\n習慣にしたら、人生が変わるよ。"
  },

  '24時間ルール': {
    what: "【この方法は】\n24時間ルールは、「衝動買い」を「賢い買い物」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n衝動買いは、脳の「報酬システム」が暴走してる状態。\n→ ドーパミンが過剰分泌\n→ 「今買わないと損！」って錯覚\n\nでも、24時間待つと：\n→ ドーパミンが正常化\n→ 冷静に判断できる\n→ 70%は「要らない」って気づく\n\n科学的根拠: クーリングオフ期間は、衝動的決定を防ぐ。",
    how: "【やり方】\n\n1. 買いたいものをカートに入れる\n   （まだ買わない）\n\n2. スマホのタイマーを24時間セット\n\n3. その間は何もしない\n   （見ない、考えない）\n\n4. 24時間後、もう1回見る\n\n5. それでも欲しかったら買う\n\nいつ使う？\n• セールで焦ってる時\n• 「今買わないと損！」って思った時\n• 衝動的に買いそうな時",
    real_example: "【みんなの体験談】\n\n「毎月5万円衝動買いしてた。24時間ルールを始めたら、半分に減った。本当に欲しいものだけ買うようになった。」\n— Aya（27歳・OL）\n\n「セールに弱かった。24時間待つようにしたら、ほとんど『要らない』ってなった。貯金も増えた。」\n— Jun（30歳・会社員）",
    action: "【今すぐ設定しよう】\n\n今、買いたいものがあったら：\n\n1. カートに入れる\n\n2. 24時間タイマーをセット\n\n3. アプリを閉じる\n\n4. 明日、もう1回見る\n\nそれだけ。\n\n習慣にしたら、お金が貯まるよ。"
  },

  '2分ルール': {
    what: "【この方法は】\n2分ルールは、「明日から運動しよう」を「今日運動着に着替える」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n行動の最大の障壁は「始めること」。\n→ 「30分運動する」はハードルが高い\n→ だから始められない\n\nでも、「2分だけ」と決めると：\n→ ハードルが下がる\n→ 始めやすい\n→ 始めたら続けられる\n\n科学的根拠: 行動の80%は「始めること」。始まったら、続けるのは簡単。",
    how: "【やり方】\n\n1. 「2分だけ」と決める\n   （完璧を目指さない）\n\n2. 運動着に着替える\n   （それだけでOK）\n\n3. 玄関まで行く\n   （外に出なくてもOK）\n\n4. やる気が出たら続ける\n   （出なくてもOK）\n\n5. 「よくやった！」と自分を褒める\n\nいつ使う？\n• 運動が続かない時\n• やる気が出ない時\n• 「明日から」を繰り返してる時",
    real_example: "【みんなの体験談】\n\n「『明日から運動しよう』を1年繰り返してた。『2分だけ着替える』って決めたら、毎日続くようになった。完璧主義を捨てたら成功した。」\n— Hiro（35歳・会社員）\n\n「2分だけランニングシューズを履く。それだけで外に出るようになった。今では週5で走ってる。」\n— Kana（28歳・看護師）",
    action: "【明日の朝、試そう】\n\n明日の朝、これをやってみて：\n\n1. 「2分だけ」と決める\n\n2. 運動着に着替える\n\n3. それだけ\n\nそれだけで十分。\n続けたくなったら続ける。\n\n21日続けたら、習慣になるよ。"
  },

  '5秒ルール': {
    what: "【この方法は】\n5秒ルールは、「話しかけられない」を「話しかける」に変えるテクニック。",
    why: "【なぜ効くの？】\n\n社交不安では、脳が「これ言ったら嫌われる」って恐怖を生む。\n→ 考えれば考えるほど不安が増す\n→ 行動できなくなる\n\nでも、5秒以内に動くと：\n→ 脳が「考える時間」がない\n→ 不安が生まれる前に行動\n→ 意外とうまくいく\n\n科学的根拠: 行動の遅延は不安を増幅させる。即行動が不安を減らす。",
    how: "【やり方】\n\n1. 話しかけたい人を見つける\n\n2. 心の中で「5、4、3、2、1」とカウント\n\n3. 1で話しかける\n   （「この料理美味しいですね」でOK）\n\n4. 深呼吸1回\n\n5. 「よくやった！」と自分を褒める\n\nいつ使う？\n• パーティーで話しかけられない時\n• 知らない人と話すのが怖い時\n• 社交不安の時",
    real_example: "【みんなの体験談】\n\n「パーティーでいつもトイレに隠れてた。5秒ルールを試したら、話しかけられるようになった。友達も増えた。」\n— Riko（24歳・学生）\n\n「知らない人と話すのが怖かった。5秒ルールで『こんにちは』だけ言えるようになった。今では普通に話せる。」\n— Tatsuya（29歳・営業）",
    action: "【今度のパーティーで試そう】\n\n次にパーティーに行ったら：\n\n1. 話しかけたい人を見つける\n\n2. 5、4、3、2、1\n\n3. 「この料理美味しいですね」\n\nそれだけ。\n\n5秒で人生が変わるよ。"
  }
};

// ================== シナリオテンプレート ==================

const SCENARIOS = {
  work_stress: [
    { setup: '締め切りに追われている時', question: 'どう対処する？' },
    { setup: '上司に怒られた後', question: '気持ちをどう整える？' },
    { setup: 'プレゼン前の緊張', question: 'どうする？' },
    { setup: '仕事が山積みでパンク寸前', question: '最初にやるべきは？' },
    { setup: '同僚との意見の食い違い', question: 'どう解決する？' },
  ],
  student: [
    { setup: 'テスト前日に焦っている', question: '効果的な勉強法は？' },
    { setup: '友達関係で悩んでいる', question: 'どう考える？' },
    { setup: '授業中に集中できない', question: 'どうする？' },
    { setup: '失敗を引きずっている', question: 'どう立ち直る？' },
    { setup: '将来の不安が大きい', question: 'どう向き合う？' },
  ],
  daily_life: [
    { setup: '朝起きるのがつらい', question: 'どう改善する？' },
    { setup: '夜なかなか寝付けない', question: 'どうする？' },
    { setup: 'SNSで気分が落ち込んだ', question: 'どう対処する？' },
    { setup: '予定がうまくいかなかった', question: 'どう考える？' },
    { setup: '嫌なニュースを見てしまった', question: 'どうする？' },
  ],
  relationships: [
    { setup: '友達に裏切られた気がする', question: 'どう向き合う？' },
    { setup: 'パートナーと喧嘩した', question: 'どう解決する？' },
    { setup: '人に嫌われるのが怖い', question: 'どう考える？' },
    { setup: '誰とも会いたくない気分', question: 'どうする？' },
    { setup: '褒められても素直に受け取れない', question: 'なぜ？' },
  ],
  health: [
    { setup: '最近疲れやすい', question: '原因は何？' },
    { setup: '頭痛が続いている', question: 'どうする？' },
    { setup: '食欲がない日が続く', question: '考えられる理由は？' },
    { setup: '運動が続かない', question: 'どう工夫する？' },
    { setup: '体調不良を感じるが病院に行けない', question: 'どうする？' },
  ],
  money: [
    { setup: '衝動買いしてしまう', question: 'どう防ぐ？' },
    { setup: '貯金ができない', question: '何から始める？' },
    { setup: 'お金の不安が消えない', question: 'どう考える？' },
    { setup: '高額な買い物を後悔している', question: 'どうする？' },
    { setup: '友達との金銭感覚のズレ', question: 'どう向き合う？' },
  ],
};

// ================== キャラクターデータベース ==================

const CHARACTERS = [
  { name: '田中さん', age: 28, job: '営業職', trait: '真面目で頑張り屋' },
  { name: '佐藤さん', age: 35, job: '教師', trait: '優しいけど自分に厳しい' },
  { name: '鈴木さん', age: 22, job: '大学生', trait: '社交的だけど不安になりやすい' },
  { name: '高橋さん', age: 42, job: '会社員', trait: '責任感が強い' },
  { name: '伊藤さん', age: 30, job: 'デザイナー', trait: 'クリエイティブで繊細' },
  { name: '渡辺さん', age: 25, job: '看護師', trait: '共感力が高い' },
  { name: '山本さん', age: 38, job: '経営者', trait: 'ストレスを抱え込む' },
  { name: '中村さん', age: 27, job: 'エンジニア', trait: '論理的思考' },
  { name: '小林さん', age: 33, job: '主婦', trait: '家族思い' },
  { name: '加藤さん', age: 29, job: 'フリーランス', trait: '自由だけど孤独' },
];

// ================== バイアスデータベース ==================

const BIASES = [
  {
    ja: '確証バイアス',
    desc: '自分の考えを裏付ける情報だけ集める',
    example: '「やっぱりそうだ」って思う情報ばかり見てる',
    emoji: '🔍',
    funFact: 'SNSのアルゴリズムは、あなたの興味に合った情報を優先的に表示するから、確証バイアスがさらに強くなっちゃうんだ。「エコーチェンバー（反響室）」って呼ばれてるよ。',
    tip: '意識的に反対意見も読んでみよう。「自分の考えが間違ってるかも？」って疑う姿勢が大事！'
  },
  {
    ja: '生存者バイアス',
    desc: '成功例だけ見て失敗例を無視',
    example: '成功した人の本ばかり読んで、失敗例は無視',
    emoji: '🏆',
    funFact: '第二次世界大戦で、帰還した飛行機の弾痕を調べた時、「弾が当たらなかった場所」こそ強化すべきだと気づいたのが、このバイアスの有名な例だよ。帰ってこれなかった飛行機は、別の場所に弾が当たってたんだ。',
    tip: '成功例だけじゃなく、失敗例も調べよう。「なぜうまくいかなかったのか？」を知ることが大事！'
  },
  {
    ja: '後知恵バイアス',
    desc: '後から「知ってた」と思う',
    example: '試験の答え見た後「これ知ってた」',
    emoji: '🤔',
    funFact: '選挙結果や株価の変動を「予想してた」と思うのも、このバイアスの典型例だよ。実際は結果を知ってから記憶が書き換わってるんだ。',
    tip: '予想を事前にメモしておこう。後から「当たった／外れた」を客観的に確認できるよ。'
  },
  {
    ja: 'アンカリング',
    desc: '最初の情報に引きずられる',
    example: '最初に見た家が800万円だから、600万円が安く感じる',
    emoji: '⚓',
    funFact: 'セール価格の「定価9,800円→今なら4,980円！」も、このアンカリングを使ったテクニックだよ。最初に高い価格を見せることで、安く感じさせるんだ。',
    tip: '「この価格は、他と比べて本当に妥当？」って、複数の選択肢を比較してから判断しよう。最初の情報に引きずられないように！'
  },
  {
    ja: 'ハロー効果',
    desc: '一部の印象が全体に影響',
    example: '見た目がいい人は性格も良さそうに見える',
    emoji: '✨',
    funFact: '「ハロー」は「後光」って意味。聖人の頭の周りの光みたいに、1つの特徴が全体を照らしちゃうんだ。採用面接や恋愛でもよく起こるよ。',
    tip: '「この人の具体的な行動は？」って聞くと、印象だけじゃなく事実で判断できるようになるよ。'
  },
  {
    ja: '現状維持バイアス',
    desc: '変化を避けたがる',
    example: '不満があっても転職しない',
    emoji: '🔄',
    funFact: '人間は「損失回避」の傾向があるから、変化による「失うかもしれないもの」を過大評価しちゃうんだ。「今のまま」が一番安全に見えるんだよ。',
    tip: '変化のメリット・デメリットをリストアップしてみよう。客観的に比較すると、恐怖が和らぐよ。'
  },
  {
    ja: 'ネガティブバイアス',
    desc: '悪い情報の方が記憶に残る',
    example: '褒められた10回より、怒られた1回の方を覚えてる',
    emoji: '⚠️',
    funFact: '進化心理学的には、危険を避けるために「悪い情報」に敏感になるのは合理的だったんだ。でも現代社会では、このバイアスがストレスの原因になることも。',
    tip: '1日の終わりに「今日の良かったこと3つ」を書き出そう。ポジティブな記憶も意識的に残すトレーニングになるよ。'
  },
  {
    ja: '利用可能性ヒューリスティック',
    desc: '思い出しやすい情報で判断',
    example: 'ニュースで飛行機事故を見た後、飛行機が怖く感じる',
    emoji: '📰',
    funFact: 'テロや飛行機事故は交通事故より遥かに少ないのに、ニュースで大きく報道されるから「頻繁に起こる」と感じちゃうんだ。',
    tip: '統計データを確認しよう。「印象」じゃなく「実際の確率」で判断することが大事！'
  },
];

// ================== 解説テンプレート ==================

const EXPLANATIONS = {
  therapy_effective: (therapy, disorder) => ({
    explanation: `${therapy}は${disorder}に効果があるって研究で証明されてるんだ！でも、万能じゃないから他の方法も組み合わせることが多いよ。`,
    fun_fact: `💡臨床では「どっちが絶対」じゃなく、「この人にはどっちが合うか」を考えるのが大事！`,
    emoji: '🧠'
  }),
  both_work: () => ({
    explanation: `実は両方とも効果があるんだ！どっちを選ぶかは、クライアントの状態や好み次第だよ。`,
    fun_fact: `💡心理療法は「オーダーメイド」。一人ひとりに合わせるのがプロの腕の見せ所！`,
    emoji: '⚖️'
  }),
  coping_strategy: (strategy) => ({
    explanation: `${strategy}は科学的に効果が証明されてる対処法だよ。すぐには変わらないけど、続けることが大事！`,
    fun_fact: `💡ストレス対処は「筋トレ」みたいなもの。練習すればするほど上手くなるんだ。`,
    emoji: '💪'
  }),
  research_limitation: () => ({
    explanation: `研究には必ず限界があるんだ。だからこそ、複数の研究を見て総合的に判断することが重要だよ。`,
    fun_fact: `💡「完璧な研究」なんて存在しない。だから科学は常に進化し続けるんだ！`,
    emoji: '🔬'
  }),
  bias_awareness: (biasName) => ({
    explanation: `これは「${biasName}」って言うんだ。無意識にやっちゃうから、まず気づくことが大事！`,
    fun_fact: `💡バイアスは誰にでもある。プロの研究者でもバイアスにハマるから、常に意識が必要なんだ。`,
    emoji: '🎯'
  }),
  individual_difference: () => ({
    explanation: `人によって効果は違うんだ。だから「絶対これ！」じゃなく、その人に合わせた方法を探すのが大切だよ。`,
    fun_fact: `💡心理学の世界では「個人差」が超重要。平均だけ見てると大事なことを見逃しちゃうんだ！`,
    emoji: '👥'
  }),
};

// ================== ProblemGenerator クラス ==================

class ProblemGenerator {
  constructor(sources, currentUnit = 'mental') {
    this.sources = sources.filter(s => s.abstract && s.abstract.length > 100);
    // Track recently used therapies to avoid repetition
    this.recentlyUsedTherapies = [];
    this.maxRecentTherapies = 5;
    this.currentUnit = currentUnit; // Track which unit we're generating for
    console.log(`✓ Loaded ${this.sources.length} sources with abstracts`);
  }

  // -------------------- ユーティリティ関数 --------------------

  randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  randomSample(arr, n) {
    const shuffled = [...arr].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, n);
  }

  getUnusedTherapy() {
    const availableTherapies = PSYCH_TERMS.therapies.filter(t =>
      !this.recentlyUsedTherapies.includes(t.ja)
    );

    const therapy = this.randomChoice(
      availableTherapies.length > 0 ? availableTherapies : PSYCH_TERMS.therapies
    );

    this.recentlyUsedTherapies.push(therapy.ja);
    if (this.recentlyUsedTherapies.length > this.maxRecentTherapies) {
      this.recentlyUsedTherapies.shift();
    }

    return therapy;
  }

  extractKeywords(text) {
    const keywords = [];
    const lower = text.toLowerCase();

    // 療法名を抽出
    PSYCH_TERMS.therapies.forEach(t => {
      if (lower.includes(t.en.toLowerCase()) || lower.includes(t.ja)) {
        keywords.push({ type: 'therapy', term: t });
      }
    });

    // 障害名を抽出
    PSYCH_TERMS.disorders.forEach(d => {
      if (lower.includes(d.en.toLowerCase()) || lower.includes(d.ja)) {
        keywords.push({ type: 'disorder', term: d });
      }
    });

    // 概念を抽出
    PSYCH_TERMS.concepts.forEach(c => {
      if (lower.includes(c.en.toLowerCase()) || lower.includes(c.ja)) {
        keywords.push({ type: 'concept', term: c });
      }
    });

    return keywords;
  }

  inferContext(paper) {
    const text = `${paper.title} ${paper.abstract}`.toLowerCase();

    // ユニット推定
    const unitHints = {
      mental: ['emotion', 'mood', 'depression', 'anxiety', 'stress', 'mindfulness'],
      work: ['work', 'job', 'burnout', 'occupational', 'employee', 'workplace'],
      study: ['student', 'learning', 'academic', 'education', 'school'],
      health: ['sleep', 'exercise', 'physical', 'health', 'body'],
      social: ['social', 'relationship', 'interpersonal', 'friend'],
      money: ['economic', 'financial', 'money', 'poverty'],
    };

    let unit = 'mental'; // デフォルト
    let maxScore = 0;
    Object.entries(unitHints).forEach(([u, hints]) => {
      const score = hints.filter(h => text.includes(h)).length;
      if (score > maxScore) {
        maxScore = score;
        unit = u;
      }
    });

    return { unit, keywords: this.extractKeywords(text) };
  }

  getDifficulty() {
    const rand = Math.random();
    if (rand < 0.4) return 'easy';
    if (rand < 0.8) return 'medium';
    return 'hard';
  }

  getXpForDifficulty(difficulty) {
    if (difficulty === 'easy') return 5;
    if (difficulty === 'medium') return 10;
    if (difficulty === 'hard') return 15;
    return 10; // default
  }

  // -------------------- ヘルパーメソッド（シナリオ生成用） --------------------

  makeDetailedFeedback(wrongMethod, correctMethod, situation) {
    return `「${wrongMethod}」を選んだんだね。\n\nこの方法も悪くない！\n\nでも、今回の状況（${situation.emotion}）では、\n「${correctMethod}」の方がベストなんだ。\n\n【なぜベストか】\n\n1. 即効性が高い（1分で効果）\n2. その場で使える\n3. 科学的根拠がある\n\n【使い分け】\n• ${situation.emotion}の時 → ${correctMethod}\n• 他の状況 → ${wrongMethod}\n\n次に${situation.emotion}を感じたら、\n「${correctMethod}」を試してみて。\n人生が変わるよ。`;
  }

  makeInterestingFact(method) {
    const facts = {
      '4-7-8呼吸法': "【知ってた？】\n\n4-7-8呼吸法は、もともとヨガの「プラナヤマ」から来てるんだ。\n\n何千年も前から使われてる方法が、今、科学的に証明されてるんだよ。\n\nNavy SEALsも戦場で使ってる！\nあなたも今日から、同じ技術を使えるんだよ。",
      'タイムアウト（その場を離れる）': "【知ってた？】\n\n怒りのピークは「6秒」。\n\nたった6秒待つだけで、理性が戻ってくる。\n\nでも、6秒って意外と長い。だから「その場を離れる」のが一番簡単なんだ。",
      '行動活性化（小さな目標）': "【知ってた？】\n\nうつ病治療の効果研究で、「薬」と「行動活性化」を比較したら、\n行動活性化の方が効果が高かったんだ。\n\n行動って、それくらい強力なんだよ。",
      'グラウンディング（5-4-3-2-1法）': "【知ってた？】\n\nグラウンディングは、戦場で使われてきた技術。\n\nPTSDの兵士が「今ここ」に戻るために開発されたんだ。\n\nあなたも、同じ技術を使えるんだよ。",
      '思考記録（紙に書き出す）': "【知ってた？】\n\n紙に書くと、脳の別の部分が活性化する。\n\n「考える脳」から「書く脳」に切り替わると、\n客観視できるようになるんだ。\n\nスマホじゃなく、紙が大事な理由だよ。",
      '認知再構成（他の可能性を考える）': "【知ってた？】\n\n認知再構成は、認知行動療法（CBT）の核心技法。\n\nCBTは「心理療法のゴールドスタンダード」と呼ばれるほど効果が証明されてる。\n\nあなたも、プロと同じ技術を使えるんだよ。",
      '2分ルール（まず2分だけやる）': "【知ってた？】\n\n「2分ルール」は、生産性の専門家が使う技術。\n\n完璧主義を打ち破る最強の方法なんだ。\n\n2分だけなら、誰でもできる。これが秘密だよ。",
      'セルフコンパッション（自分への優しさ）': "【知ってた？】\n\nセルフコンパッションは、自己批判より「効果が高い」ことが研究で証明されてる。\n\n自分に厳しい方が成長する、は「嘘」なんだ。\n\n優しい方が、成長するんだよ。",
      'マイクロブレイク（5分休憩）': "【知ってた？】\n\nGoogleやMicrosoftでは、90分に1回の休憩が推奨されてる。\n\n休憩は「サボり」じゃなく、「投資」なんだ。\n\n生産性を最大化する秘密だよ。",
      'デジタルデトックス（アプリを閉じる）': "【知ってた？】\n\nSNS使用時間と幸福度は「逆相関」。\n\n見れば見るほど、不幸になるんだ。\n\n「いいね」より、リアルな繋がりの方が幸せを生むんだよ。",
      'タスク分解（最優先事項だけ）': "【知ってた？】\n\n「エッセンシャリズム」（最小限主義）は、シリコンバレーで大流行した考え方。\n\n「全部やる」より「3つだけやる」の方が、成果が出るんだ。\n\nシンプルって、強いんだよ。",
      'ポジティブセルフトーク': "【知ってた？】\n\nオリンピック選手は、必ずポジティブセルフトークを使う。\n\n「できる」って言うと、本当にパフォーマンスが上がるんだ。\n\n言葉は魔法。使い方次第で、人生が変わるんだよ。",
      'ポモドーロテクニック（25分集中）': "【知ってた？】\n\nポモドーロテクニックは、イタリアの学生が発明した。\n\n「トマト型タイマー」を使ったから「ポモドーロ」（イタリア語でトマト）って名前なんだ。\n\nシンプルだけど、効果抜群だよ。",
      '24時間ルール': "【知ってた？】\n\n衝動買いの70%は、24時間待つと「要らない」ってなる。\n\nドーパミンが正常化するのに、24時間かかるんだ。\n\n待つだけで、お金が貯まるんだよ。",
      '2分ルール': "【知ってた？】\n\n運動が続かない理由は「始めること」がハードルだから。\n\n2分だけなら、誰でもできる。\n\nこれが習慣化の秘密だよ。",
      '5秒ルール': "【知ってた？】\n\n社交不安は「考えすぎ」が原因。\n\n5秒以内に動くと、不安が生まれる前に行動できる。\n\n即行動が、不安を減らす秘密だよ。"
    };

    return facts[method] || `この方法は、多くの研究で効果が証明されてるんだよ。`;
  }

  makeActionableTip(method) {
    const tips = {
      '4-7-8呼吸法': "【今すぐできる3ステップ】\n\nステップ1: アラームを3つ設定\n• 朝8時、昼12時、夜8時\n\nステップ2: 鳴ったら1分だけ実践\n• 4-7-8を3回\n\nステップ3: 21日間続ける\n• 習慣化 = 一生使えるスキル\n\n今すぐアラームセット！",
      'タイムアウト（その場を離れる）': "【今すぐできる3ステップ】\n\nステップ1: 「トイレ行きます」を覚える\n• このフレーズだけ\n\nステップ2: 離れる場所を決める\n• トイレ、外、別の部屋\n\nステップ3: 10秒深呼吸\n• タイマーをセット\n\n次に怒りを感じたら、試してみて。",
      '行動活性化（小さな目標）': "【明日の朝、試そう】\n\nステップ1: 「5分だけ」と決める\n\nステップ2: ベッドから出る（それだけ）\n\nステップ3: 顔を洗う（それだけ）\n\nステップ4: 「よくやった！」って自分を褒める\n\n21日続けたら、習慣になるよ。",
      'グラウンディング（5-4-3-2-1法）': "【今すぐ練習しよう】\n\n1. 目に見えるもの5つ\n2. 触れるもの4つ\n3. 聞こえる音3つ\n4. 匂い2つ\n5. 味1つ\n\nパニックになる前に、練習しておくのが大事。\n今すぐやってみて。",
      '思考記録（紙に書き出す）': "【今夜、試そう】\n\nステップ1: 紙とペンを枕元に置く\n\nステップ2: 布団に入って考え始めたら、紙に書く\n\nステップ3: 3つ書いたら「明日考える」と決める\n\nステップ4: 紙を引き出しにしまう\n\n21日続けたら、睡眠の質が変わるよ。",
      '認知再構成（他の可能性を考える）': "【今すぐ練習しよう】\n\nステップ1: 不安なこと1つを紙に書く\n\nステップ2: 「本当にそう？」と自問\n\nステップ3: 他の可能性を3つ書く\n\nステップ4: どれが一番ありそうか○をつける\n\n次に不安になったら、このステップを思い出して。",
      '2分ルール（まず2分だけやる）': "【今すぐ試そう】\n\nステップ1: やるべきこと1つを思い浮かべる\n\nステップ2: 「2分だけ」と決める\n\nステップ3: タイマーを2分セット\n\nステップ4: 今すぐ始める\n\n「完璧じゃなくてもいい」\nこれを覚えておいて。",
      'セルフコンパッション（自分への優しさ）': "【今すぐ試そう】\n\nステップ1: 自分を責めてること1つを思い浮かべる\n\nステップ2: 手を胸に当てる\n\nステップ3: 「誰でもミスする」と声に出す\n\nステップ4: 深呼吸3回\n\n「自分に優しく」\nこれを忘れないで。",
      'マイクロブレイク（5分休憩）': "【今日から始めよう】\n\nステップ1: 90分タイマーをセット\n\nステップ2: 鳴ったら5分休憩\n\nステップ3: 外の空気を吸う（これだけ）\n\n21日続けたら、燃え尽きなくなるよ。",
      'デジタルデトックス（アプリを閉じる）': "【今すぐやろう】\n\nステップ1: SNSアプリを閉じる\n\nステップ2: スマホを別の部屋に置く\n\nステップ3: 1時間触らない\n\nステップ4: この時間で本を1章読む\n\n「比較は幸せの敵」\nこれを忘れないで。",
      'タスク分解（最優先事項だけ）': "【今すぐやろう】\n\nステップ1: やるべきタスクを全部書き出す\n\nステップ2: 「これがないと絶対ダメ」を3つ選ぶ\n\nステップ3: 他は斜線で消す\n\nステップ4: 3つに集中\n\nシンプルにしよう。",
      'ポジティブセルフトーク': "【今すぐ練習しよう】\n\nステップ1: 不安なこと1つを思い浮かべる\n\nステップ2: ネガティブな言葉を言ってみる\n\nステップ3: 「ベストを尽くそう」と声に出す\n\nステップ4: もう1回言う\n\n言葉は魔法。\n使い方を変えるだけで、人生が変わるよ。",
      'ポモドーロテクニック（25分集中）': "【今すぐ試そう】\n\nステップ1: タイマーを25分セット\n\nステップ2: 今やるべきこと1つに集中\n\nステップ3: 25分経ったら5分休憩\n\n習慣にしたら、人生が変わるよ。",
      '24時間ルール': "【今すぐ設定しよう】\n\nステップ1: 買いたいものをカートに入れる\n\nステップ2: 24時間タイマーをセット\n\nステップ3: アプリを閉じる\n\nステップ4: 明日、もう1回見る\n\n習慣にしたら、お金が貯まるよ。",
      '2分ルール': "【明日の朝、試そう】\n\nステップ1: 「2分だけ」と決める\n\nステップ2: 運動着に着替える\n\nステップ3: それだけ\n\n続けたくなったら続ける。\n21日続けたら、習慣になるよ。",
      '5秒ルール': "【今度のパーティーで試そう】\n\nステップ1: 話しかけたい人を見つける\n\nステップ2: 5、4、3、2、1\n\nステップ3: 「この料理美味しいですね」\n\n5秒で人生が変わるよ。"
    };

    return tips[method] || `今日から試してみよう！`;
  }

  getEmotionEmoji(emotion) {
    const emojiMap = {
      '不安・緊張': '😰',
      '怒り・屈辱': '😠',
      '無気力・憂鬱': '😔',
      '社交不安': '😨',
      'パニック・恐怖': '😱',
      '反芻思考・不安': '😟',
      '拒絶不安': '😥',
      '完璧主義・不安': '😓',
      '自己批判・後悔': '😞',
      '燃え尽き・無感動': '😶',
      '比較不安・劣等感': '😢',
      'プレッシャー・焦燥': '😫',
      '対立・防衛的': '😤',
      '圧倒・混乱': '😵',
      'インポスター症候群': '😰',
      'サザエさん症候群': '😔',
      'コントロール欠如・フラストレーション': '😖',
      '恥・自己嫌悪': '😳',
      '不公平感・怒り': '😠',
      'Zoom疲れ・消耗': '😩',
      '先延ばし・罪悪感': '😔',
      '注意散漫・焦燥': '😵',
      '失望・無力感': '😞',
      'フラストレーション・孤独': '😤',
      '罪悪感・無気力': '😔',
      '衝動・葛藤': '🤔',
      '夜更かし癖・自制心の欠如': '😪',
      '慢性痛・絶望': '😣',
      'フラストレーション・無力感': '😞',
      '渇望・葛藤': '😖',
      '痛み・無視': '😣',
      '罪悪感・依存': '😔',
      '疲労・脱水': '😓',
      'ストレス・罪悪感': '😔',
      '孤独・悲しみ': '😢',
      '罪悪感': '😔',
      'フラストレーション・圧迫感': '😖',
      '嫉妬・不安': '😟',
      '疲労・自己嫌悪': '😞',
      '劣等感・嫉妬': '😢',
      '社交不安・緊張': '😨',
      'FOMO（取り残される不安）': '😰',
      '自己嫌悪・無力感': '😞',
      '罪悪感・葛藤': '😔',
    };

    return emojiMap[emotion] || '💪';
  }

  estimateDifficulty(situation) {
    if (situation.time_constraint === 'immediate' || situation.time_constraint === 'emergency') {
      return 'easy'; // Immediate action = easier to understand
    } else if (situation.time_constraint === 'chronic') {
      return 'hard'; // Long-term change = harder
    }
    return 'medium';
  }

  shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // -------------------- 問題生成関数 --------------------

  // 1. シナリオクイズ (あなた自身の状況)
  generateScenario() {
    // Determine current unit (default to mental if not set)
    const currentUnit = this.currentUnit || 'mental';

    // Get situations for this unit
    const unitSituations = REAL_LIFE_SITUATIONS[currentUnit];
    if (!unitSituations || unitSituations.length === 0) {
      console.warn(`No situations found for unit: ${currentUnit}`);
      return null;
    }

    const situation = this.randomChoice(unitSituations);

    // Build choices from concrete actions
    const correctChoice = situation.concrete_actions[situation.correct_method];
    const wrongChoices = situation.wrong_methods.map(m => situation.concrete_actions[m]);

    const choices = [correctChoice, ...wrongChoices];
    this.shuffleArray(choices); // Shuffle so correct isn't always first
    const correctIndex = choices.indexOf(correctChoice);

    // Get method database entry
    const methodInfo = METHOD_DATABASE[situation.correct_method];
    if (!methodInfo) {
      console.warn(`No method info found for: ${situation.correct_method}`);
      return null;
    }

    // Generate detailed incorrect feedback
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== correctIndex) {
        const wrongMethod = Object.keys(situation.concrete_actions).find(
          key => situation.concrete_actions[key] === choice
        );

        incorrectFeedback[index] = this.makeDetailedFeedback(
          wrongMethod,
          situation.correct_method,
          situation
        );
      }
    });

    return {
      id: `you_scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `あなたの状況:\n\n${situation.setup}\n\nこの時、あなたならどうする？`,
      choices: choices,
      answer_index: correctIndex,

      // 5-element structure (NO "explanation" field!)
      what: methodInfo.what,
      why: methodInfo.why,
      how: methodInfo.how,
      real_example: methodInfo.real_example,
      action: methodInfo.action,

      fun_fact: this.makeInterestingFact(situation.correct_method),
      tip: this.makeActionableTip(situation.correct_method),
      incorrect_feedback: incorrectFeedback,

      emoji_hint: this.getEmotionEmoji(situation.emotion),
      difficulty: this.estimateDifficulty(situation),
      xp: situation.time_constraint === 'immediate' || situation.time_constraint === 'emergency' ? 15 : 10
    };
  }

  // 2. どっちクイズ (絵文字付き)
  generateWhichOne() {
    // Get current unit and situation
    const currentUnit = this.currentUnit || 'mental';
    const unitSituations = REAL_LIFE_SITUATIONS[currentUnit];

    if (!unitSituations || unitSituations.length === 0) {
      console.warn(`No situations found for unit: ${currentUnit}`);
      return null;
    }

    const situation = this.randomChoice(unitSituations);

    // Get correct method and one wrong method
    const correctMethod = situation.correct_method;
    const wrongMethod = this.randomChoice(situation.wrong_methods);

    // Get concrete actions
    const correctAction = situation.concrete_actions[correctMethod];
    const wrongAction = situation.concrete_actions[wrongMethod];

    // Get method database entries
    const correctMethodInfo = METHOD_DATABASE[correctMethod];
    const wrongMethodKey = Object.keys(METHOD_DATABASE).find(key =>
      situation.concrete_actions[wrongMethod] && key.includes(wrongMethod.split('（')[0])
    );

    if (!correctMethodInfo) {
      console.warn(`No method info found for: ${correctMethod}`);
      return null;
    }

    // Randomly decide which side is correct (0 or 1)
    const answerIndex = Math.random() < 0.5 ? 0 : 1;
    const choices = answerIndex === 0
      ? [correctAction, wrongAction]
      : [wrongAction, correctAction];

    // Generate incorrect feedback
    const incorrectFeedback = {};
    const incorrectIndex = answerIndex === 0 ? 1 : 0;
    incorrectFeedback[incorrectIndex] = this.makeDetailedFeedback(
      wrongMethod,
      correctMethod,
      situation
    );

    return {
      id: `whichone_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'ab',
      stem: `💭 あなたの状況:\n\n${situation.setup}\n\n⚖️ どっちの方法を選ぶ？`,
      choices: choices,
      answer_index: answerIndex,

      // 5-element structure (NO "explanation" field!)
      what: correctMethodInfo.what,
      why: correctMethodInfo.why,
      how: correctMethodInfo.how,
      real_example: correctMethodInfo.real_example,
      action: correctMethodInfo.action,

      fun_fact: this.makeInterestingFact(correctMethod),
      tip: this.makeActionableTip(correctMethod),
      incorrect_feedback: incorrectFeedback,
      emoji_hint: this.getEmotionEmoji(situation.emotion),
      difficulty: this.estimateDifficulty(situation),
      xp: situation.time_constraint === 'immediate' || situation.time_constraint === 'emergency' ? 15 : 10
    };
  }

  // 3. ○×クイズ
  generateTrueFalse() {
    const paper = this.randomChoice(this.sources);
    const keywords = this.extractKeywords(paper.abstract);

    if (keywords.length === 0) return null;

    const keyword = this.randomChoice(keywords);
    const term = keyword.term;

    // Get method from METHOD_DATABASE that matches this term
    const methodKey = Object.keys(METHOD_DATABASE).find(key =>
      key.includes(term.ja) || term.ja.includes(key.split('（')[0])
    );

    // Fix: Get description based on term type
    const termDesc = term.desc || term.symptom || term.effect || '';

    const statements = [
      { text: `あなたが${term.ja}を使えば、ストレスが和らぐ`, isTrue: true },
      { text: `あなたは${term.ja}を一度試せば、すぐに完璧にできる`, isTrue: false },
      { text: `${term.ja}は、あなたのような普通の人には効かない`, isTrue: false },
    ];

    const statement = this.randomChoice(statements);

    // Get method info for 5-element structure
    const methodInfo = methodKey ? METHOD_DATABASE[methodKey] : null;

    // If we have method info, use it; otherwise create generic content
    const what = methodInfo?.what || `【この方法は】\n${term.ja}${termDesc ? `（${termDesc}）` : ''}は、科学的に効果が証明された方法だよ。`;
    const why = methodInfo?.why || `【なぜ効くの？】\n\n研究で効果が実証されているんだ。多くの人が実際に使って、効果を実感してるよ。`;
    const how = methodInfo?.how || `【やり方】\n\n専門家に相談しながら、あなたに合ったやり方を見つけていこう。`;
    const real_example = methodInfo?.real_example || `【みんなの体験談】\n\n「最初は半信半疑だったけど、続けたら効果を実感できた！」って声がたくさんあるよ。`;
    const action = methodInfo?.action || `【今すぐ試そう！】\n\nまずは専門家に相談してみよう。あなたに合った方法を一緒に見つけられるよ。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    const correctIndex = statement.isTrue ? 0 : 1;
    const incorrectIndex = correctIndex === 0 ? 1 : 0;

    if (statement.isTrue) {
      // 正解が「正しい」の場合、「誤り」を選んだ時のフィードバック
      incorrectFeedback[incorrectIndex] = `慎重に判断しようとしているのは素晴らしいね！「本当に効果があるのか？」って疑問を持つのは大事だよ。\n\nでも実際は、${term.ja}${termDesc ? `（${termDesc}）` : ''}は研究で効果が証明されている方法なんだ。あなたも試してみる価値があるよ。個人差はあるけど、多くの人が効果を実感してるんだ。\n\n💡見分け方: 「多くの研究で効果が示されている」かどうかを確認しよう。エビデンスの有無が判断のポイントだよ。`;
    } else if (statement.text.includes('完璧')) {
      // 正解が「誤り」で、「完璧」という文章の場合
      incorrectFeedback[incorrectIndex] = `やる気があるのは素晴らしいね！確かに${term.ja}は効果的な方法だよ。\n\nでも「一度で完璧」は誤りなんだ。どんな方法も、練習と時間が必要。最初はうまくいかなくても、それが普通。続けることで少しずつ上達していくんだよ。\n\n💡見分け方: 「すぐに完璧」「一度で効く」って言い切る表現には注意しよう。成長には時間がかかるんだ。`;
    } else {
      // 正解が「誤り」で、「普通の人には効かない」という文章の場合
      incorrectFeedback[incorrectIndex] = `自分を過小評価してるんじゃない？大丈夫、あなたもできるよ！\n\n${term.ja}は、特別な人じゃなくて、あなたのような「普通の人」こそが使える方法なんだ。研究でも、一般の人が使って効果があることが証明されてるよ。\n\n💡見分け方: 「特別な人じゃないと効かない」って思い込みに気をつけよう。科学的に効果が証明された方法は、誰でも使えるんだ。`;
    }

    return {
      id: `tf_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'truefalse',
      stem: `💭 あなたについての質問:\n\n❓ ${statement.text}`,
      choices: ['正しい（○）', '誤り（×）'],
      answer_index: statement.isTrue ? 0 : 1,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡心理療法の効果は「エビデンスレベル」で評価されるよ。多くの質の高い研究ほど信頼度が上がるんだ。`,
      tip: `🔍実践: 治療を選ぶ時は、「この方法は研究で効果が示されてる？」って質問してみよう。エビデンスを確認することが大事！`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '❓',
      difficulty: this.getDifficulty(),
      source_id: paper.id,
    };
  }

  // 4. 感情クイズ
  generateEmotionQuiz() {
    // Get current unit and situation
    const currentUnit = this.currentUnit || 'mental';
    const unitSituations = REAL_LIFE_SITUATIONS[currentUnit];

    if (!unitSituations || unitSituations.length === 0) {
      console.warn(`No situations found for unit: ${currentUnit}`);
      return null;
    }

    const situation = this.randomChoice(unitSituations);

    // Build choices from concrete actions
    const correctChoice = situation.concrete_actions[situation.correct_method];
    const wrongChoices = situation.wrong_methods.map(m => situation.concrete_actions[m]);

    const choices = [correctChoice, ...wrongChoices];
    this.shuffleArray(choices); // Shuffle so correct isn't always first
    const correctIndex = choices.indexOf(correctChoice);

    // Get method database entry
    const methodInfo = METHOD_DATABASE[situation.correct_method];
    if (!methodInfo) {
      console.warn(`No method info found for: ${situation.correct_method}`);
      return null;
    }

    // Generate detailed incorrect feedback
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== correctIndex) {
        const wrongMethod = Object.keys(situation.concrete_actions).find(
          key => situation.concrete_actions[key] === choice
        );

        incorrectFeedback[index] = this.makeDetailedFeedback(
          wrongMethod,
          situation.correct_method,
          situation
        );
      }
    });

    return {
      id: `emotion_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `${this.getEmotionEmoji(situation.emotion)} あなたの気持ち:\n\n${situation.setup}\n\nあなたは今、どうする？`,
      choices: choices,
      answer_index: correctIndex,

      // 5-element structure (NO "explanation" field!)
      what: methodInfo.what,
      why: methodInfo.why,
      how: methodInfo.how,
      real_example: methodInfo.real_example,
      action: methodInfo.action,

      fun_fact: `💡感情には「良い・悪い」はないよ。全ての感情は、何か大切なことを教えてくれるサインなんだ。`,
      tip: `🔍実践: 感情を感じたら、まず「今、自分は何を感じてる？」って名前をつけてみよう。感情に気づくことが、対処の第一歩だよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: this.getEmotionEmoji(situation.emotion),
      difficulty: 'easy',
      xp: situation.time_constraint === 'immediate' || situation.time_constraint === 'emergency' ? 15 : 10
    };
  }

  // 5. セラピスト役
  generateTherapistRole() {
    // Get current unit and situation
    const currentUnit = this.currentUnit || 'mental';
    const unitSituations = REAL_LIFE_SITUATIONS[currentUnit];

    if (!unitSituations || unitSituations.length === 0) {
      console.warn(`No situations found for unit: ${currentUnit}`);
      return null;
    }

    const situation = this.randomChoice(unitSituations);

    // Build choices from concrete actions for friend helping scenario
    const correctChoice = `「${situation.concrete_actions[situation.correct_method]}」と教える`;
    const wrongChoices = situation.wrong_methods.map(m =>
      `「${situation.concrete_actions[m]}」と教える`
    );

    const choices = [correctChoice, ...wrongChoices];
    this.shuffleArray(choices);
    const correctIndex = choices.indexOf(correctChoice);

    // Get method database entry
    const methodInfo = METHOD_DATABASE[situation.correct_method];
    if (!methodInfo) {
      console.warn(`No method info found for: ${situation.correct_method}`);
      return null;
    }

    // Generate detailed incorrect feedback
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== correctIndex) {
        const wrongMethod = situation.wrong_methods.find(m =>
          choice.includes(situation.concrete_actions[m])
        );

        incorrectFeedback[index] = `友達を助けようとする気持ちは素晴らしいね！${wrongMethod}も一つの方法だよ。\n\nでも、${situation.correct_method}の方がより効果的なんだ。友達に教える時は、科学的に効果が証明されている方法を勧めてあげると、もっと役に立てるよ。\n\n💡見分け方: 「その場しのぎ」より「根本的に効く方法」を教えてあげよう。`;
      }
    });

    return {
      id: `therapist_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `👥 あなたの友達の状況:\n\n${situation.setup}\n\n友達がこう言ってきた。\n「どうしたらいい？」\n\nあなたなら、どう答える？`,
      choices: choices,
      answer_index: correctIndex,

      // 5-element structure (NO "explanation" field!)
      what: methodInfo.what,
      why: methodInfo.why,
      how: methodInfo.how,
      real_example: methodInfo.real_example,
      action: methodInfo.action,

      fun_fact: `💡良いアドバイスは「教科書通り」じゃなく、目の前の人に合わせて柔軟に伝えるんだ。`,
      tip: `🔍実践: 友達に心理学のスキルを教える時は、まず自分が試してみよう。実体験があると、説得力が違うよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '👥',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 6. 研究批評
  generateResearchCritique() {
    const paper = this.randomChoice(this.sources);
    const flaws = [
      {
        text: 'サンプルサイズが小さすぎる（あなたへの適用に注意）',
        explanation: '少数のサンプルでは本当の効果を見逃す可能性が高く、あなたにも当てはまるとは限らない',
        incorrect_empathy: 'サンプルサイズを気にするのは素晴らしい視点だね！統計的検出力は確かに重要だよ。',
      },
      {
        text: '因果関係が証明できていない（あなたが使っても効くとは限らない）',
        explanation: '観察研究では「AとBに関連がある」ことは分かっても「AがBの原因」とは言えない。あなたが試しても同じ結果になるかは不明',
        incorrect_empathy: '因果関係と相関を区別しようとしているのは良いね！これは研究を読む時の重要なポイントだよ。',
      },
      {
        text: '再現性が確認されていない（あなたが信頼するには早い）',
        explanation: '一つの研究だけでは偶然の結果かもしれないから、複数の研究で確認が必要。あなたが今すぐ試すのはリスクがある',
        incorrect_empathy: '再現性に注目するのは科学的思考の証拠だね！確かに単一研究には限界があるよ。',
      },
      {
        text: 'バイアスの可能性がある（あなたに合うとは限らない）',
        explanation: '研究デザインによっては結果が歪んでいる可能性があり、あなたの状況には当てはまらないかもしれない',
        incorrect_empathy: 'バイアスを警戒するのは批判的思考の基本だね！研究の質を見極める良い視点だよ。',
      },
    ];

    const selectedFlaws = this.randomSample(flaws, 3);
    const correctFlaw = selectedFlaws[0];

    // Create 5-element structure for critical thinking
    const what = `【この研究の限界は】\nこの研究の主な限界は「${correctFlaw.text}」だよ。`;
    const why = `【なぜ重要？】\n\n${correctFlaw.explanation}んだ。研究を批判的に読むことは、あなた自身を守ることにつながるよ。`;
    const how = `【どう見分ける？】\n\n論文を読む時は、「Abstract（要約）」だけじゃなく「Methods（方法）」と「Limitations（限界）」のセクションも必ず確認しよう。`;
    const real_example = `【実際の例】\n\n「この研究、効果すごい！」って記事を見て飛びついた人が、実際に試したら全然効かなかった…なんてことはよくあるんだ。批判的に読む力が大事だよ。`;
    const action = `【今日から実践】\n\n次に「○○に効果！」って記事を見たら、「サンプル数は？」「因果関係は証明されてる？」「他の研究でも同じ結果？」って3つ質問してみよう。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    selectedFlaws.forEach((flaw, index) => {
      if (index !== 0) { // 正解（index 0）以外
        incorrectFeedback[index] = `${flaw.incorrect_empathy}\n\nでも、この研究では「${correctFlaw.text}」の方がより深刻な問題なんだ。${correctFlaw.explanation}からね。\n\n💡見分け方: 研究の最も重要な限界は、「あなたがこの結果を信頼して行動するかどうか」に最も大きく影響するものだよ。`;
      }
    });

    return {
      id: `critique_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `🔬 あなたが見つけた研究:\n\n📄「${paper.title.substring(0, 60)}...」\n\nあなたがこの研究を信頼する前に、まず確認すべき限界は？`,
      choices: selectedFlaws.map(f => f.text),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡「完璧な研究」は存在しないんだ。だからこそメタ分析（複数の研究を統合）が重要になるんだよ。`,
      tip: `🔍実践: 論文を読む時は、「どんな限界がある？」って考える習慣をつけよう。批判的思考力が鍛えられるよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '🔬',
      difficulty: 'hard',
      source_id: paper.id,
      xp: 20
    };
  }

  // 7. コンセプト応用
  generateConceptApplication() {
    // Get current unit and situation
    const currentUnit = this.currentUnit || 'mental';
    const unitSituations = REAL_LIFE_SITUATIONS[currentUnit];

    if (!unitSituations || unitSituations.length === 0) {
      console.warn(`No situations found for unit: ${currentUnit}`);
      return null;
    }

    const situation = this.randomChoice(unitSituations);

    // Build choices from concrete actions
    const correctChoice = situation.concrete_actions[situation.correct_method];
    const wrongChoices = situation.wrong_methods.map(m => situation.concrete_actions[m]);

    const choices = [correctChoice, ...wrongChoices];
    this.shuffleArray(choices);
    const correctIndex = choices.indexOf(correctChoice);

    // Get method database entry
    const methodInfo = METHOD_DATABASE[situation.correct_method];
    if (!methodInfo) {
      console.warn(`No method info found for: ${situation.correct_method}`);
      return null;
    }

    // Generate detailed incorrect feedback
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== correctIndex) {
        const wrongMethod = Object.keys(situation.concrete_actions).find(
          key => situation.concrete_actions[key] === choice
        );

        incorrectFeedback[index] = this.makeDetailedFeedback(
          wrongMethod,
          situation.correct_method,
          situation
        );
      }
    });

    return {
      id: `concept_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💡 あなたの状況:\n\n${situation.setup}\n\nこの時、あなたはどう対処する？`,
      choices: choices,
      answer_index: correctIndex,

      // 5-element structure (NO "explanation" field!)
      what: methodInfo.what,
      why: methodInfo.why,
      how: methodInfo.how,
      real_example: methodInfo.real_example,
      action: methodInfo.action,

      fun_fact: `💡心理学のスキルは「知識」じゃなくて「練習」で身につくんだ。スポーツと同じで、繰り返すことが大事！`,
      tip: `🔍実践: 新しいスキルを試す時は、「1日1回だけ」から始めよう。習慣化するには小さく始めることがポイントだよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '💡',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 8. データ解釈
  generateDataInterpretation() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);
    const percentage = 60 + Math.floor(Math.random() * 30);

    // Try to get method info from METHOD_DATABASE
    const methodKey = Object.keys(METHOD_DATABASE).find(key =>
      key.includes(therapy.ja) || therapy.ja.includes(key.split('（')[0])
    );
    const methodInfo = methodKey ? METHOD_DATABASE[methodKey] : null;

    const interpretations = [
      { text: `あなたも試す価値がある（${percentage}%に効果）`, isCorrect: true, incorrect_empathy: null },
      { text: `あなたには必ず効く（${percentage}%だから確実）`, isCorrect: false, incorrect_empathy: `${percentage}%という高い数字を見て、確実性を感じたんだね！確かに効果は大きいように見えるね。` },
      { text: `あなたの症状は完全に治る`, isCorrect: false, incorrect_empathy: '改善率が高いから、完治すると思ったんだね！効果に期待するのは自然な反応だよ。' },
    ];

    // ランダムサンプリングして不正解フィードバックを生成
    const selectedInterpretations = this.randomSample(interpretations, 3);
    const incorrectFeedback = {};
    selectedInterpretations.forEach((interp, index) => {
      if (index !== 0 && interp.incorrect_empathy) { // 正解（index 0）以外
        if (interp.text.includes('必ず効く')) {
          incorrectFeedback[index] = `${interp.incorrect_empathy}\n\nでも、${100 - percentage}%の人は改善しなかったということも忘れちゃいけないんだ。「あなたにも必ず効く」と「試す価値がある」は大きく違うよ。個人差があることを理解するのが大切なんだ。\n\n💡見分け方: 「必ず」「絶対」という言葉には注意しよう。科学では断定的な表現は避けるんだ。`;
        } else {
          incorrectFeedback[index] = `${interp.incorrect_empathy}\n\nでも、「改善」と「完治」は違うんだ。あなたの症状が軽くなることと、完全に治ることは別物だよ。研究データは慎重に解釈する必要があるんだ。\n\n💡見分け方: 「改善」は「良くなった」、「完治」は「治った」。この違いを意識しよう。`;
        }
      }
    });

    // Create 5-element structure
    const what = methodInfo?.what || `【この方法は】\n${therapy.ja}（${therapy.desc}）は、${percentage}%の人に効果があった方法だよ。`;
    const why = methodInfo?.why || `【なぜ効くの？】\n\n研究で効果が実証されているんだ。${percentage}%という数字は、多くの人に効果があることを示してるよ。`;
    const how = methodInfo?.how || `【やり方】\n\n専門家に相談しながら、あなたに合ったやり方を見つけていこう。`;
    const real_example = methodInfo?.real_example || `【みんなの体験談】\n\n「最初は半信半疑だったけど、続けたら効果を実感できた！」って声がたくさんあるよ。`;
    const action = methodInfo?.action || `【今すぐ試そう！】\n\nまずは専門家に相談してみよう。あなたにも効果があるかもしれないよ。`;

    return {
      id: `data_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `📊 あなたが見つけた研究結果:\n\n「${therapy.ja}で${percentage}%が改善」\n\nこれは、あなたにとって何を意味する？`,
      choices: selectedInterpretations.map(i => i.text),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡研究の「統計的有意差」と「臨床的な意味」は別物。数字だけじゃなくて、あなたの生活への影響を見ることが大事なんだ。`,
      tip: `🔍実践: 「${percentage}%が改善」って聞いたら、「改善ってどの程度？」「自分も当てはまる？」って質問してみよう。数字の背景を理解することが大切だよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '📊',
      difficulty: 'hard',
      xp: 20
    };
  }

  // 9. 倫理ジレンマ
  generateEthicalDilemma() {
    const dilemmas = [
      {
        setup: 'あなたの友人が「死にたい」と打ち明けてきた。\n「誰にも言わないで」と頼まれた。',
        question: 'あなたならどうする？',
        context: '守秘義務 vs 安全確保',
        emotion: '困惑・焦り',
      },
      {
        setup: 'あなたの同僚が「カウンセリング受けてるけど効果ない」と言っている。\nでも本人は「続けたい」と言う。',
        question: 'あなたならどうする？',
        context: '効果への疑問 vs 本人の満足',
        emotion: '迷い',
      },
      {
        setup: 'あなたの家族が「本人の意思に反してでも治療を受けさせたい」と相談してきた。',
        question: 'あなたならどう答える？',
        context: '家族の希望 vs 本人の自律性',
        emotion: '葛藤',
      },
    ];

    const dilemma = this.randomChoice(dilemmas);

    const choices = [
      { text: '守秘義務より安全を優先して、専門家に連絡する', incorrect_empathy: '友人の安全を第一に考えたんだね！安全確保は確かに重要な視点だよ。' },
      { text: '本人の意思を最優先して、何もしない', incorrect_empathy: '本人の自律性を尊重しようとしているんだね！友人の意思を大切にするのは大事だよ。' },
      { text: '自分で判断せず、まず心理の専門家に相談する', incorrect_empathy: null }, // 正解なので不要
    ];

    // 5-element structure
    const what = `【この方法は】\n\n「自分で判断せず、専門家に相談する」は、倫理的ジレンマでの正しい対応なんだ。`;

    const why = `🧠【なぜ正しいの？】\n\n倫理的な問題は「どれも正しい価値観」がぶつかるから難しいんだ。\n\n守秘義務、安全確保、本人の自律性…どれも大切。だからこそ、一人で抱え込まず、複数の視点（スーパービジョン）で考えることが推奨されてるよ。\n\n心理職には倫理ガイドラインがあって、「迷ったら相談」が基本なんだ。`;

    const how = `💪【やり方】\n\n1. **緊急性を判断**: 今すぐ危険があるか？\n2. **専門家に相談**: カウンセラー、医師、相談窓口\n3. **複数の視点で検討**: 一人で決めない\n4. **本人の利益を優先**: 誰のための決定か？\n\n💡 緊急時（今すぐ危険）は即座に専門家に連絡。そうでなければ、まず相談してから判断。`;

    const real_example = `🌟【みんなの体験談】\n\n「友人に『死にたい』と言われて、一人で抱え込んで苦しかった。\n\n学校のカウンセラーに相談したら、『あなたは正しいことをした』と言われた。\n\n友人は怒ったけど、後で『ありがとう』って言ってくれた。」\n\n— Yuki（19歳・学生）`;

    const action = `🔍【今すぐ覚えよう！】\n\n倫理的に迷ったら、この質問を自分にしてみて：\n\n1. 「この決定は誰のためになる？」\n2. 「今すぐ危険がある？」\n3. 「一人で決めていいこと？」\n\n答えが「分からない」なら、専門家に相談。\n\n📞 相談窓口:\n• いのちの電話: 0570-783-556\n• こころの健康相談: 全国の保健所`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== 2 && choice.incorrect_empathy) { // 正解（index 2）以外
        incorrectFeedback[index] = `${choice.incorrect_empathy}\n\nでも、倫理的なジレンマは「どれも正しい価値観」がぶつかるから難しいんだ。\n\n守秘義務、安全確保、本人の自律性…どれも大切だからこそ、専門家に相談して多角的に考える必要があるんだよ。\n\n一人で抱え込まないことが、最も倫理的な対応なんだ。\n\n💡見分け方: 「迷ったら相談」が倫理の基本。複雑な状況では、複数の視点が必要だよ。`;
      }
    });

    return {
      id: `ethics_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💭 あなたの状況:\n\n${dilemma.setup}\n\n⚖️ ${dilemma.question}`,
      choices: choices.map(c => c.text),
      answer_index: 2,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡心理職の倫理綱領では「迷ったら相談」が基本。一人で抱え込まないことが、相手を守ることにつながるんだ。`,
      tip: `🔍実践: 倫理的な判断に迷ったら、「この決定は誰のためになる？」って自分に問いかけてみよう。相手の利益を最優先に考えることが基本だよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '⚖️',
      difficulty: 'hard',
      xp: 20
    };
  }

  // 10. 研究バトル
  generateResearchBattle() {
    const papers = this.randomSample(this.sources, 2);
    const answerIndex = Math.random() < 0.5 ? 0 : 1;
    const winnerPaper = papers[answerIndex];
    const loserPaper = papers[answerIndex === 0 ? 1 : 0];

    // 5-element structure
    const what = `【この判断基準は】\n\n研究の質を見分ける力は、あなたが「信頼できる情報」を選ぶための必須スキルだよ。`;

    const why = `🧠【なぜ重要？】\n\nネットには「〜に効く！」って情報があふれてる。\n\nでも、その根拠となる研究の質はバラバラなんだ。\n\n質の高い研究を見分けられないと、あなたは効果のない方法に時間とお金を使うことになる。\n\n「査読済み」だけじゃ不十分。サンプル数、研究デザイン、バイアス対策を総合的に見ることが大切なんだ。`;

    const how = `💪【見分け方】\n\n1. **研究デザイン**: ランダム化試験 > 観察研究\n2. **サンプル数**: 多い方が信頼できる\n3. **追跡期間**: 長い方が実用的\n4. **バイアス対策**: 二重盲検など\n5. **再現性**: 複数の研究で確認されてるか\n\n今回は${answerIndex === 0 ? 'A' : 'B'}の方がこれらの点で優れてるよ。`;

    const real_example = `🌟【みんなの体験談】\n\n「ネットで『〜で痩せた！』って記事見て試したけど効果なし。\n\nよく見たら、研究はたった10人で追跡期間も1週間だった。\n\n今は『サンプル数は？期間は？』って確認するようになった。」\n\n— Taku（26歳・会社員）`;

    const action = `🔍【今すぐ使える！】\n\n次に「〜に効く！」って情報を見たら、\n\nこの3つを確認してみて：\n\n1. **何人で調べた？** → 100人以上が理想\n2. **どのくらいの期間？** → 数週間以上\n3. **どんな研究？** → ランダム化試験が最強\n\nこれだけでも、あなたは「怪しい情報」を避けられるよ。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    const incorrectIndex = answerIndex === 0 ? 1 : 0;
    incorrectFeedback[incorrectIndex] = `${answerIndex === 0 ? 'B' : 'A'}を選んだんだね！研究の質を見極めようとする姿勢は素晴らしいよ。\n\nでも、今回は${answerIndex === 0 ? 'A' : 'B'}の方がより厳密な研究デザインを使っているんだ。\n\n両方とも査読済みだけど、研究の質には差があるんだよ。サンプル数、方法論、バイアス対策などを総合的に見ることが大切なんだ。\n\n💡見分け方: タイトルだけじゃなく、研究デザイン（ランダム化試験か観察研究か等）やサンプル数を確認しよう。`;

    return {
      id: `battle_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'ab',
      stem: `💭 あなたの状況:\n\n不安を和らげる方法を探してる。\n2つの研究を見つけた。\n\n⚔️ どちらの研究をあなたは信頼する？\n\nA: 「${papers[0].title.substring(0, 45)}...」\n\nB: 「${papers[1].title.substring(0, 45)}...」`,
      choices: ['A の方が信頼できる', 'B の方が信頼できる'],
      answer_index: answerIndex,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡研究の信頼性は「査読済み」だけじゃ分からない。研究デザイン、サンプル数、バイアス対策などを総合的に見る必要があるんだ。`,
      tip: `🔍実践: 論文を比較する時は、「どっちの方法がより厳密？」「サンプル数は？」って具体的なポイントをチェックしよう。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '⚔️',
      difficulty: 'medium',
      xp: 15,
      source_id: papers[0].id,
    };
  }

  // 11. 限界発見
  generateLimitationFinder() {
    const paper = this.randomChoice(this.sources);
    const limitations = [
      {
        text: '横断研究なので因果関係は不明（相関のみ）',
        explanation: '一時点のデータだけでは、時間的な前後関係が分からないから因果は証明できない',
        incorrect_empathy: '因果関係に注目したのは良い視点だね！因果を証明できるかは重要なポイントだよ。',
      },
      {
        text: 'サンプルが偏っている可能性（選択バイアス）',
        explanation: '特定の集団だけを調査していると、一般化できない可能性がある',
        incorrect_empathy: 'サンプルの偏りを気にするのは鋭い視点だね！一般化可能性は確かに大事だよ。',
      },
      {
        text: '長期効果は未検証（追跡調査が必要）',
        explanation: '短期的には効果があっても、長期的に続くかは別の研究が必要',
        incorrect_empathy: '長期効果に注目するのは素晴らしいね！持続性は治療を考える上で重要だよ。',
      },
    ];

    const selectedLimitations = this.randomSample(limitations, 3);
    const correctLimitation = selectedLimitations[0];

    // Create 5-element structure
    const what = `【この研究の限界は】\n\nこの研究の限界は「${correctLimitation.text}」だよ。`;
    const why = `🧠【なぜあなたに関係ある？】\n\n${correctLimitation.explanation}んだ。あなたがこの研究を参考にする時、この限界を知らないと間違った判断をしてしまうかもしれないよ。`;
    const how = `💪【見分け方】\n\n論文を読む時は、「Limitations（限界）」のセクションを必ずチェック。研究者自身が「この研究では証明できないこと」を正直に書いているから、あなたの判断材料になるよ。`;
    const real_example = `🌟【実際の例】\n\n「この研究で効果があったから自分にも効く！」って思い込んだら、実際は自分の状況には当てはまらなかった…なんてことはよくあるんだ。限界を知ることで、現実的な期待を持てるよ。`;
    const action = `🔍【今すぐ試そう！】\n\n次に「○○に効果！」って記事を見たら、元の論文を探して「Limitations」のセクションを読んでみよう。その効果が本当にあなたに当てはまるか、冷静に判断できるようになるよ。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    selectedLimitations.forEach((limitation, index) => {
      if (index !== 0) { // 正解（index 0）以外
        incorrectFeedback[index] = `${limitation.incorrect_empathy}\n\nでも、この研究では「${correctLimitation.text}」の方がより大きな限界なんだ。${correctLimitation.explanation}からね。すべての研究には複数の限界があるけど、最も重要な限界を見極めることが大切なんだよ。\n\n💡見分け方: 「結果の解釈に最も影響する限界は何か」を考えてみよう。`;
      }
    });

    return {
      id: `limit_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💭 あなたが参考にしようとしている研究:\n\n📄「${paper.title.substring(0, 50)}...」\n\nあなたが判断する前に知るべき限界は？`,
      choices: selectedLimitations.map(l => l.text),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡良い研究者は自分の研究の限界を正直に書くんだ。「Limitations（制限事項）」セクションは論文の重要な部分だよ。`,
      tip: `🔍実践: 論文を読む時は、必ず「Limitations（限界）」のセクションを確認しよう。そこに書かれていることが、結果の解釈に重要なヒントになるよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '🔍',
      difficulty: 'hard',
      source_id: paper.id,
      xp: 20
    };
  }

  // 12. バイアス検出
  // 12. バイアス検出 (絵文字付き・改善版)
  generateBiasDetection() {
    const bias = this.randomChoice(BIASES);
    const otherBiases = this.randomSample(BIASES.filter(b => b.ja !== bias.ja), 2);
    const allChoices = [bias, ...otherBiases];

    // 改善: 選択肢に説明を追加
    const choicesWithDesc = allChoices.map(b => ({ text: `${b.ja}（${b.desc}）`, bias: b }));

    // Create 5-element structure
    const what = `【あなたが陥ったバイアスは】\n\nこれは「${bias.ja}」って言うんだ。${bias.desc}傾向のことだよ。`;
    const why = `🧠【なぜあなたに起きる？】\n\n人間の脳は効率的に判断するために、自動的にショートカットを使うんだ。でも、そのショートカットが時々あなたの判断を歪めちゃう。無意識にやっちゃうから、まず気づくことが大事！`;
    const how = `💪【対策】\n\n${bias.tip}\n\n自分の思考パターンに気づくことが第一歩。「あ、今バイアスに陥ってるかも」って気づけるだけで、判断の質がグッと上がるよ。`;
    const real_example = `🌟【実際の例】\n\n${bias.funFact}`;
    const action = `🔍【今すぐ試そう！】\n\n今日、何か判断する時に「自分、今バイアスに陥ってない？」って一度立ち止まってみよう。例えば買い物の時、恋愛の時、仕事の時…どんな場面でもこのバイアスは現れるよ。`;

    // ランダムサンプリングして不正解フィードバックを生成
    const selectedChoices = this.randomSample(choicesWithDesc, 3);
    const incorrectFeedback = {};
    selectedChoices.forEach((choice, index) => {
      if (index !== 0) { // 正解（index 0）以外
        incorrectFeedback[index] = `${choice.bias.ja}に注目したんだね！確かに${choice.bias.desc}パターンもよくあるバイアスだよ。\n\nでも、この状況は「${bias.ja}」なんだ。${bias.desc}傾向だね。バイアスは似ているものが多いから、状況に合わせて見分けることが大切なんだよ。\n\n💡見分け方: ${bias.tip}`;
      }
    });

    return {
      id: `bias_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💭 あなたの思考:\n\n「${bias.example}」\n\nあなたは何バイアスに陥ってる？`,
      choices: selectedChoices.map(c => c.text),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡${bias.funFact}`,
      tip: `🔍対策: ${bias.tip}`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: bias.emoji,
      difficulty: 'medium',
      xp: 15
    };
  }

  // 13. 治療マッチング
  generateTreatmentMatching() {
    const disorder = this.randomChoice(PSYCH_TERMS.disorders);
    const therapies = this.randomSample(PSYCH_TERMS.therapies, 3);

    // Create 5-element structure
    const what = `【あなたに適した治療法は】\n\n${disorder.ja}（症状: ${disorder.symptom}）には、${therapies[0].ja}（${therapies[0].desc}）が特に効果的だと研究で示されてるよ。`;
    const why = `🧠【なぜあなたに効くの？】\n\nこの組み合わせは科学的根拠が強いんだ。あなたの症状の特徴と治療法の特性が合っているから、効果が期待できるよ。もちろん個人差はあるけど、スタート地点としては最適な選択肢なんだ。`;
    const how = `💪【選び方】\n\n症状の特徴（例: 考え方の問題 vs 感情の問題）を見て、それに合った治療法を選ぼう。医師やカウンセラーに「私の症状には何が一番効果的？」って聞くのもいいよ。`;
    const real_example = `🌟【実際の例】\n\n「とりあえず薬」じゃなくて、自分の症状に合った治療法を選んだ人は、回復が早く、再発も少ない傾向があるんだ。あなたに合った方法を見つけることが大事だよ。`;
    const action = `🔍【今すぐ試そう！】\n\nもし今何か困っている症状があるなら、その症状名と「治療法」で検索してみよう。複数の選択肢があることが分かるはず。治療は一つだけじゃないから、あなたに合う方法を探してみよう。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    therapies.forEach((therapy, index) => {
      if (index !== 0) { // 正解（index 0）以外
        incorrectFeedback[index] = `${therapy.ja}（${therapy.desc}）を選んだんだね！これも効果的な治療法だよ。\n\nでも、${disorder.ja}（${disorder.symptom}）には、${therapies[0].ja}（${therapies[0].desc}）の方がより適しているんだ。症状の特徴と治療法の特性を照らし合わせると、相性の良い組み合わせがあるんだよ。\n\n💡見分け方: 症状の特徴（例: 考え方の問題 vs 感情の問題）を見て、それに合った治療法を選ぼう。`;
      }
    });

    return {
      id: `match_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💭 あなたの症状:\n\n${disorder.symptom}\n\nあなたに最も適した治療法は？`,
      choices: therapies.map(t => `${t.ja}（${t.desc}）`),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡実際の臨床では、複数の治療法を組み合わせる「統合的アプローチ」が主流になってきてるんだ。`,
      tip: `🔍実践: 治療を受ける時は、「他の方法と組み合わせることもできる？」って聞いてみよう。複数のアプローチを使うことで、効果が高まることもあるよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '🎯',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 14. 穴埋め (clozeN)
  generateCloze() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);
    const disorder = this.randomChoice(PSYCH_TERMS.disorders);

    const templates = [
      { text: '🔤 ［1］は［2］に効果がある', key: { '1': therapy.ja, '2': disorder.ja } },
      { text: '🔤 ［1］の症状には［2］が有効', key: { '1': disorder.ja, '2': therapy.ja } },
    ];

    const template = this.randomChoice(templates);
    const wrongTherapy = this.randomChoice(PSYCH_TERMS.therapies.filter(t => t.ja !== therapy.ja));
    const wrongDisorder = this.randomChoice(PSYCH_TERMS.disorders.filter(d => d.ja !== disorder.ja));

    // Create 5-element structure
    const what = `【あなたが覚えるべき組み合わせ】\n\n正解は「${therapy.ja}」と「${disorder.ja}」だよ。${therapy.ja}（${therapy.desc}）は、${disorder.ja}（症状: ${disorder.symptom}）に対して科学的に効果が確認されてるんだ。`;
    const why = `🧠【なぜあなたに必要？】\n\nこの基本的な組み合わせを知っていると、もし自分や大切な人が困った時に、「どんな選択肢があるか」がすぐに分かるようになるよ。治療の知識は、あなたの人生を守る武器になるんだ。`;
    const how = `💪【覚え方】\n\n治療法と症状の特徴を照らし合わせて、「どっちがより合うか」を考えてみよう。例えば、「考え方の問題」には「考え方を変える治療」、「感情の問題」には「感情を扱う治療」って感じで覚えるとラクだよ。`;
    const real_example = `🌟【実際の例】\n\n友達が「最近調子悪い」って言った時、あなたが「こういう治療法もあるよ」って教えてあげられる。知識があるだけで、誰かを助けられる可能性が生まれるんだ。`;
    const action = `🔍【今すぐ試そう！】\n\n今覚えた組み合わせを、ノートかスマホのメモアプリに書き留めてみよう。「${therapy.ja} → ${disorder.ja}」って。後で見返すと、記憶が定着するよ。`;

    // 不正解フィードバックを生成（clozeN型用）
    // Note: clozeN問題では、各空欄に対して不正解フィードバックを提供
    const incorrectFeedback = {
      '1': `良い組み合わせを考えようとしているね！でも、${template.key['1']}の方が正しいんだ。${template.key['1']}と${template.key['2']}は、研究で効果が確認されている組み合わせなんだよ。\n\n💡見分け方: 治療法と症状の特徴を照らし合わせて、「どっちがより合うか」を考えてみよう。`,
      '2': `良い選択を考えているね！でも、${template.key['2']}の方が正しいんだ。${template.key['1']}と${template.key['2']}は、科学的根拠のある組み合わせなんだよ。\n\n💡見分け方: 治療法の特性と症状の特徴を結びつけて考えてみよう。基本的な組み合わせを覚えておくと役立つよ。`
    };

    return {
      id: `cloze_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'clozeN',
      text: template.text,
      bank: [therapy.ja, disorder.ja, wrongTherapy.ja, wrongDisorder.ja].slice(0, 4),
      key: template.key,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡治療法と障害の組み合わせは「教科書的な正解」があるけど、実際は一人ひとりに合わせてカスタマイズするんだ。`,
      tip: `🔍実践: 基本的な組み合わせを覚えておくと、治療の選択肢を理解しやすくなるよ。でも「教科書通り」が絶対じゃないことも覚えておこう。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '🔤',
      difficulty: 'easy',
      xp: 10
    };
  }

  // 15. ビフォー・アフター問題 (新規)
  generateBeforeAfter() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);
    const disorder = this.randomChoice(PSYCH_TERMS.disorders);

    const beforeScore = 20 + Math.floor(Math.random() * 15); // 20-35点
    const improvement = 10 + Math.floor(Math.random() * 10); // 10-20点改善
    const afterScore = beforeScore - improvement;

    const beforeSleep = 4 + Math.floor(Math.random() * 2); // 4-6時間
    const afterSleep = 6 + Math.floor(Math.random() * 2); // 6-8時間

    const exp = EXPLANATIONS.individual_difference();

    const choices = [
      { text: `あなたには${therapy.ja}が効果があった`, incorrect_empathy: null }, // 正解なので不要
      { text: `${therapy.ja}は必ず効く`, incorrect_empathy: 'これだけ改善したから、効果が確実だと思ったんだね！確かに大きな変化があるね。' },
      { text: `偶然良くなっただけ`, incorrect_empathy: '慎重に考えようとしているのは良いことだね！確かに偶然の可能性も考慮することは大事だよ。' },
    ];

    // Create 5-element structure
    const what = `【あなたの変化は】\n\nあなたには${therapy.ja}が効果があったんだ。12週間で、スコアも睡眠時間も改善している。これは偶然じゃなく、治療の効果だと考えられるよ。`;
    const why = `🧠【なぜ効いたの？】\n\n${therapy.ja}（${therapy.desc}）は、${disorder.ja}（症状: ${disorder.symptom}）に対して科学的に効果が証明されている方法なんだ。あなたの症状と治療法の相性が良かったから、こんなに改善したんだよ。`;
    const how = `💪【他の人にも効く？】\n\n「あなたには効果があった」ことは確かだけど、「誰にでも必ず効く」わけじゃないんだ。治療効果には個人差があるからね。でも、同じ症状の人には試してみる価値はあるよ。`;
    const real_example = `🌟【実際の例】\n\n「私にはこれが効いた！」って友達に勧めても、その友達には効かないこともあるんだ。だから「私の場合はね」って前置きするのが大事だよ。`;
    const action = `🔍【今すぐ試そう！】\n\nもし今何かの治療を試しているなら、「治療前」と「治療後」の変化を記録してみよう。スコアだけじゃなく、睡眠時間や食欲、気分など複数の指標を見ることで、本当に効果があるか分かるよ。`;

    // 不正解フィードバックを生成
    const incorrectFeedback = {};
    choices.forEach((choice, index) => {
      if (index !== 0 && choice.incorrect_empathy) { // 正解（index 0）以外
        if (choice.text.includes('必ず効く')) {
          incorrectFeedback[index] = `${choice.incorrect_empathy}\n\nでも、これは「あなたには効果があった」ということで、「誰にでも必ず効く」わけじゃないんだ。一人のケースから一般化はできないよ。効果には個人差があるから、あなたには効果があったけど、別の人には効かないこともあるんだ。\n\n💡見分け方: 一人のデータは「可能性」を示すけど、「保証」ではないんだ。`;
        } else {
          incorrectFeedback[index] = `${choice.incorrect_empathy}\n\nでも、12週間という期間で、スコアも睡眠時間も改善しているから、${therapy.ja}の効果があった可能性が高いんだ。「偶然」だけではここまでの変化は説明しにくいよ。複数の指標が改善しているのがポイントなんだ。\n\n💡見分け方: 複数の指標が一貫して改善している時は、治療効果の可能性が高いよ。`;
        }
      }
    });

    return {
      id: `beforeafter_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💭 あなたが試した結果:\n\n【治療前】\n${disorder.ja}スコア: ${beforeScore}点（重度）\n睡眠時間: ${beforeSleep}時間\n\n【治療後（12週間の${therapy.ja}）】\n${disorder.ja}スコア: ${afterScore}点（軽度）\n睡眠時間: ${afterSleep}時間\n\nあなたの変化をどう解釈する？`,
      choices: choices.map(c => c.text),
      answer_index: 0,

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: exp.fun_fact,
      tip: `🔍実践: ビフォー・アフターのデータを見る時は、「どのくらいの期間で？」「他にも変化はある？」って視点を持とう。全体像を見ることが大事だよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '📊',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 16. ランキング (rank)
  generateRank() {
    const items = this.randomSample(PSYCH_TERMS.therapies, 3);
    const disorder = this.randomChoice(PSYCH_TERMS.disorders);

    // Create 5-element structure
    const what = `【あなたの症状に効く順位は】\n\n${disorder.ja}に対する効果の大きさは、以下の順だよ：\n\n1位: ${items[0].ja}（${items[0].desc}）\n2位: ${items[1].ja}（${items[1].desc}）\n3位: ${items[2].ja}（${items[2].desc}）`;
    const why = `🧠【なぜあなたに必要？】\n\nこれは複数の研究をまとめたメタ分析のデータに基づいてるんだ。もしあなたが${disorder.symptom}で困っているなら、まず1位の方法から試すのが効率的だよ。`;
    const how = `💪【選び方】\n\nこれはあくまで「平均的な効果」だから、個人によって合う・合わないがあるんだ。1位が効かなくても、2位や3位があなたには合うこともある。だから「ランキング1位＝あなたに絶対効く」じゃないんだよ。`;
    const real_example = `🌟【実際の例】\n\n「1位の治療を受けたけどイマイチ…」って人が、2位の治療に変えたら劇的に改善することもあるんだ。ランキングは「スタート地点」として参考にして、自分に合う方法を見つけることが大事だよ。`;
    const action = `🔍【今すぐ試そう！】\n\nもし今何かの症状で困っているなら、その症状名と「治療法 ランキング」で検索してみよう。科学的に効果が証明されている方法の順位が分かるはず。それを参考に、自分に合う方法を探してみよう。`;

    // 不正解フィードバックを生成（rank型用）
    // Note: rank問題では、順序が間違っている時の一般的なフィードバックを提供
    const incorrectFeedback = {
      general: `順序を考えようとしているのは素晴らしいね！治療法の効果を比較するのは重要だよ。\n\nでも、正しい順序は以下だよ：\n1位: ${items[0].ja}\n2位: ${items[1].ja}\n3位: ${items[2].ja}\n\nこれは複数の研究をまとめたメタ分析のデータに基づいているよ。ただし、これは「平均的な効果」だから、個人によっては順位が変わることもあるんだ。\n\n💡見分け方: 効果の大きさは研究データを参考にしつつ、「自分に合うか」も考えることが大切だよ。`
    };

    return {
      id: `rank_you_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'rank',
      stem: `💭 あなたの状況:\n\n${disorder.symptom}で困ってる。\n\n🏆 あなたにとって効果が高い順に並べよう\n（研究データより）`,
      items: items.map(t => `${t.ja}（${t.desc}）`),
      correct_order: [0, 1, 2],

      // 5-element structure (NO "explanation" field!)
      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡メタ分析って、複数の研究結果をまとめて分析する方法だよ。一つの研究より信頼度が高いんだ。`,
      tip: `🔍実践: 効果の順位を見る時は、「自分の状況に一番合うのはどれ？」って考えてみよう。ランキング1位が必ずしもあなたに最適とは限らないよ。`,
      incorrect_feedback: incorrectFeedback,
      emoji_hint: '🏆',
      difficulty: 'hard',
      xp: 20
    };
  }

  // 17. タイムライン (timeline) - 治療プロセスの順序
  generateTimeline() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);

    // 一般的な治療ステップ（CBTを例に）
    const steps = [
      'アセスメント（現状把握）',
      '目標設定（どうなりたいか）',
      '介入（実際の練習）',
      'フォローアップ（定着確認）'
    ];

    const what = `【${therapy.ja}の治療ステップ】\n\n正しい順序は：\n1. ${steps[0]}\n2. ${steps[1]}\n3. ${steps[2]}\n4. ${steps[3]}\n\nこの順番で進めることで、効果的な治療ができるんだ。`;
    const why = `🧠【なぜこの順番？】\n\nまず「今どんな状態？」を知らないと、目標も立てられないよね。そして目標がないまま練習しても、何のためにやってるか分からなくなる。だから順序が大事なんだ。`;
    const how = `💪【見分け方】\n\n治療の流れは「現状→目標→練習→確認」の順が基本。料理と同じで、材料を見て→レシピを決めて→調理して→味見する、って感じだよ。`;
    const real_example = `🌟【実際の例】\n\n焦って「とにかく練習！」と始めた人より、ちゃんとアセスメントから順を追った人の方が、効果が持続するんだ。急がば回れってことだね。`;
    const action = `🔍【今すぐ試そう！】\n\n何か新しいことを始める時、この4ステップを意識してみよう。「今の自分→目標→練習→振り返り」の順で考えると、うまくいきやすいよ。`;

    return {
      id: `timeline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'sort_order',  // 既存の並び替えUIを使用
      stem: `${therapy.ja}の治療ステップを正しい順番に並べよう`,
      items: [...steps],  // コピーして渡す
      correct_order: [0, 1, 2, 3],

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡ほとんどの治療法は、この「アセスメント→目標→介入→フォローアップ」の流れを基本にしてるんだ。`,
      tip: `🔍実践: 何か問題を解決する時、焦らず順を追うことで、結果的に早く解決できることが多いよ。`,
      incorrect_feedback: {},
      emoji_hint: '📋',
      difficulty: 'easy',
      xp: 10
    };
  }

  // 18. 症状チェックリスト (symptom_checklist) - 複数症状の識別
  generateSymptomChecklist() {
    const disorder = this.randomChoice(PSYCH_TERMS.disorders);

    // 症状の例（実際にはもっと詳細なデータベースが必要）
    const allSymptoms = [
      '気分の落ち込み',
      '不安感',
      '睡眠障害',
      '食欲の変化',
      '集中困難',
      '疲労感',
      'イライラ',
      '回避行動'
    ];

    // ランダムに4つ選び、そのうち2つが正解
    const selectedSymptoms = this.randomSample(allSymptoms, 4);
    const correctIndices = [0, 2];  // 簡易版

    const what = `【${disorder.ja}の典型的な症状】\n\n主な症状は：${selectedSymptoms.filter((_, i) => correctIndices.includes(i)).join('、')}\n\nこれらが${disorder.symptom}の特徴的なサインだよ。`;
    const why = `🧠【なぜ複数？】\n\n症状は一つだけじゃなく、複数組み合わさって現れることが多いんだ。だから「チェックリスト」形式で確認するのが診断の基本だよ。`;
    const how = `💪【見分け方】\n\n似た症状でも、組み合わせで診断名が変わることがある。だから専門家は複数の症状を総合的に見て判断するんだ。`;
    const real_example = `🌟【実際の例】\n\n「不安感」だけなら色んな原因がありえるけど、「不安感＋回避行動＋過度な心配」が揃うと、不安症の可能性が高くなる、って感じだね。`;
    const action = `🔍【今すぐ試そう！】\n\nもし気になる症状があったら、一つだけじゃなく「他にも何かある？」と複数チェックしてみよう。それを専門家に伝えると、より正確な診断につながるよ。`;

    return {
      id: `symptom_checklist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'select_all',  // 既存の複数選択UIを使用
      stem: `${disorder.ja}の典型的な症状を全て選ぼう`,
      choices: selectedSymptoms,
      answer_index: correctIndices[0],  // 互換性のため
      correct_answers: correctIndices,

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡精神科医は、DSM-5という診断基準マニュアルを使って、症状のチェックリストから診断を行うんだ。`,
      tip: `🔍実践: 自分の状態を記録する時、症状を箇条書きにしておくと、医師に伝えやすくなるよ。`,
      incorrect_feedback: {},
      emoji_hint: '✅',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 19. メカニズム説明 (mechanism) - なぜ効くのか
  generateMechanism() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);

    const mechanisms = [
      '脳の神経回路を変化させる',
      '気持ちを切り替えるスキルを身につける',
      'ストレスホルモンを減らす'
    ];

    const correctIndex = 1;  // 簡易版（実際にはtherapyに応じて変える）

    const what = `【${therapy.ja}が効く理由】\n\n${mechanisms[correctIndex]}\n\nこれが${therapy.ja}の主なメカニズムだよ。`;
    const why = `🧠【なぜ理解が大事？】\n\n「なぜ効くのか」が分かると、続ける motivation が上がるんだ。「ただやれって言われたから」より「こういう仕組みで効くんだ」って理解した方が、効果も高まるよ。`;
    const how = `💪【仕組みの種類】\n\n治療法のメカニズムは大きく3つ：①脳を変える、②スキルを学ぶ、③体を変える。${therapy.ja}は主に「②スキルを学ぶ」タイプだね。`;
    const real_example = `🌟【実際の例】\n\n「なぜこれをやるのか」を理解してた人は、理解してなかった人より、治療完了率が2倍高かったって研究があるんだ。`;
    const action = `🔍【今すぐ試そう！】\n\n何か新しい習慣を始める時、「なぜこれが効くのか？」を調べてみよう。仕組みを理解すると、続けやすくなるよ。`;

    return {
      id: `mechanism_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',  // 既存の3択UIを使用
      stem: `${therapy.ja}が効果を発揮するメカニズムは？`,
      choices: mechanisms,
      answer_index: correctIndex,

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡最新の脳科学研究で、心理療法が実際に脳の構造を変えることが分かってきたんだ。`,
      tip: `🔍実践: 新しいスキルを学ぶ時、「これで自分の脳がどう変わる？」って想像すると、やる気が出るよ。`,
      incorrect_feedback: {},
      emoji_hint: '⚙️',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 20. 禁忌・注意点 (contraindication) - 使ってはいけない時
  generateContraindication() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);

    const situations = [
      '急性期で症状が重すぎる時',
      '軽度の症状で日常生活に支障がない時',
      '他の治療法を試した後'
    ];

    const correctIndex = 0;  // 簡易版

    const what = `【${therapy.ja}を避けるべき時】\n\n${situations[correctIndex]}\n\nこういう時は、${therapy.ja}は適さないか、慎重な判断が必要だよ。`;
    const why = `🧠【なぜダメなの？】\n\n治療法には「適用範囲」があるんだ。万能薬はないからね。症状が重すぎる時は、まず薬物療法で症状を安定させてから、心理療法に入る方が安全なこともあるよ。`;
    const how = `💪【見分け方】\n\n「今すぐ危険」「日常生活が崩壊」レベルなら、まず薬や入院。「生活はできるけど辛い」レベルなら、心理療法がマッチしやすいよ。`;
    const real_example = `🌟【実際の例】\n\n重度のうつ病の人に、いきなり「考え方を変えよう」って言っても、「考える余裕すらない」んだ。まず薬で症状を和らげてから、CBTに移行する方が効果的だよ。`;
    const action = `🔍【今すぐ試そう！】\n\nもし自分や誰かが治療を受ける時、「この治療法は今の状態に合ってる？」って確認しよう。専門家に「なぜこの治療法？」って聞くのも大事だよ。`;

    return {
      id: `contraindication_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `${therapy.ja}を使うべきでない状況は？`,
      choices: situations,
      answer_index: correctIndex,

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡医学では「禁忌（きんき）」って言うんだ。「絶対ダメ」な場合と「慎重に」な場合があるよ。`,
      tip: `🔍実践: 治療を始める前に「どんな時に向かない？」を知っておくと、安全に使えるよ。`,
      incorrect_feedback: {},
      emoji_hint: '⚠️',
      difficulty: 'hard',
      xp: 20
    };
  }

  // 21. 対象者マッチング (population_match) - 誰に最適か
  generatePopulationMatch() {
    const therapy = this.randomChoice(PSYCH_TERMS.therapies);

    const populations = [
      '10代の若者',
      '60代以上の高齢者',
      '働き盛りの30-40代'
    ];

    const correctIndex = Math.floor(Math.random() * 3);  // ランダム（簡易版）

    const what = `【${therapy.ja}が最適な人】\n\n${populations[correctIndex]}\n\nこの年代・状況の人に、特に効果が高いことが研究で示されているよ。`;
    const why = `🧠【なぜ対象が違う？】\n\n年齢や生活状況で、抱える問題も違うし、学習スタイルも違うからね。若者には「スマホアプリ」、高齢者には「対面で丁寧に」みたいに、合わせる必要があるんだ。`;
    const how = `💪【選び方】\n\n自分の年齢・状況に合った治療法を選ぶと、続けやすいし、効果も高いよ。「みんながやってるから」じゃなくて、「自分に合ってるか」を考えよう。`;
    const real_example = `🌟【実際の例】\n\n60代の人に「SNSで記録しよう」って言っても難しいけど、「日記に書こう」なら続けられる。逆に10代には「アプリで」の方が続くよね。`;
    const action = `🔍【今すぐ試そう！】\n\n何か新しいことを始める時、「これ、自分の年齢・生活スタイルに合ってる？」って考えてみよう。合ってないと続かないからね。`;

    return {
      id: `population_match_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `${therapy.ja}が特に効果的なのはどの年代？`,
      choices: populations,
      answer_index: correctIndex,

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡最近は「年齢別ガイドライン」が出てきて、年代ごとに推奨される治療法が変わることが明確になってきたんだ。`,
      tip: `🔍実践: 治療法を選ぶ時、「この方法、自分の年代に合ってる？」ってチェックしよう。`,
      incorrect_feedback: {},
      emoji_hint: '👥',
      difficulty: 'medium',
      xp: 15
    };
  }

  // 22. 用量・頻度 (dosage) - 適切な実施量
  generateDosage() {
    const concept = this.randomChoice(PSYCH_TERMS.concepts);

    const dosages = [
      '毎日5分',
      '週1回30分',
      '月1回2時間'
    ];

    const correctIndex = 0;  // 簡易版（実際にはconceptに応じて変える）

    const what = `【${concept.ja}の推奨頻度】\n\n${dosages[correctIndex]}\n\nこれくらいの頻度で続けると、効果が出やすいことが研究で分かってるよ。`;
    const why = `🧠【なぜ頻度が大事？】\n\n「たまに長時間」より「毎日短時間」の方が、習慣化しやすいし、脳の変化も起きやすいんだ。筋トレと同じで、続けることが大事だよ。`;
    const how = `💪【見分け方】\n\n「毎日できるくらい短く」が基本。週1回30分より、毎日5分の方が効果が高いことが多いよ。続けられる量が、正しい量だね。`;
    const real_example = `🌟【実際の例】\n\nマインドフルネス瞑想は、「週1回1時間」より「毎日5分」の方が、ストレス軽減効果が高かったって研究があるんだ。`;
    const action = `🔍【今すぐ試そう！】\n\n何か新しい習慣を始める時、「毎日できる最小限」から始めよう。5分でもいいから、毎日続けることが大事だよ。`;

    return {
      id: `dosage_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `${concept.ja}のスキルを身につけるには、どれくらいの頻度が推奨？`,
      choices: dosages,
      answer_index: correctIndex,

      what: what,
      why: why,
      how: how,
      real_example: real_example,
      action: action,

      fun_fact: `💡脳科学的には、「毎日の小さな練習」が神経回路を強化するのに最も効果的なんだ。`,
      tip: `🔍実践: 新しいスキルは「毎日5分」から。完璧にやろうとせず、続けることを優先しよう。`,
      incorrect_feedback: {},
      emoji_hint: '⏰',
      difficulty: 'easy',
      xp: 10
    };
  }

  // -------------------- メイン生成関数 --------------------

  generate_question(type = null) {
    const generators = {
      scenario: () => this.generateScenario(),
      whichone: () => this.generateWhichOne(),
      truefalse: () => this.generateTrueFalse(),
      emotion: () => this.generateEmotionQuiz(),
      therapist: () => this.generateTherapistRole(),
      critique: () => this.generateResearchCritique(),
      concept: () => this.generateConceptApplication(),
      data: () => this.generateDataInterpretation(),
      ethics: () => this.generateEthicalDilemma(),
      battle: () => this.generateResearchBattle(),
      limit: () => this.generateLimitationFinder(),
      bias: () => this.generateBiasDetection(),
      match: () => this.generateTreatmentMatching(),
      cloze: () => this.generateCloze(),
      beforeafter: () => this.generateBeforeAfter(),
      rank: () => this.generateRank(),
      timeline: () => this.generateTimeline(),
      symptom_checklist: () => this.generateSymptomChecklist(),
      mechanism: () => this.generateMechanism(),
      contraindication: () => this.generateContraindication(),
      population_match: () => this.generatePopulationMatch(),
      dosage: () => this.generateDosage(),
    };

    if (type && generators[type]) {
      return generators[type]();
    }

    // ランダム選択
    const types = Object.keys(generators);
    const selectedType = this.randomChoice(types);
    return generators[selectedType]();
  }

  generate_lesson(unit = 'mental', size = 15) {
    const questions = [];

    // 難易度配分を事前に決定（Easy 40%, Medium 40%, Hard 20%）
    const difficulties = [];
    const easyCount = Math.floor(size * 0.4);
    const mediumCount = Math.floor(size * 0.4);
    const hardCount = size - easyCount - mediumCount;

    for (let i = 0; i < easyCount; i++) difficulties.push('easy');
    for (let i = 0; i < mediumCount; i++) difficulties.push('medium');
    for (let i = 0; i < hardCount; i++) difficulties.push('hard');

    // シャッフルして順番をランダムに
    for (let i = difficulties.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [difficulties[i], difficulties[j]] = [difficulties[j], difficulties[i]];
    }

    console.log(`📝 レッスン生成中: ${size}問 (Easy: ${easyCount}, Medium: ${mediumCount}, Hard: ${hardCount})`);

    // 各難易度に対して問題を生成
    for (let i = 0; i < size; i++) {
      const targetDifficulty = difficulties[i];
      let attempts = 0;
      let question = null;

      // 最大10回まで試行（指定難易度の問題が生成されるまで）
      while (attempts < 10 && (!question || question.difficulty !== targetDifficulty)) {
        question = this.generate_question();
        if (question) {
          question.difficulty = targetDifficulty; // 強制的に難易度を設定
        }
        attempts++;
      }

      if (question) {
        // XPフィールドを追加
        question.xp = this.getXpForDifficulty(targetDifficulty);
        questions.push(question);
        console.log(`  ✓ 問題${i + 1}/${size} 生成完了 (難易度: ${targetDifficulty}, XP: ${question.xp})`);
      } else {
        // フォールバック: 問題生成に失敗した場合はシンプルな問題を生成
        console.log(`  ⚠️ 問題${i + 1}/${size} 生成失敗 → フォールバック問題を使用`);
        questions.push(this.createFallbackQuestion(targetDifficulty, i + 1));
      }
    }

    console.log(`✅ レッスン生成完了: ${questions.length}問`);

    // 念のため確認
    if (questions.length !== size) {
      console.error(`⚠️ 警告: 期待される問題数(${size})と実際の問題数(${questions.length})が一致しません`);
    }

    return questions;
  }

  // フォールバック問題生成
  createFallbackQuestion(difficulty, questionNum) {
    const concepts = this.randomSample(PSYCH_TERMS.concepts, 3);

    return {
      id: `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'mcq3',
      stem: `💡 心理学で大切なことは？`,
      choices: concepts.map(c => c.ja),
      answer_index: 0,
      explanation: `${concepts[0].ja}は重要な概念だよ。${concepts[0].effect}することで、心の健康を保つことができるんだ。`,
      fun_fact: `💡どれも大切だけど、特に${concepts[0].ja}は多くの研究で効果が証明されているよ！`,
      tip: `🔍実践: 心理学のスキルは日常生活で実践してこそ身につくもの。今日から一つでも試してみよう！`,
      emoji_hint: '🧠',
      difficulty: difficulty,
      xp: this.getXpForDifficulty(difficulty),
    };
  }

  generate_node(unit = 'mental', node_num = 1) {
    const lessonSize = 15;
    const lesson = this.generate_lesson(unit, lessonSize);

    return {
      node: node_num,
      unit: unit,
      size: lessonSize,
      questions: lesson,
    };
  }
}

// ================== CLI メイン処理 ==================

async function main() {
  const args = process.argv.slice(2);
  const command = args[0] || 'help';

  // データ読み込み
  const sourcesPath = path.join(process.cwd(), 'data', 'sources.json');
  const sources = JSON.parse(fs.readFileSync(sourcesPath, 'utf-8'));

  const generator = new ProblemGenerator(sources);

  switch (command) {
    case 'question': {
      const type = args[1];
      const q = generator.generate_question(type);
      console.log(JSON.stringify(q, null, 2));
      break;
    }

    case 'lesson': {
      const unit = args[1] || 'mental';
      const size = parseInt(args[2]) || 15;
      const lesson = generator.generate_lesson(unit, size);
      console.log(JSON.stringify(lesson, null, 2));
      break;
    }

    case 'node': {
      const unit = args[1] || 'mental';
      const nodeNum = parseInt(args[2]) || 1;
      const node = generator.generate_node(unit, nodeNum);

      const outputDir = path.join(process.cwd(), 'data', 'lessons_variety');
      if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
      }

      const filename = `${unit}_l${String(nodeNum).padStart(2, '0')}.json`;
      const outputPath = path.join(outputDir, filename);
      fs.writeFileSync(outputPath, JSON.stringify(node.questions, null, 2));
      console.log(`✓ Generated: ${outputPath}`);
      break;
    }

    case 'all': {
      const units = ['mental', 'work', 'study', 'health', 'social', 'money'];
      const nodesPerUnit = 6;

      for (const unit of units) {
        for (let i = 1; i <= nodesPerUnit; i++) {
          const node = generator.generate_node(unit, i);

          const outputDir = path.join(process.cwd(), 'data', 'lessons_variety');
          if (!fs.existsSync(outputDir)) {
            fs.mkdirSync(outputDir, { recursive: true });
          }

          const filename = `${unit}_l${String(i).padStart(2, '0')}.json`;
          const outputPath = path.join(outputDir, filename);
          fs.writeFileSync(outputPath, JSON.stringify(node.questions, null, 2));
          console.log(`✓ Generated: ${outputPath}`);
        }
      }

      console.log(`\n✅ Complete! Generated ${units.length * nodesPerUnit} lessons.`);
      break;
    }

    default:
      console.log(`
Psycle問題自動生成システム

使い方:
  node auto_generate_problems.mjs question [type]     # 1問だけ生成
  node auto_generate_problems.mjs lesson [unit] [size] # レッスン生成
  node auto_generate_problems.mjs node [unit] [num]    # ノード生成
  node auto_generate_problems.mjs all                  # 全ユニット生成

問題タイプ:
  scenario, whichone, truefalse, emotion, therapist,
  critique, concept, data, ethics, battle, limit,
  bias, match, cloze, rank

例:
  node auto_generate_problems.mjs question scenario
  node auto_generate_problems.mjs lesson mental 15
  node auto_generate_problems.mjs node work 1
  node auto_generate_problems.mjs all
      `);
  }
}

main().catch(console.error);
