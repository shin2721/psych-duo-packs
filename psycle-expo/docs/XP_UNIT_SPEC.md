# XP体感集約 & ユニット進行 仕様書

> **ステータス**: 仕様固定済み（来週実装予定）  
> **目的**: Duolingo体感を強め、executed中心の北極星に寄せる

---

## 1. XP設計（案A：レッスン完了時集約）

### 仕様
- XP付与・演出は **レッスン完了時に1回だけ**
- 問題中はXPを増やさない（内部カウントはOK）

### 完了画面の表示
```
+65 XP（大きく）

内訳（小さく）：
 • 完了    +20
 • 正解率  +20
 • 実行    +25 ← executedがある時だけ
```

### XP配点（config/gamification.json）
| 項目 | 値 | 条件 |
|------|-----|------|
| `base_complete` | 20 | 常に |
| `accuracy_bonus` | 0〜20 | 正解率に応じて |
| `executed_bonus` | 25 | executed成功時のみ |

### Done条件
- [ ] レッスン中の正解時に「XP加算UI」が出ない
- [ ] 完了画面で1回だけXPが増える
- [ ] executedがある時だけ追加ボーナスが内訳に出る

---

## 2. ユニット進行（Start導線固定）

### 仕様
- **"Today（Start）"を主導線に固定**
- 毎日返すもの: `New1 + Review1 + Action1(executed)`
- ユニット（Trail）は探索用として残す

### オンボーディング週（Week1）
- 固定脚本（Day1〜3）
- Day1でexecuted成功体験が必ず出る

### Done条件
- [ ] Startを押すと迷わず次のレッスンが始まる
- [ ] Day1でexecuted成功体験が必ず出る

---

## 3. レッスン量産テンプレ

### 1ユニット = 7ノード
1. 導入（概念説明）
2. 例（具体例）
3. 手順（やり方）
4. 罠（よくある失敗）
5. 実行（executed）
6. 振り返り
7. 復習

### 初期目標
- まず **3ユニット分** をこのテンプレで作る

---

## 運用

| 週 | アクション |
|----|-----------|
| 今週 | ベースライン計測（マージしない） |
| 来週 | 本仕様を S1とは別PRで提出 |

### PR提出時の必須成果物
- [ ] PRリンク
- [ ] 変更ファイル一覧
- [ ] 完了画面のスクショ
- [ ] Start導線の動作動画 or スクショ
- [ ] Done条件チェックリスト（全項目✅）

---

## 4. 実装詳細仕様（穴埋め）

### 4.1 XPの真実の源泉（重要）

- XPの付与は **`applyLessonXpOnce()`（新設）からのみ** 行う
- それ以外の場所で `addXp` / `addXP` を直接呼ばない
- "正解XP"は内部カウントのみ（UIには出さない、即時付与しない）

```
禁止パターン:
❌ 問題正解時に addXp(10)
❌ intervention実行時に addXp(25)

正しいパターン:
✅ 完了画面で applyLessonXpOnce({ base, accuracy, executed })
```

### 4.2 attempted / executed のXP加算タイミング

| イベント | XP付与タイミング | 値 |
|----------|-----------------|-----|
| attempted（試行） | 完了時合算 | 0〜5 |
| executed（実行成功） | 完了時合算 | 25 |

**例外**: executedがレッスン完了後に起きる場合
→ **次回レッスン完了時にまとめて付与**（executed時に別途付与しない）

> ⚠️ **UX対策**: executedした時点で「次回レッスン完了で+25付与予定」の **Pending表示** を出す。Pendingは永続化し、アプリ落ちても消えない。

### 4.3 レッスン定義

| 項目 | 値 |
|------|-----|
| 1レッスンの問題数 | 4〜6問 |
| 途中離脱 | XPなし（部分XPなし） |
| 失敗/タイムアウト | XP0、Energy消費なし |

> ⚠️ **オンボ週（最初3日）救済**: 失敗時のペナルティを軽くする
> - 失敗でもXPは0だが、**Study streakは維持**
> - または「練習扱い」としてEnergy消費なし

### 4.4 Start（Today）選定ロジック

| 枠 | 選定ルール |
|----|-----------|
| **New** | 未学習ユニットの先頭から |
| **Review** | 直近3日以内のユニットからランダム1つ |
| **Action** | 当日の最短介入（成功率が高いもの優先） |

---

## 5. 強化Done条件（事故防止）

### 基本チェック
- [ ] レッスン中の正解時に「XP加算UI」が出ない
- [ ] 完了画面で1回だけXPが増える
- [ ] executedがある時だけ追加ボーナスが内訳に出る
- [ ] Startを押すと迷わず次のレッスンが始まる
- [ ] Day1でexecuted成功体験が必ず出る

### 追加チェック（超重要）
- [ ] XPが二重に入らない（完了時以外に増えてない）
- [ ] リーグのweekly_xpが完了時XPに連動して増える（接続が切れてない）
- [ ] 途中でアプリを落としてもXP/ストリークが欠損しない（await・永続化確認）

---

## 6. 実装必須の安全策（事故防止）

### 6.1 二重XP防止（idempotencyキー必須）

`applyLessonXpOnce()` だけでは、二重タップ・クラッシュ復帰で同じ完了が2回走る可能性がある。

**必須実装**:
- `lessonCompletionId` = `userId + lessonId + dateKey + attemptNo` で一意ID生成
- 「このIDは加算済み」を永続化（AsyncStorage or DB）
- 同じIDなら **何度呼ばれても加算しない**

### 6.2 Pending失敗時の挙動

| ケース | 挙動 |
|--------|------|
| 合算付与成功 | pendingクリア |
| 付与失敗 | **pending維持（消さない）** |
| 表示 | 「次回完了で+25予定」を必ず出す（不信防止） |

### 6.3 次回完了が来ない場合の救済

ユーザーがexecutedしたのに次のレッスンをやらないと永遠に+25されない問題を防ぐ。

**採用する救済策**（どちらか）:
- **案A**: 24時間以内に次回完了が無ければ **起動時に精算**
- **案B**: executed時点で即時付与（ただしUI演出は完了画面にまとめる）

> 💡 推奨は **案A**（Duolingo的な「完了画面でまとめて見せる」体験を維持）
