#!/usr/bin/env bash
set -euo pipefail

# Skip auto-push when explicitly disabled.
if [[ "${PSYCLE_SKIP_AUTO_PUSH:-0}" == "1" ]]; then
  exit 0
fi

branch="$(git branch --show-current 2>/dev/null || true)"
if [[ "$branch" != "main" ]]; then
  exit 0
fi

# Only push when local main is actually ahead.
ahead="$(git rev-list --count origin/main..main 2>/dev/null || echo 0)"
if [[ "$ahead" == "0" ]]; then
  exit 0
fi

echo "[post-commit] main is ahead by $ahead commit(s). Auto-pushing to origin/main..."
if git push origin main; then
  echo "[post-commit] auto-push succeeded."
else
  echo "[post-commit] auto-push failed. Run: git push origin main" >&2
fi
