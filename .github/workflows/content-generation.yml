name: Autonomous Content Generation

on:
  schedule:
    # Run daily at 2 AM JST (5 PM UTC previous day)
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      genre:
        description: 'Genre to generate (or "all" for all remaining genres)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - Health
          - Social
          - Study
          - Money
          - Work
          - Mental

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
          cache-dependency-path: psycle-expo/package-lock.json
      - name: Install dependencies
        run: |
          cd psycle-expo
          npm ci
      
      - name: Setup environment
        run: |
          cd psycle-expo
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
      
      - name: Determine genres to generate
        id: genres
        run: |
          if [ "${{ github.event.inputs.genre }}" = "all" ] || [ -z "${{ github.event.inputs.genre }}" ]; then
            # Generate one genre per day in rotation
            DAY_OF_YEAR=$(date +%j)
            GENRES=("Health" "Social" "Study" "Money" "Work" "Mental")
            INDEX=$((DAY_OF_YEAR % ${#GENRES[@]}))
            GENRE=${GENRES[$INDEX]}
            echo "genre=$GENRE" >> $GITHUB_OUTPUT
            echo "Generating content for: $GENRE (daily rotation)"
          else
            echo "genre=${{ github.event.inputs.genre }}" >> $GITHUB_OUTPUT
            echo "Generating content for: ${{ github.event.inputs.genre }} (manual trigger)"
          fi
      
      - name: Run autonomous pipeline
        id: pipeline
        run: |
          cd psycle-expo
          GENRE="${{ steps.genres.outputs.genre }}"
          echo "Running pipeline for $GENRE..."
          
          # Run the autonomous pipeline
          node scripts/autonomous_pipeline.js $GENRE
          
          # Check if pipeline succeeded
          if [ $? -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Pipeline completed successfully for $GENRE"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Pipeline failed for $GENRE"
            exit 1
          fi
      
      - name: Commit and create PR
        if: steps.pipeline.outputs.status == 'success'
        run: |
          GENRE="${{ steps.genres.outputs.genre }}"
          GENRE_LOWER=$(echo "$GENRE" | tr '[:upper:]' '[:lower:]')
          BRANCH_NAME="auto-content/$GENRE_LOWER-$(date +%Y%m%d)"
          
          git config user.name "Content Generation Bot"
          git config user.email "bot@psycle-app.com"
          
          git checkout -b $BRANCH_NAME
          
          # Add generated files
          git add psycle-expo/data/curriculum_${GENRE}.json
          git add psycle-expo/data/lessons/${GENRE_LOWER}_generated_full.json
          git add psycle-expo/data/lessons/${GENRE_LOWER}.json
          git add psycle-expo/data/lessons/${GENRE_LOWER}_backup.json
          git add psycle-expo/data/pipeline_report_${GENRE_LOWER}.json
          
          # Commit
          git commit -m "ü§ñ Auto-generated content for $GENRE genre
          
          - Generated 100-unit curriculum
          - Generated 1,000 questions
          - Quality check passed
          - Content merged automatically
          
          See pipeline_report_${GENRE_LOWER}.json for details."
          
          git push origin $BRANCH_NAME
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "ü§ñ Auto-generated content: $GENRE ($(date +%Y-%m-%d))" \
            --body "## Autonomous Content Generation Report
          
          **Genre**: $GENRE
          **Date**: $(date +%Y-%m-%d)
          **Status**: ‚úÖ Success
          
          ### Generated Content
          - üìö Curriculum: 100 units
          - ‚ùì Questions: 1,000 questions
          - üìä Quality Report: \`data/pipeline_report_${GENRE_LOWER}.json\`
          
          ### Quality Metrics
          See the attached pipeline report for detailed quality metrics.
          
          ### Files Changed
          - \`data/curriculum_${GENRE}.json\` (new)
          - \`data/lessons/${GENRE_LOWER}.json\` (updated)
          - \`data/lessons/${GENRE_LOWER}_backup.json\` (backup)
          
          ---
          *This PR was automatically generated by the Autonomous Content Pipeline.*
          *Review the quality report before merging.*" \
            --base main \
            --head $BRANCH_NAME
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ steps.genres.outputs.genre }}-${{ github.run_number }}
          path: psycle-expo/data/pipeline_report_*.json
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Content generation failed for ${{ steps.genres.outputs.genre }}"
          echo "Check the logs and quality report for details"
