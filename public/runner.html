<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Psycle MCQ Runner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 検索避け -->
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --pri:#10b981; --fg:#111827; --mut:#6b7280; --bg:#f8fafc; --br:#e5e7eb; }
    * { box-sizing:border-box; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg);}
    header{position:sticky;top:0;background:#fffcc;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--br)}
    .container{max-width:1080px;margin:0 auto;padding:16px;}
    .grid{display:grid;gap:16px;grid-template-columns:1fr;}
    @media(min-width:960px){ .grid{grid-template-columns:280px 1fr;} }
    .card{background:#fff;border:1px solid var(--br);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .p16{padding:16px}
    .h2{margin:0 0 8px;font:600 14px/1.4 system-ui;color:#374151}
    .btn{border:1px solid var(--br);background:#fff;border-radius:12px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .btn.pri{border-color:var(--pri);background:#ecfdf5;color:#065f46}
    .badge{display:inline-block;background:#f3f4f6;border-radius:8px;padding:2px 6px;font-size:12px;margin-right:8px}
    .mut{color:var(--mut);font-size:12px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--pri);width:0%;transition:width .2s}
    .choice{display:block;text-align:left;border:1px solid var(--br);background:#fff;border-radius:14px;padding:12px}
    .choice:hover{background:#fafafa;border-color:#d1d5db}
    .ok{background:#ecfdf5;border-color:#6ee7b7}
    .ng{background:#fff1f2;border-color:#fecdd3}
    ol{padding-left:20px}
    footer{color:#9ca3af;text-align:center;font-size:12px;padding:24px}
  </style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:32px;height:32px;border-radius:10px;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">Ψ</div>
      <div style="font-weight:600">Psycle MCQ Runner</div>
    </div>
    <div class="mut" id="baseView"></div>
  </div>
</header>

<main class="container grid">
  <aside class="card p16">
    <div class="h2">1. トラック</div>
    <div id="tracks" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    <div class="h2" style="margin-top:16px">2. 週（パック）</div>
    <div id="packs" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    <div class="h2" style="margin-top:16px">3. セッション</div>
    <div class="mut" id="stats">問題数: - / 正解数: -</div>
    <div class="progress" style="margin:8px 0"><div class="bar" id="bar"></div></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn pri" id="startBtn" disabled>開始 / 再開</button>
      <button class="btn" id="resetBtn">リセット</button>
    </div>
  </aside>

  <section class="card p16" id="stage">
    <div class="mut">左でトラックと週を選択してください。</div>
  </section>
</main>

<footer>Powered by GitHub Pages</footer>

<script>
(function(){
  const ts = () => Date.now();
  const BASE = location.href.replace(/\\/public\\/.*$/, "");
  document.getElementById("baseView").textContent = BASE;

  // ----- state -----
  let track = null, packId = null, pack = null;
  let index = 0, answers = [], startedAt = 0, finished = false;

  const $tracks = document.getElementById("tracks");
  const $packs  = document.getElementById("packs");
  const $stage  = document.getElementById("stage");
  const $bar    = document.getElementById("bar");
  const $stats  = document.getElementById("stats");
  const $start  = document.getElementById("startBtn");
  const $reset  = document.getElementById("resetBtn");

  const saveKey = () => track && packId ? `psycle:${BASE}:${track}:${packId}` : "psycle:anon";
  const save = () => {
    const s = { index, answers, startedAt, finished };
    try { localStorage.setItem(saveKey(), JSON.stringify(s)); } catch {}
    renderStats();
  };
  const load = () => {
    try {
      const s = JSON.parse(localStorage.getItem(saveKey())||"null");
      if (s) { index=s.index||0; answers=s.answers||[]; startedAt=s.startedAt||0; finished=!!s.finished; }
    } catch {}
  };

  function button(label, active){ const b = document.createElement("button");
    b.className = "btn" + (active? " pri": ""); b.textContent = label; return b; }

  // ----- fetch helpers -----
  async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(r.status); return r.json(); }

  async function loadTracks(){
    let ids = ["mental","money","work"];
    try {
      const cat = await jget(`${BASE}/catalog.json?ts=${ts()}`);
      if (cat && Array.isArray(cat.tracks) && cat.tracks.length) {
        ids = cat.tracks.map(t=>t.id).filter(Boolean);
      }
    } catch {}
    // render track buttons
    $tracks.innerHTML = "";
    ids.forEach(id=>{
      const b = button(id, id===track);
      b.onclick = ()=>{ track=id; packId=null; pack=null; renderPacks(); };
      $tracks.appendChild(b);
    });
  }

  async function renderPacks(){
    $packs.innerHTML = "";
    $stage.innerHTML = '<div class="mut">週（パック）を選択してください。</div>';
    $start.disabled = true;
    if(!track) return;

    let pids = [];
    try { const mf = await jget(`${BASE}/${track}/manifest.json?ts=${ts()}`); pids = mf.packIds||[]; } catch {}
    pids.forEach(pid=>{
      const b = button(pid.replace(/^.*_w/,"w"), pid===packId);
      b.onclick = async ()=>{
        packId = pid;
        load();
        pack = null; renderPack();
        try {
          pack = await jget(`${BASE}/${track}/${packId}.json?ts=${ts()}`);
        } catch (e){ pack = null; }
        index = (pack && startedAt && !finished) ? index : 0;
        answers = (pack && startedAt && !finished) ? answers : [];
        finished = false;
        renderPack();
      };
      $packs.appendChild(b);
    });
  }

  function renderStats(){
    const total = pack && pack.cards ? pack.cards.length : 0;
    const score = answers.filter(a=>a.correct).length;
    $stats.textContent = `問題数: ${total||"-"} / 正解数: ${score}`;
    const pct = total ? Math.min(100, (index/total)*100) : 0;
    $bar.style.width = pct + "%";
  }

  function start(){
    if(!pack || !pack.cards || !pack.cards.length) return;
    if(!startedAt) startedAt = Date.now();
    finished = false;
    renderQuestion();
    save();
  }

  function reset(){
    index = 0; answers = []; startedAt = 0; finished = false;
    save(); renderPack();
  }

  function renderPack(){
    $start.disabled = !(pack && pack.cards && pack.cards.length);
    if(!pack){ $stage.innerHTML = '<div class="mut">読み込み中または未選択です。</div>'; renderStats(); return; }
    if(!startedAt){ // 未開始
      $stage.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="mut">パック: <b>${packId}</b></div>
          <div>問題数: ${pack.cards.length}</div>
          <button class="btn pri" id="go">セッション開始</button>
        </div>`;
      document.getElementById("go").onclick = start;
      renderStats();
      return;
    }
    if(finished){ return renderResult(); }
    renderQuestion();
  }

  function renderQuestion(){
    const total = pack.cards.length;
    const card = pack.cards[Math.min(index, total-1)];
    $stage.innerHTML = "";
    const wrap = document.createElement("div"); wrap.className=""; $stage.appendChild(wrap);
    const head = document.createElement("div");
    head.innerHTML = \`<div class="mut">Q\${index+1} / \${total}</div>\`;
    wrap.appendChild(head);

    const q = document.createElement("h3"); q.textContent = card.q; q.style.margin="8px 0 12px"; q.style.fontSize="18px"; q.style.fontWeight="600";
    wrap.appendChild(q);

    card.choices.forEach((c,i)=>{
      const btn = document.createElement("button");
      btn.className="choice"; btn.innerHTML = \`<span class="badge">\${String.fromCharCode(65+i)}</span>\${c}\`;
      btn.onclick = ()=>{
        const correct = (i === card.answerIndex);
        answers.push({ choice:i, correct });
        index++;
        if(index >= total){ finished = true; save(); renderResult(); }
        else { save(); renderQuestion(); }
      };
      wrap.appendChild(btn);
    });
    renderStats();
  }

  function renderResult(){
    const total = pack.cards.length;
    const score = answers.filter(a=>a.correct).length;
    $stage.innerHTML = "";
    const box = document.createElement("div");
    box.className = "card p16";
    box.innerHTML = \`
      <div class="mut">セッション終了</div>
      <div style="font-size:28px;font-weight:700;color:#065f46;margin:6px 0">\${score} / \${total} (\${Math.round(score/total*100)}%)</div>
    \`;
    $stage.appendChild(box);

    const list = document.createElement("ol");
    list.style.marginTop = "12px";
    pack.cards.forEach((c,i)=>{
      const a = answers[i];
      const li = document.createElement("li");
      li.className = "p16 card " + (a && a.correct ? "ok":"ng");
      li.style.margin="8px 0";
      li.innerHTML = \`
        <div style="font-weight:600;margin-bottom:4px">Q\${i+1}. \${c.q}</div>
        <div class="mut">あなたの回答: <b>\${(a && typeof a.choice==="number")? c.choices[a.choice]:"-"}</b>
          <span style="margin-left:8px" class="badge" >\${a && a.correct? "正解":"不正解"}</span></div>
        <div class="mut">正解: \${c.choices[c.answerIndex]}</div>
        \${c.explain? \`<div class="mut" style="margin-top:6px">解説: \${c.explain}</div>\` : ""}\`;
      list.appendChild(li);
    });
    $stage.appendChild(list);
    renderStats();
  }

  // wire buttons
  $start.onclick = start;
  $reset.onclick = reset;

  // boot
  loadTracks();
})();
</script>
</body>
</html>
