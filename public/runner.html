<!doctype html>
<html lang="ja">
<head>
  <base href="../">
  <meta charset="utf-8" />
  <title>Psycle MCQ Runner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 検索避け -->
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --pri:#10b981; --fg:#111827; --mut:#6b7280; --bg:#f8fafc; --br:#e5e7eb; }
    * { box-sizing:border-box; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg);}
    header{position:sticky;top:0;background:#fffcc;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--br)}
    .container{max-width:1080px;margin:0 auto;padding:16px;}
    .grid{display:grid;gap:16px;grid-template-columns:1fr;}
    @media(min-width:960px){ .grid{grid-template-columns:280px 1fr;} }
    .card{background:#fff;border:1px solid var(--br);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .p16{padding:16px}
    .h2{margin:0 0 8px;font:600 14px/1.4 system-ui;color:#374151}
    .btn{border:1px solid var(--br);background:#fff;border-radius:12px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .btn.pri{border-color:var(--pri);background:#ecfdf5;color:#065f46}
    .badge{display:inline-block;background:#f3f4f6;border-radius:8px;padding:2px 6px;font-size:12px;margin-right:8px}
    .mut{color:var(--mut);font-size:12px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--pri);width:0%;transition:width .2s}
    .choice{display:block;text-align:left;border:1px solid var(--br);background:#fff;border-radius:14px;padding:12px}
    .choice:hover{background:#fafafa;border-color:#d1d5db}
    .ok{background:#ecfdf5;border-color:#6ee7b7}
    .ng{background:#fff1f2;border-color:#fecdd3}
    ol{padding-left:20px}
    footer{color:#9ca3af;text-align:center;font-size:12px;padding:24px}
  </style>
  <link rel="stylesheet" href="../css/psycle.css">
<style id="psycle-hotfix-clicks">.psycle-banner,.mascot,.mascot-layer,.sprout,.overlay{pointer-events:none !important}</style>

<!-- psycle-hotfix-v2: unlock clicks + un-disable controls -->
<style id="psycle-hotfix-v2">
  /* 1) クリックを奪う可能性のあるオーバーレイ系を全停止 */
  .overlay, .ui-overlay, .click-shield, .banner, .psycle-banner,
  .mascot, .mascot-layer, .sprout, [data-overlay], [data-click-shield] {
    pointer-events: none !important;
    z-index: 0 !important;
  }
  /* 2) 操作パネル側は必ず操作可能に */
  #controls, #controls *, aside, aside *, button, select, input {
    pointer-events: auto !important;
  }
  /* 3) mascot container specifically */
  #psycle-mascot, #psycle-mascot * {
    pointer-events: none !important;
  }
</style>
<script id="psycle-hotfix-v2">
  (function(){
    const enableControls = () => {
      // 3) 意図せず disabled が残っていたら解除
      document.querySelectorAll(
        "button[disabled],select[disabled],input[disabled]"
      ).forEach(el => {
        // 開始ボタン以外のdisabledを解除
        if (!el.id || el.id !== "startBtn") {
          el.removeAttribute("disabled");
        }
      });

      // 4) 全画面/高z-indexの要素が残っていたら pointer-events を止める
      const isFull = (el, s) => {
        const w = Math.max(el.offsetWidth, el.clientWidth);
        const h = Math.max(el.offsetHeight, el.clientHeight);
        return (w >= window.innerWidth * 0.9 && h >= window.innerHeight * 0.9);
      };
      document.querySelectorAll("body *").forEach(el => {
        const s = getComputedStyle(el);
        if ((s.position === "fixed" || s.position === "absolute")) {
          const zi = parseInt(s.zIndex || "0", 10) || 0;
          if (zi >= 10 && isFull(el, s) && !el.closest("aside")) {
            el.style.pointerEvents = "none";
            el.style.zIndex = "0";
          }
        }
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", enableControls);
    } else {
      enableControls();
    }
    // Re-run after mutations
    setTimeout(enableControls, 500);
    setTimeout(enableControls, 1000);
  })();
</script>
<!-- /psycle-hotfix-v2 -->
    
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:32px;height:32px;border-radius:10px;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">Ψ</div>
      <div style="font-weight:600">Psycle MCQ Runner</div>
    </div>
  <div id="psycle-mascot" class="psycle-card" style="padding:.5rem .75rem; margin:.5rem 0;">
    <img id="sprout" src="../img/sprout_idle.svg" alt="sprout"/>
    <div class="bubble">今日はどの芽を育てる?</div>
  </div>
    <div class="mut" id="baseView"></div>
  </div>
</header>

<main class="container grid">
  <aside class="card p16">
    <div class="h2">1. トラック</div>
    <div id="tracks" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    <div class="h2" style="margin-top:16px">2. 週（パック）</div>
    <div id="packs" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    <div class="h2" style="margin-top:16px">3. セッション</div>
    <div class="mut" id="stats">問題数: - / 正解数: -</div>
    <div class="progress" style="margin:8px 0"><div class="bar" id="bar"></div></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn pri" id="startBtn" disabled>開始 / 再開</button>
      <button class="psycle-btn ghost">リセット</button>
    </div>
  </aside>

  <section class="card p16" id="stage">
    <div class="mut">左でトラックと週を選択してください。</div>
  </section>
</main>

<footer>Powered by GitHub Pages</footer>

<script>
(function(){
  const ts = () => Date.now();
  const rootPath = location.pathname.replace(/\\/public\\/.*$/, "/");
  const BASE = location.origin + rootPath;
  document.getElementById("baseView").textContent = BASE;

  // ----- state -----
  let track = null, packId = null, pack = null;
  let index = 0, answers = [], startedAt = 0, finished = false;

  const $tracks = document.getElementById("tracks");
  const $packs  = document.getElementById("packs");
  const $stage  = document.getElementById("stage");
  const $bar    = document.getElementById("bar");
  const $stats  = document.getElementById("stats");
  const $start  = document.getElementById("startBtn");
  const $reset  = document.getElementById("resetBtn");

  const saveKey = () => track && packId ? `psycle:${BASE}:${track}:${packId}` : "psycle:anon";
  const save = () => {
    const s = { index, answers, startedAt, finished };
    try { localStorage.setItem(saveKey(), JSON.stringify(s)); } catch {}
    renderStats();
  };
  const load = () => {
    try {
      const s = JSON.parse(localStorage.getItem(saveKey())||"null");
      if (s) { index=s.index||0; answers=s.answers||[]; startedAt=s.startedAt||0; finished=!!s.finished; }
    } catch {}
  };

  function button(label, active){ const b = document.createElement("button");
    b.className = "btn" + (active? " pri": ""); b.textContent = label; return b; }

  // ----- fetch helpers -----
  async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(r.status); return r.json(); }

  async function loadTracks(){
    let ids = ["mental","money","work"];
    try {
      const cat = await jget(`${BASE}/catalog.json?ts=${ts()}`);
      if (cat && Array.isArray(cat.tracks) && cat.tracks.length) {
        const parsed = cat.tracks.map(t => typeof t === "string" ? t : t.id).filter(Boolean);
      if (parsed.length) ids = parsed;
      }
    } catch {}
    // render track buttons
    $tracks.innerHTML = "";
    ids.forEach(id=>{
      const b = button(id, id===track);
      b.onclick = ()=>{ track=id; packId=null; pack=null; renderPacks(); };
      $tracks.appendChild(b);
    });
  }

  async function renderPacks(){
    $packs.innerHTML = "";
    $stage.innerHTML = '<div class="mut">週（パック）を選択してください。</div>';
    $start.disabled = true;
    if(!track) return;

    let pids = [];
    try { const mf = await jget(`${BASE}/${track}/manifest.json?ts=${ts()}`); pids = mf.packIds||[]; } catch {}
    pids.forEach(pid=>{
      const b = button(pid.replace(/^.*_w/,"w"), pid===packId);
      b.onclick = async ()=>{
        packId = pid;
        load();
        pack = null; renderPack();
        try {
          pack = await jget(`${BASE}/${track}/${packId}.json?ts=${ts()}`);
        } catch (e){ pack = null; }
        index = (pack && startedAt && !finished) ? index : 0;
        answers = (pack && startedAt && !finished) ? answers : [];
        finished = false;
        renderPack();
      };
      $packs.appendChild(b);
    });
  }

  function renderStats(){
    const total = pack && pack.cards ? pack.cards.length : 0;
    const score = answers.filter(a=>a.correct).length;
    $stats.textContent = `問題数: ${total||"-"} / 正解数: ${score}`;
    const pct = total ? Math.min(100, (index/total)*100) : 0;
    $bar.style.width = pct + "%";
  }

  function start(){
    if(!pack || !pack.cards || !pack.cards.length) return;
    if(!startedAt) startedAt = Date.now();
    finished = false;
    renderQuestion();
    save();
  }

  function reset(){
    index = 0; answers = []; startedAt = 0; finished = false;
    save(); renderPack();
  }

  function renderPack(){
    $start.disabled = !(pack && pack.cards && pack.cards.length);
    if(!pack){ $stage.innerHTML = '<div class="mut">読み込み中または未選択です。</div>'; renderStats(); return; }
    if(!startedAt){ // 未開始
      $stage.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="mut">パック: <b>${packId}</b></div>
          <div>問題数: ${pack.cards.length}</div>
          <button class="btn pri" id="go">セッション開始</button>
        </div>`;
      document.getElementById("go").onclick = start;
      renderStats();
      return;
    }
    if(finished){ return renderResult(); }
    renderQuestion();
  }

  function renderQuestion(){
    const total = pack.cards.length;
    const card = pack.cards[Math.min(index, total-1)];
    $stage.innerHTML = "";
    const wrap = document.createElement("div"); wrap.className=""; $stage.appendChild(wrap);
    const head = document.createElement("div");
    head.innerHTML = \`<div class="mut">Q\${index+1} / \${total}</div>\`;
    wrap.appendChild(head);

    const q = document.createElement("h3"); q.textContent = card.q; q.style.margin="8px 0 12px"; q.style.fontSize="18px"; q.style.fontWeight="600";
    wrap.appendChild(q);

    card.choices.forEach((c,i)=>{
      const btn = document.createElement("button");
      btn.className="choice"; btn.innerHTML = \`<span class="badge">\${String.fromCharCode(65+i)}</span>\${c}\`;
      btn.onclick = ()=>{
        const correct = (i === card.answerIndex);
        answers.push({ choice:i, correct });
        index++;
        if(index >= total){ finished = true; save(); renderResult(); }
        else { save(); renderQuestion(); }
      };
      wrap.appendChild(btn);
    });
    renderStats();
  }

  function renderResult(){
    const total = pack.cards.length;
    const score = answers.filter(a=>a.correct).length;
    $stage.innerHTML = "";
    const box = document.createElement("div");
    box.className = "card p16";
    box.innerHTML = \`
      <div class="mut">セッション終了</div>
      <div style="font-size:28px;font-weight:700;color:#065f46;margin:6px 0">\${score} / \${total} (\${Math.round(score/total*100)}%)</div>
    \`;
    $stage.appendChild(box);

    const list = document.createElement("ol");
    list.style.marginTop = "12px";
    pack.cards.forEach((c,i)=>{
      const a = answers[i];
      const li = document.createElement("li");
      li.className = "p16 card " + (a && a.correct ? "ok":"ng");
      li.style.margin="8px 0";
      li.innerHTML = \`
        <div style="font-weight:600;margin-bottom:4px">Q\${i+1}. \${c.q}</div>
        <div class="mut">あなたの回答: <b>\${(a && typeof a.choice==="number")? c.choices[a.choice]:"-"}</b>
          <span style="margin-left:8px" class="badge" >\${a && a.correct? "正解":"不正解"}</span></div>
        <div class="mut">正解: \${c.choices[c.answerIndex]}</div>
        \${c.explain? \`<div class="mut" style="margin-top:6px">解説: \${c.explain}</div>\` : ""}\`;
      list.appendChild(li);
    });
    $stage.appendChild(list);
    renderStats();
  }

  // wire buttons
  $start.onclick = start;
  $reset.onclick = reset;

  // boot
  loadTracks();
})();
</script>
<script>(function(){if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(console.warn);}})();</script>
</body>
</html>
<script id="psycle-extend" data-ver="dl-deeplink-csv">
(function(){
  // 安全ガード
  const ready = (sel, timeout=8000) => new Promise((resolve,reject)=>{
    const t0 = Date.now();
    (function tick(){
      const el = document.querySelector(sel);
      if(el) return resolve(el);
      if(Date.now()-t0>timeout) return reject(new Error('timeout:'+sel));
      requestAnimationFrame(tick);
    })();
  });

  const qs = new URLSearchParams(location.search);
  const wantTrack = qs.get('track');   // mental|money|work を推奨
  const wantPack  = qs.get('pack');    // 例: work_w03
  const autostart = qs.get('autostart') === '1';

  // 部分一致ユーティリティ（value/labelの両方を対象）
  function setSelectByFuzzy(select, want){
    if(!select || !want) return false;
    const W = want.toLowerCase();
    let hit = null;
    [...select.options].forEach(o=>{
      const v = (o.value||'').toLowerCase();
      const t = (o.textContent||'').toLowerCase();
      if(!hit && (v===W || t===W || v.includes(W) || t.includes(W))) hit = o.value;
    });
    if(hit!=null){ select.value = hit; select.dispatchEvent(new Event('change')); return true; }
    return false;
  }

  // 回答ログ用
  const sess = { rows: [], startedAt: 0, endedAt: 0, track: '', pack: '', total: 0, correct: 0 };
  window.__psycleSession = sess;

  // 既存の回答ハンドラを横取り（見つかるものをラップ）
  // 候補: window.onChoice, window.handleAnswer, window.onAnswer など
  const candidates = ['onChoice','handleAnswer','onAnswer'];
  for(const k of candidates){
    if(typeof window[k] === 'function'){
      const orig = window[k];
      window[k] = function(idx, isCorrect){
        try{
          // idx や isCorrect の引数形式が違う場合は orig を先に呼び出してから
          // 画面から現在インデックス/正誤を推定するフォールバックでも可
          if(typeof idx==='number' && typeof isCorrect==='boolean'){
            sess.rows.push({ n: idx+1, selectedIndex: idx, isCorrect });
          }
        }catch(e){}
        return orig.apply(this, arguments);
      };
      break;
    }
  }

  // スタート・終了の観測（開始/再開ボタンのクリックや結果表示のDOMを監視）
  function markStart(track, pack){
    sess.startedAt = Date.now();
    sess.track = track||''; sess.pack = pack||'';
  }
  function markEnd(summary){
    sess.endedAt = Date.now();
    if(summary){ sess.total = summary.total||sess.rows.length; sess.correct = summary.correct||0; }
  }

  // CSV 生成
  function toCSV(){
    const dt = new Date(sess.endedAt||Date.now());
    const pad = n=>String(n).padStart(2,'0');
    const ts = dt.getFullYear()+''+pad(dt.getMonth()+1)+''+pad(dt.getDate())+'-'+pad(dt.getHours())+pad(dt.getMinutes())+pad(dt.getSeconds());
    const head = 'timestamp,track,pack,total,correct,elapsedMs\n';
    const ms = (sess.endedAt && sess.startedAt) ? (sess.endedAt - sess.startedAt) : 0;
    const summary = [dt.toISOString(), sess.track, sess.pack, sess.total||sess.rows.length, sess.correct||0, ms].join(',') + '\n';
    const detailHead = 'n,selectedIndex,isCorrect\n';
    const detail = sess.rows.map(r=>[r.n,r.selectedIndex,(r.isCorrect?1:0)].join(',')).join('\n');
    const csv = head + summary + (detail ? detailHead + detail + '\n' : '');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `psycle_${sess.track||'track'}_${sess.pack||'pack'}_${ts}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // UI ボタン追加（リセット隣）
  function injectCSVButton(){
    const resetBtn = Array.from(document.querySelectorAll('button')).find(b=>(b.textContent||'').includes('リセット'));
    if(!resetBtn) return;
    if(document.getElementById('btnCsv')) return;
    const btn = document.createElement('button');
    btn.id = 'btnCsv';
    btn.className = resetBtn.className;
    btn.style.marginLeft = '8px';
    btn.textContent = 'CSV出力';
    btn.addEventListener('click', toCSV);
    resetBtn.parentElement.insertBefore(btn, resetBtn.nextSibling);
  }

  // 画面要素に同期
  (async function main(){
    try{
      injectCSVButton();

      // セレクト特定（「トラック」「週」順に並んでいる前提）
      const selects = await ready('select');
      const allSel = document.querySelectorAll('select');
      const trackSel = allSel[0], packSel = allSel[1];

      // トラック/パック反映
      if(wantTrack) setSelectByFuzzy(trackSel, wantTrack);
      // pack はトラック変更で非同期に埋まる可能性があるので少し待つ
      if(wantPack){
        let tries=0;
        while(tries++<30 && (!setSelectByFuzzy(packSel, wantPack))) await new Promise(r=>setTimeout(r,100));
      }

      // 現在選択をセッションに記録
      const tk = (trackSel && trackSel.value) || wantTrack || '';
      const pk = (packSel && packSel.value) || wantPack  || '';
      markStart(tk, pk);

      // 自動開始
      if(autostart){
        const startBtn = Array.from(document.querySelectorAll('button')).find(b=>/開始|再開/.test(b.textContent||''));
        if(startBtn) startBtn.click();
      }

      // 終了監視（結果表示DOMの変化を監視して正答数などを拾えれば反映）
      const obs = new MutationObserver(()=>{
        const sumEl = Array.from(document.querySelectorAll('div,span,p')).find(el=>(el.textContent||'').match(/正解|得点|score/i));
        if(sumEl){
          // 数値をざっくり抽出（失敗してもOK）
          const m = (sumEl.textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
          if(m){ sess.correct = +m[1]; sess.total = +m[2]; }
          markEnd({total:sess.total, correct:sess.correct});
          injectCSVButton();
        }
      });
      obs.observe(document.body, {childList:true, subtree:true});
    }catch(e){ console.warn('[psycle-extend]', e); }
  })();
})();
</script>

<script>
(function(){
  const $sprout = document.getElementById("sprout");
  const $bubble = document.querySelector("#psycle-mascot .bubble");
  const src = (name)=> "../img/sprout_"+name+".svg";
  const say = (t)=> $bubble && ($bubble.textContent = t);

  window.psycleMascot = {
    set(id){ if(!$sprout) return; $sprout.src = src(id); },
    idle(){ this.set("idle"); say("今日はどの芽を育てる?"); },
    cheer(){ this.set("cheer"); say("よし、育てていこう!"); flash(); },
    happy(){ this.set("happy"); say("いい伸び!"); },
    sad(){ this.set("sad"); say("水やりして、もう一度。"); },
  };

  function flash(){
    const m = document.getElementById("psycle-mascot");
    if(!m) return; m.classList.add("cheer"); setTimeout(()=>m.classList.remove("cheer"), 300);
  }

  // 既存ボタンにフック（無ければスキップ）
  const startBtn = Array.from(document.querySelectorAll("button")).find(b=>/開始|再開/i.test(b.textContent||""));
  const resetBtn = Array.from(document.querySelectorAll("button")).find(b=>/リセット/i.test(b.textContent||""));
  if(startBtn){ startBtn.addEventListener("click", ()=> window.psycleMascot.cheer()); }
  if(resetBtn){ resetBtn.addEventListener("click", ()=> window.psycleMascot.idle()); }

  // 進捗バー（存在すれば動かす）
  const prog = document.querySelector(".progress > i");
  if(!prog){
    const bar = document.createElement("div"); bar.className="progress";
    const fill = document.createElement("i"); bar.appendChild(fill);
    const host = document.querySelector("[role=progressbar]") || document.querySelector("#psycle-mascot");
    host && host.after(bar);
  }

  // 正誤に反応したい場合、アプリ側から以下を呼べる:
  // window.psycleMascot.happy(); // 正解
  // window.psycleMascot.sad();   // 不正解
})();
</script>
