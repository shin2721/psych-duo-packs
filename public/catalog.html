<!doctype html><meta charset="utf-8">
<title>Psycle Catalog Demo</title>
<style>
  body{font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;padding:24px}
  button{padding:8px 12px;border:1px solid #ccc;border-radius:8px;cursor:pointer}
  pre{background:#111;color:#0f0;padding:12px;border-radius:8px;overflow:auto}
  .row{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;min-width:260px}
</style>
<h1>üóÇÔ∏è Tracks (Catalog ‚Üí Manifest ‚Üí Packs)</h1>
<div class="row">
  <button id="btnCatalog">Load Tracks</button>
  <button id="btnClear">Clear</button>
</div>
<div id="out"></div>
<script>
const out = document.getElementById('out');
const ts = () => Date.now();
const p = (h, el='div', cls='card') => { const d=document.createElement(el); d.className=cls; d.innerHTML=h; out.appendChild(d); return d; };
const j = (obj) => `<pre>${JSON.stringify(obj,null,2)}</pre>`;
const info = (t) => p(`<b>${t}</b>`);
document.getElementById('btnClear').onclick = ()=>{ out.innerHTML=''; };

document.getElementById('btnCatalog').onclick = async () => {
  out.innerHTML = '';
  const base = location.pathname.includes('/public/') ? '..' : '.';
  const catalogUrl = `${base}/catalog.json?ts=${ts()}`;
  info(`Catalog: <code>${catalogUrl}</code>`);
  let catalog;
  try {
    const r = await fetch(catalogUrl, {headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(r.status);
    catalog = await r.json();
    p(j(catalog));
  } catch(e) { p(`‚ùå load catalog failed: ${e}`, 'div', 'card'); return; }

  const row = p('', 'div', 'row');
  (catalog.tracks||[]).forEach(t=>{
    const b=document.createElement('button');
    b.textContent = `${t.title || t.id}`;
    b.onclick = ()=>loadTrack(t.id);
    row.appendChild(b);
  });

  async function loadTrack(trackId){
    p(`<b>Track: ${trackId}</b>`);
    const manifestUrl = `${base}/${trackId}/manifest.json?ts=${ts()}`;
    info(`Manifest: <code>${manifestUrl}</code>`);
    const r = await fetch(manifestUrl, {headers:{'Accept':'application/json'}});
    if(!r.ok){ p(`‚ùå manifest ${r.status}`, 'div', 'card'); return; }
    const manifest = await r.json();
    p(j({track: manifest.track, totalPacks: manifest.totalPacks, packIds: manifest.packIds}));

    for(const id of manifest.packIds||[]){
      const packUrl = `${base}/${trackId}/${id}.json?ts=${ts()}`;
      const pr = await fetch(packUrl, {headers:{'Accept':'application/json'}});
      if(!pr.ok){ p(`‚ùå ${id}: ${pr.status}`, 'div', 'card'); continue; }
      const pack = await pr.json();
      const cardsLen = Array.isArray(pack.cards)? pack.cards.length : 0;
      const theme = pack.meta?.theme || '(no theme)';
      p(j({id: pack.id, theme, cards_len: cardsLen}));
    }
  }
};
</script>
